# New User Signup Email Notifications - Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** 2026-02-07
> **PRD:** `email-notifications/prd.md`

---

## 1. PRD Understanding

### Feature Summary
Send an internal email notification to a hardcoded list of recipients (`dpaola2@gmail.com`, `dpaola2-ceo@agentmail.to`) whenever a new user signs up for Show Notes via the login flow. The notification includes the user's email and signup timestamp. It fires only for newly created users, not returning users. Email delivery is asynchronous (`deliver_later`) and failures must not block the user's login flow.

### Entities Identified
| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| User | EML-001, EML-004 | Yes | `app/models/user.rb` |
| SessionsController | EML-001, EML-007 | Yes | `app/controllers/sessions_controller.rb` |
| ApplicationMailer | EML-005 | Yes | `app/mailers/application_mailer.rb` |
| UserMailer | Platform Requirements | Yes | `app/mailers/user_mailer.rb` |
| DigestMailer | Platform Requirements | Yes | `app/mailers/digest_mailer.rb` |
| SignupNotificationMailer (new) | EML-001 through EML-004 | No | N/A — to be created |
| Solid Queue (ActiveJob adapter) | EML-005 | Yes | `config/environments/production.rb:57` |
| Resend (email delivery) | Platform Requirements | Yes | `config/initializers/resend.rb`, `Gemfile:55` |

### Platforms Affected
- [x] Rails (Web)
- [ ] Rails (API)
- [ ] iOS
- [ ] Android

N/A — Level 1 (web-only) project.

---

## 2. Current State: Primary Platform

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| User | `app/models/user.rb` | `has_many :subscriptions`, `has_many :podcasts, through: :subscriptions`, `has_many :user_episodes` | Simple model. Validates email presence, uniqueness, and format (`URI::MailTo::EMAIL_REGEXP`). No `name` field — email is the only identifying info. |

### Current Schema (Related Tables)

```sql
-- users
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  created_at DATETIME NOT NULL,
  digest_enabled BOOLEAN DEFAULT TRUE NOT NULL,
  digest_sent_at DATETIME,
  email VARCHAR,
  magic_token VARCHAR,
  magic_token_expires_at DATETIME,
  updated_at DATETIME NOT NULL
);
-- Index: index_users_on_email (unique)
```

Key observation: The `users` table has no `name` field. The email address and `created_at` timestamp are the only signup-relevant fields.

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| SessionsController | `app/controllers/sessions_controller.rb` | `new`, `create`, `sent`, `verify`, `destroy` | Skips `require_authentication` for `new`, `create`, `sent`, `verify` |
| ApplicationController | `app/controllers/application_controller.rb` | Base controller | `before_action :require_authentication`, provides `current_user` and `logged_in?` helper |

#### SessionsController#create — The Signup Trigger Point (lines 9-27)

```ruby
def create
  @email = params[:email]&.downcase&.strip

  if @email.blank?
    flash.now[:alert] = "Please enter your email address"
    render :new, status: :unprocessable_entity
    return
  end

  user = User.find_or_create_by!(email: @email)
  token = user.generate_magic_token!

  UserMailer.magic_link(user, token).deliver_later

  redirect_to magic_link_sent_path, notice: "Check your email for a login link"
rescue ActiveRecord::RecordInvalid => e
  flash.now[:alert] = "Invalid email address"
  render :new, status: :unprocessable_entity
end
```

**Critical finding:** `find_or_create_by!` returns the user record but does not directly indicate whether it was newly created or already existed. To distinguish new signups from returning users (EML-007), the implementation needs a detection strategy. Options include:
1. Comparing `user.created_at` to a recent threshold (e.g., `1.second.ago`) — simple but slightly imprecise
2. Using `User.find_by(email:)` first, then `User.create!` only if nil — explicit control but changes the existing pattern
3. Checking `user.previously_new_record?` — Rails 6.1+ method that returns `true` if the record was just inserted (the cleanest approach)

### Related Mailers

| Mailer | File | Methods | Pattern |
|--------|------|---------|---------|
| ApplicationMailer | `app/mailers/application_mailer.rb` | Base class | `default from: "noreply@listen.davepaola.com"`, `layout "mailer"` |
| UserMailer | `app/mailers/user_mailer.rb` | `magic_link(user, token)` | Sets instance vars, calls `mail(to:, subject:)` |
| DigestMailer | `app/mailers/digest_mailer.rb` | `daily_digest(user)` | Queries data, calls `mail(to:, subject:)`. Includes `ApplicationHelper` for `format_duration`. |

#### UserMailer Pattern (simplest example):

```ruby
class UserMailer < ApplicationMailer
  def magic_link(user, token)
    @user = user
    @token = token
    @magic_link_url = verify_magic_link_url(token: token)
    mail(to: user.email, subject: "Sign in to Show Notes")
  end
end
```

Both mailers have HTML + text multipart templates:
- `app/views/user_mailer/magic_link.html.erb` — inline CSS, responsive, branded
- `app/views/user_mailer/magic_link.text.erb` — plain text fallback
- `app/views/digest_mailer/daily_digest.html.erb` — richer layout with sections
- `app/views/digest_mailer/daily_digest.text.erb` — plain text fallback

Layout: `app/views/layouts/mailer.html.erb` — minimal wrapper (`<html><body><%= yield %></body></html>`).

### Email Infrastructure

| Component | Config Location | Value |
|-----------|----------------|-------|
| Production delivery | `config/environments/production.rb:66` | `config.action_mailer.delivery_method = :resend` |
| Development delivery | `config/environments/development.rb:44` | `config.action_mailer.delivery_method = :letter_opener` |
| Test delivery | `config/environments/test.rb:37` | `config.action_mailer.delivery_method = :test` |
| Resend API key | `config/initializers/resend.rb` | `Resend.api_key = ENV["RESEND_API_KEY"]` |
| Default sender | `app/mailers/application_mailer.rb:2` | `noreply@listen.davepaola.com` |
| Production host | `config/environments/production.rb:63` | `ENV.fetch("APP_HOST", "listen.davepaola.com")` |
| Job queue adapter | `config/environments/production.rb:57` | `config.active_job.queue_adapter = :solid_queue` |

### Related Background Jobs

| Job | File | Purpose |
|-----|------|---------|
| SendDailyDigestJob | `app/jobs/send_daily_digest_job.rb` | Iterates users with `digest_enabled`, sends `DigestMailer.daily_digest(user).deliver_later` |
| ApplicationJob | `app/jobs/application_job.rb` | Base class (`queue_as :default`) |

No dedicated job is needed for the signup notification — `deliver_later` on the mailer will enqueue via Solid Queue automatically (same pattern as `UserMailer.magic_link(...).deliver_later` on line 21 of `sessions_controller.rb`).

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/models/user_spec.rb` | Validations (email presence, uniqueness, format), associations, magic token methods | Model spec |
| `spec/requests/sessions_spec.rb` | Login form rendering, user creation, magic link sending, token verification, logout, auth requirement | Request spec |
| `spec/mailers/digest_mailer_spec.rb` | Subject, recipient, body content for various states (inbox, library, empty, overflow) | Mailer spec |
| `spec/jobs/send_daily_digest_job_spec.rb` | Digest sent to eligible users, skipped for ineligible | Job spec |

**Notable:** There is no `spec/mailers/user_mailer_spec.rb`. The UserMailer is tested indirectly via `spec/requests/sessions_spec.rb:37` (`have_enqueued_mail(UserMailer, :magic_link)`).

### Test Support

| File | Purpose |
|------|---------|
| `spec/support/authentication_helpers.rb` | `sign_in(user)` (full flow) and `sign_in_as(user)` (stubbed) helpers for request specs |
| `spec/factories/users.rb` | `:user` factory with `Faker::Internet.unique.email`, traits `:with_magic_token` and `:with_expired_token` |

---

## 3. Current State: iOS

N/A — Level 1 (web-only) project.

---

## 4. Current State: Android

N/A — Level 1 (web-only) project.

---

## 5. Cross-Platform Patterns

### Data Flow
This is a server-side-only feature. No API endpoints, no client changes. The flow is:

```
User submits email on /login
  → SessionsController#create
    → User.find_or_create_by!(email:)
    → [NEW] If user was just created, enqueue signup notification email
    → UserMailer.magic_link(user, token).deliver_later (existing)
  → Solid Queue processes both email jobs asynchronously
  → Resend delivers to recipients
```

### Serialization Format
N/A — no API changes.

### API Versioning
N/A — no API changes.

### How Similar Features Are Built
The closest existing pattern is `UserMailer.magic_link` — a simple, single-purpose mailer triggered from a controller action:

1. **Controller** calls `SomeMailer.some_method(args).deliver_later`
2. **Mailer class** inherits `ApplicationMailer`, defines one method, sets instance vars, calls `mail(to:, subject:)`
3. **Views** provide HTML + text templates under `app/views/<mailer_name>/`
4. **No dedicated job** — `deliver_later` handles async via Solid Queue

The signup notification follows this exact pattern, with one difference: the `to:` address is a hardcoded constant list, not the user's email.

---

## 6. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| New-vs-existing user detection | Med | `find_or_create_by!` doesn't directly indicate whether the record was created or found. Incorrect detection would send notifications for every login, not just signups. | Use `user.previously_new_record?` (Rails 6.1+, available in Rails 8.1) — returns `true` only if the record was just inserted in this `find_or_create_by!` call. |
| Notification failure blocking login | Low | If the mailer raises before `deliver_later` enqueues (e.g., bad constant, template error), it could halt the controller action. | Use `rescue` around the notification call, or place it after the redirect (though `deliver_later` failures are async and won't block). The actual delivery errors are handled by Solid Queue. |
| No existing mailer spec pattern for UserMailer | Low | `UserMailer` has no dedicated spec — only tested indirectly via request spec. New mailer will need its own spec. | Follow `DigestMailer` spec as the template pattern. |

### Performance Concerns
- None. Signup volume is very low. Each signup enqueues one small email. No N+1, no batch concerns.

### Security Concerns
- Recipient list is hardcoded — no risk of user-controlled injection.
- No sensitive data exposure beyond the signing-up user's email address (which the internal team would see anyway in the database).

---

## 7. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | Should the new mailer be a new class (e.g., `SignupNotificationMailer`) or a new method on the existing `UserMailer`? | Design choice — both patterns exist in the codebase. `UserMailer` currently handles user-facing auth emails; a signup notification is internal/admin. | No — either works, but a separate class keeps concerns cleanest. |
| 2 | Should the notification include any additional context beyond email and timestamp (e.g., total user count, referring URL)? | PRD Section 3 (EML-004) specifies email + timestamp only. | No — PRD is clear. |
| 3 | Confirm the PRD's recommendation: controller-level trigger (not model callback). Console/seed user creation should NOT send notifications. | PRD Section 8, Open Question #4 | No — PRD recommends controller-only, and this is the simpler/safer approach. |

---

## 8. Recommendations for Architecture Stage

- **Follow the `UserMailer` pattern** — single-purpose mailer class inheriting `ApplicationMailer`, with `mail(to:, subject:)` call and HTML+text views.
- **Use `previously_new_record?`** to detect new signups in `SessionsController#create`. This is the cleanest Rails idiom for `find_or_create_by!` detection and avoids changing the existing code pattern.
- **Create a separate mailer class** (not a method on `UserMailer`) since this notification goes to internal admins, not to the signing-up user. Keeps the single-responsibility principle intact.
- **Hardcode recipients as a constant** in the mailer class, per CFG-001.
- **Keep views simple** — the UserMailer's `magic_link` template is a good style reference. The signup notification email body is minimal (just email + timestamp).
- **Add a dedicated mailer spec** following the `DigestMailer` spec pattern (test subject, recipients, body content).
- **Wrap the notification call** in the controller so that any error (template missing, constant error, etc.) is caught and logged but does not interrupt the login flow.
