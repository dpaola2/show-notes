---
pipeline_stage: 3
pipeline_stage_name: gameplan
pipeline_project: "library-scoped-processing"
pipeline_started_at: "2026-02-17T09:34:41-0500"
pipeline_completed_at: "2026-02-17T09:35:16-0500"
pipeline_approved_at: "2026-02-17"
---

# Library-Scoped Processing — Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-17
> **PRD:** `pipeline-projects/library-scoped-processing/prd.md`
> **Discovery Report:** `pipeline-projects/library-scoped-processing/discovery-report.md`
> **Approved Architecture:** `pipeline-projects/library-scoped-processing/architecture-proposal.md`

---

## 1. Project Overview

### Goals
- Digest emails contain only library episodes that became ready within the eligibility window
- Transcription only runs when a user moves an episode to the library (not on feed fetch)
- Reduce unnecessary API spend on episodes the user never reads
- Clean removal of dead code (`AutoProcessEpisodeJob`, Episode-level stuck detection)

### Scope Summary

| Description | Platform |
|-------------|----------|
| Replace digest query with library-scoped `Episode.library_ready_since` scope | Web |
| Remove auto-transcription from feed fetch flow | Web |
| Delete `AutoProcessEpisodeJob` and related specs | Web |
| Remove Episode stuck detection from `DetectStuckProcessingJob` | Web |

### Out of Scope
- Removing `processing_status` columns from the `episodes` table
- Changing inbox UI or behavior
- Changing the digest delivery schedule or frequency
- Adding new digest preferences or settings
- Retroactively un-transcribing episodes that were auto-processed
- Changing inbox processing status indicators

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (repo root)
- No migrations, no new routes, no new controllers
- Follow existing Rails patterns from `CLAUDE.md` and `AGENTS.md`

---

## 2. Open Questions & Decisions

> All resolved during Stages 1-2 (Discovery + Architecture).

| Question | Status | Decision |
|----------|--------|----------|
| Extract shared query helper vs keep inline? | Resolved | Extract to `Episode.library_ready_since(user, since)` — eliminates drift risk |
| Digest "since" window? | Resolved | `[digest_sent_at, 24.hours.ago].compact.max` — 24-hour cap prevents stale backlogs |
| `updated_at` as readiness proxy? | Resolved | Acceptable for single-user app — set when `ProcessEpisodeJob` marks `processing_status: :ready` |
| DetectStuckProcessingJob Episode block? | Resolved | Remove — Episode-level processing is being deleted |
| AutoProcessEpisodeJob disposal? | Resolved | Delete entirely (job + both spec files) |
| Explicit podcast join in query? | Resolved | Yes — `.joins(:user_episodes, :podcast)` ensures robust ORDER BY |

---

## 3. Functional Milestones

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented (Stage 1)
- [x] Architecture proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Shared Scope & Digest Query Change
**What:** Add the `Episode.library_ready_since` scope and update the digest system (DigestMailer + SendDailyDigestJob) to use it instead of the subscription-scoped query. This is the core behavioral change for the digest email.
**Size:** S

**Acceptance Criteria:**
- [ ] DIG-001: Digest email queries `user_episodes` in library location (not all subscription episodes). An episode in the inbox or archive does not appear in the digest.
- [ ] DIG-002: Digest only includes library episodes with `processing_status=ready` whose `updated_at` is after `[digest_sent_at, 24.hours.ago].compact.max`. If `digest_sent_at` is nil, the 24-hour cap applies. If `digest_sent_at` is 3 days old, the 24-hour cap applies (not a 3-day backlog).
- [ ] DIG-003: Digest subject line and email body copy reflect library-centric framing (e.g., "Your library — N episode(s) ready" instead of "Your podcasts this morning"). Both HTML and text templates updated if they contain subscription-centric wording.
- [ ] DIG-004: If no library episodes match the eligibility window, `NullMail` is returned and no email is sent.
- [ ] `Episode.library_ready_since(user, since)` scope exists on `Episode` model, joins `user_episodes` and `podcast`, filters by `location: :library`, `processing_status: :ready`, and `updated_at > since`.
- [ ] `SendDailyDigestJob#has_new_episodes?` uses `Episode.library_ready_since(user, since).exists?` with the same 24-hour cap.
- [ ] The `since` race protection pattern is preserved: `since` parameter flows through `deliver_later` serialization to protect against `digest_sent_at` being bumped between scheduling and delivery.
- [ ] Both DigestMailer query sites (class method + instance fallback) use the shared scope identically.

**Web (Rails):**
- [ ] Add `library_ready_since` scope to `app/models/episode.rb`
- [ ] Update `app/mailers/digest_mailer.rb` — replace subscription query in class method (lines 20-26) with `Episode.library_ready_since(user, since).group_by(&:podcast)`
- [ ] Update `app/mailers/digest_mailer.rb` — replace subscription query in instance fallback (lines 80-86) with same
- [ ] Update `app/mailers/digest_mailer.rb` — change `since` calculation to `[user.digest_sent_at, 24.hours.ago].compact.max` in both methods
- [ ] Update `app/mailers/digest_mailer.rb` — change subject line (line 105) to library-centric framing
- [ ] Update digest email templates (HTML + text) — replace any subscription-centric copy with library-centric wording
- [ ] Update `app/jobs/send_daily_digest_job.rb` — replace `has_new_episodes?` query (lines 37-44) with `Episode.library_ready_since(user, since).exists?`
- [ ] Update `spec/mailers/digest_mailer_spec.rb` — verify library-only filtering, 24-hour cap, subject line change
- [ ] Update `spec/jobs/send_daily_digest_job_spec.rb` — verify library-only eligibility check, 24-hour cap

**Dependencies:** None (first milestone)

---

### M2: Remove Auto-Processing from Feed Fetch
**What:** Remove the `AutoProcessEpisodeJob.perform_later` call from `FetchPodcastFeedJob`, delete `AutoProcessEpisodeJob` and its specs, and remove the Episode stuck detection block from `DetectStuckProcessingJob`.
**Size:** S

**Acceptance Criteria:**
- [ ] TRX-001: `FetchPodcastFeedJob` does NOT enqueue `AutoProcessEpisodeJob` when discovering new episodes. New episodes land in inbox with `processing_status: :pending` and no transcription job is enqueued.
- [ ] TRX-002: `FetchPodcastFeedJob` still creates `Episode` records and `UserEpisode` inbox entries for subscribers (existing behavior preserved).
- [ ] TRX-003: `ProcessEpisodeJob` (triggered by `move_to_library!`) continues to work as-is — no changes to this pathway.
- [ ] TRX-004: `DetectStuckProcessingJob` detects stuck `UserEpisode` records only (Episode-level detection removed). Marks stuck records as error for manual retry.
- [ ] CLN-001: `AutoProcessEpisodeJob` class and both spec files are deleted.
- [ ] CLN-002: Episode-level `processing_status`, `processing_error`, `last_error_at` columns remain in schema (no migration to remove them).

**Web (Rails):**
- [ ] Update `app/jobs/fetch_podcast_feed_job.rb` — remove lines 34-35 (`AutoProcessEpisodeJob.perform_later` call and comment)
- [ ] Delete `app/jobs/auto_process_episode_job.rb`
- [ ] Delete `spec/jobs/auto_process_episode_job_spec.rb`
- [ ] Delete `spec/jobs/auto_process_episode_job_state_tracking_spec.rb`
- [ ] Update `app/jobs/detect_stuck_processing_job.rb` — remove Episode stuck detection block (lines 19-29)
- [ ] Update `spec/jobs/fetch_podcast_feed_job_spec.rb` — remove AutoProcessEpisodeJob enqueue assertions
- [ ] Update `spec/jobs/detect_stuck_processing_job_spec.rb` — remove Episode timeout detection tests

**Dependencies:** None (independent of M1)

---

### M3: QA Test Data
**What:** Create a seed task that populates realistic test data for manual QA of the library-scoped processing behavior. Covers digest eligibility, inbox-only episodes, library processing, and edge cases.
**Size:** S

**Acceptance Criteria:**
- [ ] Seed task exists at `lib/tasks/pipeline/library_scoped_processing_qa.rake`
- [ ] Task creates a test user with `digest_enabled: true` and a known `digest_sent_at` timestamp
- [ ] Task seeds subscribed podcasts with episodes in various states: inbox-only (not processed), library + ready (should appear in digest), library + pending (should not appear in digest), library + error, archived
- [ ] Task seeds at least one episode with `updated_at` older than 24 hours (tests the 24-hour cap — should not appear in digest)
- [ ] Task seeds at least one episode with `updated_at` within the last 24 hours and `processing_status: ready` (tests positive digest case)
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary of what was created (user email, podcast names, episode counts by state)

**Web (Rails):**
- [ ] Create `lib/tasks/pipeline/` directory if it doesn't exist
- [ ] Create `lib/tasks/pipeline/library_scoped_processing_qa.rake` — idempotent seed task
- [ ] Uses existing model factories/patterns where available

**Dependencies:** M1, M2 (needs the full feature implemented)

---

### M4: Edge Cases & Polish
**What:** Verify edge case handling and ensure no regressions in existing behavior.
**Size:** S

**Acceptance Criteria:**
- [ ] Edge case: Episode already transcribed (shared cache) when moved to library — `ProcessEpisodeJob` skips API calls, marks ready immediately. (Existing behavior, verify not broken.)
- [ ] Edge case: User moves episode to library, then archives before processing completes — processing continues to completion. (Existing behavior, verify not broken.)
- [ ] Edge case: Inbox episodes auto-transcribed before this change — existing transcripts/summaries remain on `Episode` model, no data loss. (Existing data, verify not broken.)
- [ ] Edge case: `DetectStuckProcessingJob` after Episode detection block removed — legacy episode-level stuck rows may remain in the database but no new episode-level processing is enqueued; the job runs without errors and does not touch episode-level records.
- [ ] Verification: No remaining references to `AutoProcessEpisodeJob` in runtime code or specs (`app/`, `config/`, `lib/`, `spec/`) — confirmed via grep. References in pipeline docs and git history are expected.
- [ ] All existing specs pass (`bundle exec rspec`).

**Web (Rails):**
- [ ] Run full test suite and verify green
- [ ] Grep `app/`, `config/`, `lib/`, `spec/` for `AutoProcessEpisodeJob` — confirm zero references in runtime code
- [ ] Verify `ProcessEpisodeJob` specs still pass (no regressions)

**Dependencies:** M1, M2

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
- [x] Architecture proposal approved: `pipeline-projects/library-scoped-processing/architecture-proposal.md`
- [x] Milestones correctly reference the approved data model (no schema changes)
- [x] No API changes in this project
- [x] No contradictions between gameplan and approved architecture

### Security & Access Control
- [x] Digest query scoped to user via `user_episodes.user_id` — same or tighter than current subscription join
- [x] No new controller actions or routes
- [x] No new attack surfaces — changes narrow query scope
- [x] N/A — no API authentication changes

### Performance
- [x] New query joins `user_episodes` + `podcast` — same cardinality as current subscription join for single-user app
- [x] `user_episodes` has indexes on `user_id` — adequate for current data volume
- [x] No N+1 risks — `includes(:summary)` preloads summaries
- [x] Caching not needed — single-user, low volume

### Observability & Debuggability
- [x] Existing `SendDailyDigestJob` logging preserved (`[SendDailyDigestJob] Sent N digests, skipped N`)
- [x] `ProcessEpisodeJob` error logging unchanged
- [x] Debug path: check `user_episodes` table for location + processing_status to understand digest eligibility
- [x] No new alerts needed

### Analytics & Instrumentation
- [x] Existing `EmailEvent` tracking (open/click) preserved — no changes to tracking system
- [x] No new analytics events needed — existing digest tracking covers the changed behavior
- [x] N/A — no additional instrumentation infrastructure

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Model specs | `Episode.library_ready_since` scope | Web | Pipeline |
| Mailer specs | DigestMailer library filtering, 24-hour cap, subject line, NullMail | Web | Pipeline |
| Job specs | SendDailyDigestJob eligibility, FetchPodcastFeedJob (no auto-process), DetectStuckProcessingJob (UserEpisode only) | Web | Pipeline |
| Manual QA | Digest email content, inbox behavior, library processing flow | Web | Human |

### Feature Flags & Rollout
- [x] N/A — no feature flag. Single-user personal app, direct deploy.

### Legacy & Migration
- [x] Episode-level `processing_status` columns remain (backward compatibility with legacy data)
- [x] No data migration needed — behavioral change only
- [x] Existing transcripts/summaries on `Episode` records preserved

### Export/Reporting
- [x] N/A — no export impact

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| M1 and M2 are independent — can be implemented in either order | Low | No dependency between them; implement sequentially for clean commit history |
| Digest mailer has thread-local + race-condition architecture | Med | Preserve `since` parameter serialization pattern exactly as documented in architecture 6.7 |
| `updated_at` as readiness proxy could be imprecise if other updates happen | Low | Acceptable for single-user app; only `ProcessEpisodeJob` updates library episodes |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | All milestones (M1-M4) | No flag | Single user (personal app) |

### Done Criteria
- [ ] All acceptance criteria met across M1-M4
- [ ] All specs passing (`bundle exec rspec`)
- [ ] No remaining references to `AutoProcessEpisodeJob` in runtime code (`app/`, `config/`, `lib/`, `spec/`)
- [ ] Digest email verified with realistic test data (M3 seed task)

---

## 7. Estimates

| Milestone | Size | Notes |
|-----------|------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 0-2 |
| M1: Shared Scope & Digest Query Change | S | 3 files modified + 2 spec files updated |
| M2: Remove Auto-Processing from Feed Fetch | S | 2 files modified + 3 files deleted + 2 spec files updated |
| M3: QA Test Data | S | 1 new rake task |
| M4: Edge Cases & Polish | S | Verification only, no new code |

---

## PRD Traceability Matrix

| PRD Requirement | Milestone | Acceptance Criterion |
|-----------------|-----------|---------------------|
| DIG-001 | M1 | Digest queries `user_episodes` in library location |
| DIG-002 | M1 | Library episodes with `processing_status=ready` and `updated_at` after eligibility window |
| DIG-003 | M1 | Subject line and email body copy reflect library-centric framing |
| DIG-004 | M1 | NullMail returned when no matching episodes |
| TRX-001 | M2 | `FetchPodcastFeedJob` does not enqueue `AutoProcessEpisodeJob` |
| TRX-002 | M2 | `FetchPodcastFeedJob` still creates Episode + UserEpisode records |
| TRX-003 | M2 | `ProcessEpisodeJob` continues to work as-is |
| TRX-004 | M2 | `DetectStuckProcessingJob` detects UserEpisode only |
| CLN-001 | M2 | `AutoProcessEpisodeJob` and specs deleted |
| CLN-002 | M2 | Episode-level columns remain |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2026-02-17
### Status: Approved

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Milestone sizes are appropriate (no XL milestones that should be split)
- [x] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-17 | Pipeline | Initial gameplan generated |
| 2026-02-17 | Pipeline | Address feedback: DIG-003 expanded to cover email body copy (not just subject), AutoProcessEpisodeJob grep scoped to runtime code, stuck record edge case made concrete |
