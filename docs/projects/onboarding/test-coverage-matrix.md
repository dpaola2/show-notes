# Test Coverage Matrix — Phase 2 Onboarding

> Generated by Pipeline Stage 4 (Test Generation)
> Maps every gameplan acceptance criterion to its test location(s).

## Summary

| Metric | Value |
|--------|-------|
| **Test files created** | 8 (1 factory + 7 specs) |
| **Acceptance criteria covered** | 38 of 38 |
| **Total test cases** | ~65 |

---

## Coverage by Milestone

### M1: Tracking Infrastructure & Episode Route

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| TRK-004 | email_events table with correct columns and indexes | `spec/models/email_event_spec.rb` | `describe "validations"`, `describe "associations"` |
| TRK-001 | Open tracking pixel returns GIF and records triggered_at | `spec/requests/tracking_spec.rb` | `context "TRK-001: open tracking pixel"` |
| TRK-002 | Click redirect records triggered_at, redirects to episode page (summary) | `spec/requests/tracking_spec.rb` | `context "TRK-002: click tracking on summary links"` |
| TRK-003 | Click redirect redirects with #audio anchor (listen) | `spec/requests/tracking_spec.rb` | `context "TRK-003: click tracking on listen links"` |
| TRK-006 | Graceful degradation for invalid tokens; skip auth | `spec/requests/tracking_spec.rb` | `context "TRK-006: graceful degradation"`, `context "TRK-006: tracking endpoints skip authentication"` |
| DIG-003 | Episode show page displays summary, quotes, audio player | `spec/requests/episodes_spec.rb` | `context "DIG-003: episode show page with summary"` |
| DIG-004 | Episode show page includes audio player | `spec/requests/episodes_spec.rb` | `context "DIG-004: episode show page with audio player"` |
| DIG-008 | Episode show page shows processing state | `spec/requests/episodes_spec.rb` | `context "DIG-008: episode without summary shows processing state"` |
| Security | Episode show page subscription scoping | `spec/requests/episodes_spec.rb` | `context "Security: subscription scoping"` |
| Security | Tracking no open redirect | `spec/requests/tracking_spec.rb` | `context "Security: no open redirect"` |
| M1-model | EmailEvent scopes (opens, clicks, triggered, for_date) | `spec/models/email_event_spec.rb` | `describe "scopes"` |
| M1-model | EmailEvent#triggered? and #trigger! | `spec/models/email_event_spec.rb` | `describe "#triggered?"`, `describe "#trigger!"` |

### M2: Auto-Processing Pipeline

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| AUTO-001 | New episodes queued for processing on feed poll | `spec/jobs/fetch_podcast_feed_job_spec.rb` | `context "AUTO-001: auto-processing triggered"` |
| AUTO-002 | No user action required (episode-level job) | `spec/jobs/auto_process_episode_job_spec.rb` | `context "AUTO-001/AUTO-002: auto-processing new episodes"` |
| AUTO-003 | Uses existing AssemblyAI + Claude pipeline | `spec/jobs/auto_process_episode_job_spec.rb` | Tests verify AssemblyAiClient.transcribe and ClaudeClient.summarize_chunked are called |
| AUTO-004 | Already-processed episodes not re-processed | `spec/jobs/auto_process_episode_job_spec.rb` | `context "AUTO-004: skip already-processed episodes"`, `context "AUTO-004: skip when only transcript exists"` |
| AUTO-005 | Failures don't block other episodes; retries with backoff | `spec/jobs/auto_process_episode_job_spec.rb` | `context "AUTO-005: processing failures are isolated"`, `context "AUTO-005: retry on rate limit errors"` |
| AUTO-006 | No processing cap | N/A | Verified by absence of any cap logic in tests — all episodes are processed |
| AUTO-007 | Backfill ~10 per podcast | `spec/jobs/fetch_podcast_feed_job_spec.rb` | `context "AUTO-007: initial_fetch limits to 10 episodes"` |
| AUTO-001 | Existing episodes not auto-processed | `spec/jobs/fetch_podcast_feed_job_spec.rb` | `context "AUTO-001: does not auto-process existing episodes"` |

### M3: Digest Email Redesign

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| DIG-001 | All new episodes included (no truncation) | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-001: all new episodes included"` |
| DIG-002 | Show name, title, and summary per episode | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-002: each episode displays show name, title, and summary"` |
| DIG-003 | Read full summary links | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-003: Read full summary links"` |
| DIG-004 | Listen links | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-004: Listen links"` |
| DIG-005 | Summary is most prominent element | N/A (visual/CSS — not testable via RSpec; verified in manual QA) |
| DIG-006 | Visual separation between episodes | N/A (visual/CSS — not testable via RSpec; verified in manual QA) |
| DIG-007 | Header with date and count | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-007: email header with date and count"` |
| DIG-008 | Processing state for unfinished episodes | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-008: episodes without summary show processing state"` |
| DIG-009 | Grouped by show | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-009: episodes grouped by show"` |
| DIG-010 | Clean and readable | N/A (visual — verified in manual QA) |
| DIG-011 | Existing DigestMailer adapted | Verified by spec file testing `DigestMailer` class (same class, new behavior) |
| DIG-012 | 7 AM Eastern send schedule | N/A (Solid Queue config — not unit testable; verify config file in M3) |
| DIG-013 | Skip empty digests | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-013: skip empty digests"` and `spec/jobs/onboarding_send_daily_digest_job_spec.rb` | `context "DIG-013: skips digest when user has no new episodes"` |
| TRK-001 | Tracking pixel in digest | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "TRK-001: tracking pixel embedded in email"` |
| TRK-002 | Summary links use tracking redirects | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "TRK-002: summary links use tracking redirect URLs"` |
| TRK-003 | Listen links use tracking redirects | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "TRK-003: listen links use tracking redirect URLs"` |
| TRK-004 | Tracking events pre-created | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "TRK-004: tracking events pre-created in database"` |

### M4: Onboarding Flow Updates

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| ONB-001 | Auto-processing begins after OPML import | Covered by M2 tests (FetchPodcastFeedJob triggers AutoProcessEpisodeJob) |
| ONB-002 | Completion page shows "first briefing tomorrow" | Verified in manual QA (existing copy in imports/complete.html.erb) |
| ONB-003 | Magic link invitation flow | Existing auth tests cover this; no changes needed |

### M5: QA Test Data

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| M5 seed task | All M5 criteria are rake task behavior | N/A (rake task verified via manual QA; seed tasks don't need automated tests) |

### M6: Edge Cases & Polish

| Criterion ID | Description | Test File | Test Context |
|-------------|-------------|-----------|--------------|
| Edge: 0 new episodes | No email sent | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-013"`, `spec/jobs/onboarding_send_daily_digest_job_spec.rb` |
| Edge: 50+ episodes | All included | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "DIG-001"` (tested with 11 episodes, verifying no truncation) |
| Edge: Processing failed | Episode appears with title only | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "edge case: episode with failed processing"` |
| Edge: Tracking pixel blocked | Open not recorded, clicks still work | `spec/requests/tracking_spec.rb` | Design ensures click tracking is independent of pixel |
| Edge: Tracking fails gracefully | User reaches destination | `spec/requests/tracking_spec.rb` | `context "TRK-006"` |
| Edge: Old episodes excluded | Not in digest | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "edge case: old episodes before last digest"` |
| Edge: Unsubscribed podcast excluded | Not in digest | `spec/mailers/onboarding_digest_mailer_spec.rb` | `context "edge case: episodes from unsubscribed podcasts excluded"` |
| TRK-005 | Engagement report rake task | N/A (rake task verified via manual QA) |

---

## Files Created

| File | Purpose |
|------|---------|
| `spec/factories/email_events.rb` | Factory for EmailEvent model with traits (:open, :click_summary, :click_listen, :triggered) |
| `spec/models/email_event_spec.rb` | EmailEvent validations, associations, scopes, trigger! method |
| `spec/requests/tracking_spec.rb` | TrackingController: click redirect, open pixel, auth bypass, graceful degradation |
| `spec/requests/episodes_spec.rb` | EpisodesController: show page with summary, audio player, processing state, subscription scoping |
| `spec/jobs/auto_process_episode_job_spec.rb` | AutoProcessEpisodeJob: transcribe+summarize, skip processed, retry on rate limit, error isolation |
| `spec/jobs/fetch_podcast_feed_job_spec.rb` | FetchPodcastFeedJob: auto-process trigger on new episodes, initial_fetch limit |
| `spec/mailers/onboarding_digest_mailer_spec.rb` | DigestMailer newsletter format: all episodes, grouped by show, summaries, tracking links, pixel, empty digest |
| `spec/jobs/onboarding_send_daily_digest_job_spec.rb` | SendDailyDigestJob: subscription-based episode check, skip empty, first digest threshold |

---

## Criteria Not Automatically Tested (and Why)

| Criterion | Why | Verification Method |
|-----------|-----|---------------------|
| DIG-005 (summary most prominent) | Visual/CSS — not assertable via RSpec | Manual QA |
| DIG-006 (visual separation) | Visual/CSS — not assertable via RSpec | Manual QA |
| DIG-010 (clean and readable) | Subjective design quality | Manual QA |
| DIG-012 (7 AM schedule) | Solid Queue recurring config, not code behavior | Verify `config/recurring.yml` |
| ONB-002 (completion page copy) | Static HTML content verification | Manual QA |
| ONB-003 (magic link flow) | Existing auth tests cover this | Existing test suite |
| AUTO-006 (no processing cap) | Verified by absence of cap — no code to test | Code review |
| TRK-005 (engagement report) | Rake task output — verified via manual QA | Manual QA |
| M5 (QA seed task) | Rake task behavior — verified via manual QA | Manual QA |
