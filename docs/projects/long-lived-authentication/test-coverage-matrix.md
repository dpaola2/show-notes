# Test Coverage Matrix — Long-Lived Authentication

> Generated by Pipeline Stage 4 (Test Generation)
> Maps every gameplan acceptance criterion to its test location(s).

| Milestone | Criterion | Description | Test File | Describe/Context |
|-----------|-----------|-------------|-----------|------------------|
| M1 | SES-001 | Session persists across browser restarts | `spec/requests/session_persistence_spec.rb` | `describe "session cookie configuration"` — session maintained across multiple requests |
| M1 | SES-002 | Session lifetime configured to 1 year | Not directly testable from request specs (cookie attribute). Verified by presence of `config/initializers/session_store.rb` with `expire_after: 1.year`. |
| M1 | SES-003 | Multiple browsers maintain concurrent sessions | Inherent to cookie store (each browser has its own cookie). Verified by SES-001 tests — no server-side session table to conflict. |
| M1 | SES-005 | Logout destroys only current session | `spec/requests/session_persistence_spec.rb` | `it "session is destroyed after logout"` |
| M1 | DIG-001 | Authenticated user clicks digest link → lands on episode | `spec/requests/session_persistence_spec.rb` | `it "lands directly on episode when already authenticated"` |
| M1 | DIG-002 | Unauthenticated user → login → redirect back to episode | `spec/requests/session_persistence_spec.rb` | `it "redirects back to the episode after authenticating from a tracking link"` |
| M1 | DIG-002 (GET-only) | Return-to URL only stored for GET requests | `spec/requests/session_persistence_spec.rb` | `context "when the original request is not a GET"` (POST and DELETE tests) |
| M1 | DIG-002 (cleanup) | Return-to URL consumed after redirect | `spec/requests/session_persistence_spec.rb` | `it "clears the return-to URL after redirect to prevent stale redirects"` |
| M1 | SEC-001 | Session cookie encrypted via secret_key_base | Inherent to Rails cookie store. No regression test needed — would require removing Rails' cookie encryption to break. |
| M1 | — | Existing logout behavior unchanged | `spec/requests/session_persistence_spec.rb` | `it "session is destroyed after logout"` |
| M1 | — | Existing magic-link flow unchanged | Covered by existing `spec/requests/sessions_spec.rb` (185 lines, full auth flow) — run as regression. |
| M1 | — | Root path redirect when no return-to URL | `spec/requests/session_persistence_spec.rb` | `it "redirects to root when no return-to URL is stored"` |

## Criteria Not Directly Testable via Specs

| Criterion | Reason | Verification Method |
|-----------|--------|-------------------|
| SES-002 (1-year expiry) | Request specs don't expose cookie `Expires` attribute | Verify `config/initializers/session_store.rb` contains `expire_after: 1.year` |
| SES-003 (concurrent sessions) | Can't simulate multiple browsers in one test process | Inherent to cookie store — verified by absence of server-side session table |
| SES-004 (cross-device logout independence) | Same as SES-003 | Inherent to cookie store — each browser has its own cookie |
