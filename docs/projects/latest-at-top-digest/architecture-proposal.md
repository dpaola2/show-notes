---
pipeline_stage: 2
pipeline_stage_name: architecture
pipeline_project: "latest-at-top-digest"
pipeline_started_at: "2026-02-19T07:48:22-0500"
pipeline_completed_at: "2026-02-19T07:50:35-0500"
pipeline_approved_at: "2026-02-19T07:52:00-0500"
---

# Latest-at-Top Digest Layout - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** 2026-02-19
> **PRD:** `docs/projects/latest-at-top-digest/prd.md`
> **Discovery Report:** `docs/projects/latest-at-top-digest/discovery-report.md`

---

## 1. Data Model Changes

### New Tables

None. This feature is a mailer and template redesign only.

### Modified Tables

None. No schema changes are required.

### Models

#### `Episode` — scope modification

The existing `library_ready_since` scope requires two changes:

1. **Add summary filter:** Join on `summary` (INNER JOIN) so episodes without a completed summary are excluded. This satisfies PRD FE-006 and RE-005.
2. **Change sort order:** From `podcasts.title ASC, episodes.published_at DESC` (grouped by show) to `user_episodes.updated_at DESC` (flat recency). This enables selecting the single most recent episode as the featured episode.

```ruby
# app/models/episode.rb — MODIFIED scope
scope :library_ready_since, ->(user, since) {
  joins(:user_episodes, :podcast, :summary)
    .where(user_episodes: { user_id: user.id, location: :library, processing_status: :ready })
    .where("user_episodes.updated_at > ?", since)
    .includes(:podcast, :summary)
    .order("user_episodes.updated_at DESC")
}
```

**Safety:** This scope is only used in two places — `DigestMailer.daily_digest` and `SendDailyDigestJob#has_new_episodes?`. Both are part of the digest flow, so the behavioral change (excluding summary-less episodes, flat ordering) is desired everywhere.

### Associations Map

No new associations. Existing relationships are unchanged:

```
Podcast 1──* Episode 1──1 Summary
                │
                └──* UserEpisode *──1 User
                │
                └──* EmailEvent *──1 User
```

### Migration Plan

No migrations required.

### Expected Data Volumes

No change. The same tables are queried with a slightly more restrictive filter (INNER JOIN on summary instead of LEFT JOIN via includes).

---

## 2. API Endpoints

N/A — this project does not expose an API. Changes are limited to the mailer and email templates.

---

## 3. Backwards Compatibility

N/A — no backwards compatibility concerns for this project. This modifies email templates only; there are no API consumers or client versions to support.

---

## 4. Security Design

### Query Scoping

No changes. The `library_ready_since` scope is already scoped to the user via `user_episodes: { user_id: user.id }`.

### Authorization

No changes. The digest mailer runs in a background job context (`SendDailyDigestJob`) and iterates over digest-enabled users. No user-facing authorization is involved.

### New Attack Surface

None. No new endpoints, parameters, or data access paths are introduced. The existing EmailEvent tracking system (opaque tokens, internal redirects) is unchanged.

---

## 5. Export Impact

N/A — no export impact.

---

## 6. Mailer Restructuring

This is the core of the feature. The `DigestMailer` class method and instance method both need restructuring.

### Class Method (`self.daily_digest`)

**Current:** Queries episodes, groups by podcast into `episodes_by_show` hash, creates 2 click events per episode (summary + listen).

**New:**
1. Query episodes using the updated `library_ready_since` scope (already sorted by `user_episodes.updated_at DESC`, already filtered for summary presence)
2. Convert to a flat array: `episodes = Episode.library_ready_since(user, since).to_a`
3. Split: `featured_episode = episodes.first`, `recent_episodes = episodes[1..5] || []`
4. Return `NullMail` if `featured_episode.nil?` (no qualifying episodes)
5. Create EmailEvent records:
   - 1 open event (unchanged)
   - Featured episode: 1 click event (`link_type: "summary"` for "Read in app")
   - Each recent episode: 2 click events (`summary` + `listen`)
6. Stash in thread-local:

```ruby
Thread.current[:digest_mailer_data] = {
  featured_episode: featured_episode,
  recent_episodes: recent_episodes,
  open_event: open_event,
  click_events: click_events
}
```

### Instance Method (`daily_digest`)

**Current:** Reads `@episodes_by_show`, computes `@episode_count`, generates generic subject.

**New:**
1. Read from thread-local (or re-query in deliver_later fallback)
2. Set `@featured_episode`, `@recent_episodes`, `@open_event`, `@click_events`
3. Compute `@total_count = 1 + @recent_episodes.size`
4. Generate subject line:

```ruby
subject = "#{@featured_episode.podcast.title}: #{@featured_episode.title}"
subject += " (+#{@recent_episodes.size} more)" if @recent_episodes.any?
```

5. Keep `@date` for the header

### Deliver-Later Fallback

The instance method's fallback path (when `Thread.current[:digest_mailer_data]` is nil) must mirror the new class method logic:

```ruby
since ||= [user.digest_sent_at, 24.hours.ago].compact.max
all_episodes = Episode.library_ready_since(user, since).to_a
@featured_episode = all_episodes.first
@recent_episodes = all_episodes[1..5] || []

digest_date = Date.current.to_s
@open_event = EmailEvent.find_by(user: user, event_type: "open", digest_date: digest_date)
@click_events = {}
([@featured_episode] + @recent_episodes).compact.each do |episode|
  summary_event = EmailEvent.find_by(user: user, event_type: "click",
    link_type: "summary", episode: episode, digest_date: digest_date)
  listen_event = EmailEvent.find_by(user: user, event_type: "click",
    link_type: "listen", episode: episode, digest_date: digest_date)
  @click_events[episode.id] = { summary: summary_event, listen: listen_event }.compact
end
```

---

## 7. Template Changes

### HTML Template (`daily_digest.html.erb`)

Replace the current grouped-by-show layout with:

1. **Header** — Keep "Your library" + date. Change count to `@total_count` (only qualifying episodes shown).
2. **Featured episode section:**
   - Podcast name (uppercase, styled like current `.show-name`)
   - Episode title (larger, bolder than bottom episodes)
   - All summary sections: each `section["title"]` as a heading + `section["content"]` as body. Mirror the structure from `episodes/show.html.erb` lines 13-18, adapted to email-safe inline CSS.
   - Quotes block (if `@featured_episode.summary.quotes.any?`): styled as blockquotes with left border. Mirror `episodes/show.html.erb` lines 21-34, adapted to inline CSS.
   - Single "Read in app" link using `@click_events[@featured_episode.id][:summary].token`
3. **Recent episodes section** (if `@recent_episodes.any?`):
   - "Latest episodes" heading
   - Each episode in the current compact format: title + truncated first section (200 chars) + "Read full summary" + "Listen" links
4. **Sign-off** — "That's all for now" message, always present (RE-006)
5. **Footer** — Unchanged: "Open Show Notes" + unsubscribe link + tracking pixel

### Email-Safe Inline CSS for New Elements

New styles needed (added to the existing `<style>` block):

```css
.featured { padding: 24px; }
.featured .podcast-name { font-size: 13px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.5px; color: #6b7280; margin-bottom: 8px; }
.featured .episode-title { font-size: 20px; font-weight: 700; color: #111827;
  margin: 0 0 20px; line-height: 1.3; }
.section-title { font-size: 15px; font-weight: 600; color: #111827;
  margin: 20px 0 8px; }
.section-content { font-size: 16px; color: #374151; line-height: 1.6;
  margin: 0 0 4px; }
.quote-block { border-left: 4px solid #3b82f6; padding: 12px 16px;
  margin: 12px 0; background: #eff6ff; border-radius: 0 6px 6px 0; }
.quote-text { font-style: italic; color: #374151; font-size: 15px;
  line-height: 1.5; margin: 0; }
.signoff { text-align: center; color: #6b7280; font-size: 14px;
  padding: 16px 24px; font-style: italic; }
```

### Text Template (`daily_digest.text.erb`)

Mirror the new layout in plain text:

```
[Podcast Name]
Episode Title
========================================

KEY TAKEAWAYS
The full content of the first summary section...

DISCUSSION POINTS
The full content of the second section...

> "This is a choice quote from the episode."
> "Another notable quote."

Read in app: [tracked link]

----------------------------------------
LATEST EPISODES
----------------------------------------

[Podcast B]
Episode Two Title
First 200 chars of summary preview...
Read full summary: [tracked link]
Listen: [tracked link]

...

----------------------------------------
That's all for now.

Open Show Notes: [root_url]
Manage your settings to unsubscribe: [settings_url]
```

---

## 8. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | Should the header count reflect total qualifying episodes or only displayed episodes? (e.g., if 10 episodes qualify but only 6 are shown, should the header say "10 episodes ready" or "6 episodes ready"?) | A: Total qualifying count / B: Displayed count only | **B (displayed count)** — avoids user confusion about where the other episodes are. The subject line already mentions "+N more" for the compact list, so the header should match what's visible. |
| 2 | When >6 episodes qualify, should the email mention "and X more in your library" at the bottom? (PRD open question #2) | A: Show "and X more" note / B: Just end with "That's all for now" | **A** — a brief note like "Plus 4 more episodes in your library" above the sign-off is helpful without cluttering. However, B is simpler and the omitted episodes will appear in the next digest or can be found in-app. |
| 3 | How should quotes be visually styled in the HTML email? (PRD open question #3) | A: Left blue border + light blue background (matches in-app) / B: Italic with quotation marks / C: Gray background block | **A (left border + background)** — consistent with the in-app display (`episodes/show.html.erb` line 25), and renders reliably across email clients. |
| 4 | Should summary section headings be displayed? (PRD open question #4) | A: Show headings (e.g., "Key Takeaways") / B: Show content only | **A (show headings)** — section titles provide valuable structure, especially for longer summaries. Mirrors the in-app display. |

---

## 9. Alternatives Considered

### Keep grouped-by-show layout with featured treatment

**Description:** Instead of flattening the episode list, keep the current podcast-grouped structure but give the most recent episode across all groups an expanded treatment.

**Pros:** Less disruption to the template structure; users who like the current grouping keep it.

**Cons:** The featured episode would be buried under its podcast heading, not at the absolute top. Conflicts with the PRD's design intent of making the digest "content-forward."

**Why rejected:** The PRD explicitly calls for a flat layout with the featured episode at the top, not nested under a podcast group.

### Filter for summaries in the mailer instead of the scope

**Description:** Keep the `library_ready_since` scope unchanged; add `.select { |e| e.summary.present? }` in the mailer class method.

**Pros:** No change to the scope; other hypothetical callers aren't affected.

**Cons:** Loads unnecessary data from the database (episodes without summaries); the scope is only used by the digest flow anyway; `SendDailyDigestJob#has_new_episodes?` would still count summary-less episodes as triggering a digest.

**Why rejected:** Adding the filter to the scope is cleaner, more efficient, and the scope has no other callers.

---

## 10. Architecture Decision Records

> ADRs for significant decisions are in the `decisions/` subdirectory.

| ADR | Title | Summary |
|-----|-------|---------|
| [ADR-001](decisions/ADR-001-featured-episode-ordering.md) | Featured Episode Ordering | Use `user_episodes.updated_at DESC` (library-ready time) rather than `episodes.published_at DESC` (publication date) to select the featured episode |

---

## 11. Summary

### Files to Create

None.

### Files to Modify

| File | Changes |
|------|---------|
| `app/models/episode.rb` | Update `library_ready_since` scope: add `:summary` to `joins`, change ordering to `user_episodes.updated_at DESC` |
| `app/mailers/digest_mailer.rb` | Restructure class method (flat list, featured/recent split, optimized EmailEvents); restructure instance method (new ivars, new subject line); update deliver_later fallback |
| `app/views/digest_mailer/daily_digest.html.erb` | Replace grouped layout with featured episode (full summary + quotes + "Read in app") + compact recent list + sign-off |
| `app/views/digest_mailer/daily_digest.text.erb` | Mirror new layout in plain text |
| `spec/mailers/digest_mailer_spec.rb` | Update existing tests and add new tests for: featured/recent split, new subject line format, full summary rendering, quote rendering, sign-off, single-episode case, no-summary exclusion |

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: Dave
### Date: 2026-02-19
### Status: Approved

#### Must Verify
- [x] Data model is architecturally sound (scope change is safe for all callers)
- [x] Mailer restructuring handles both same-thread and deliver_later paths correctly
- [x] Subject line format matches PRD requirements
- [x] Template design covers all edge cases (single episode, no quotes, >6 episodes)
- [x] EmailEvent creation logic is correct (1 for featured, 2 for bottom episodes)

#### Should Check
- [x] Email-safe CSS renders well across major email clients
- [x] Text template mirrors HTML layout accurately
- [x] Existing test coverage is sufficient as a baseline for new tests
- [x] Open questions are answerable
- [x] No conflicts with in-progress work or upcoming changes

#### Notes
Approved as-is.
