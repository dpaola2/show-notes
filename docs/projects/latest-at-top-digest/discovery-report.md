---
pipeline_stage: 1
pipeline_stage_name: discovery
pipeline_project: "latest-at-top-digest"
pipeline_started_at: "2026-02-19T07:41:08-0500"
pipeline_completed_at: "2026-02-19T07:41:54-0500"
---

# Latest-at-Top Digest Layout - Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** 2026-02-19
> **PRD:** `docs/projects/latest-at-top-digest/prd.md`
> **ADR:** `docs/projects/latest-at-top-digest/adr-001-digest-redesign-decisions.md`

---

## 1. PRD Understanding

### Feature Summary

Redesign the daily digest email so the most recent episode (across all subscriptions) is featured at the top with its full summary sections and choice quotes rendered inline. Below the featured episode, up to 5 additional recent episodes appear in the current compact format. The subject line changes from a generic count to `[Podcast Name]: Episode Title (+N more)`. Episodes without completed summaries are excluded entirely from the digest.

### Entities Identified

| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| DigestMailer | FE-001 through RE-006 | Yes | `app/mailers/digest_mailer.rb` |
| Episode | FE-001, FE-006 | Yes | `app/models/episode.rb` |
| Summary | FE-002, FE-003 | Yes | `app/models/summary.rb` |
| UserEpisode | FE-006, RE-005 | Yes | `app/models/user_episode.rb` |
| EmailEvent | FE-004 | Yes | `app/models/email_event.rb` |
| Digest HTML template | FE-002, FE-003 | Yes | `app/views/digest_mailer/daily_digest.html.erb` |
| Digest text template | TXT-001 | Yes | `app/views/digest_mailer/daily_digest.text.erb` |
| SendDailyDigestJob | N/A (orchestrator) | Yes | `app/jobs/send_daily_digest_job.rb` |
| TrackingController | FE-004 | Yes | `app/controllers/tracking_controller.rb` |

### Platforms Affected

- [x] Web (Rails) — email templates only, no app UI changes

---

## 2. Current State: Primary Platform

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| Episode | `app/models/episode.rb` | `belongs_to :podcast`, `has_one :summary`, `has_many :user_episodes`, `has_many :email_events` | Has `library_ready_since` scope used by digest |
| Summary | `app/models/summary.rb` | `belongs_to :episode` | JSON columns: `sections` (array of `{title, content, start_time, end_time}`), `quotes` (array of `{text, start_time, end_time}`) |
| UserEpisode | `app/models/user_episode.rb` | `belongs_to :user`, `belongs_to :episode` | `location` enum (inbox/library/archive/trash), `processing_status` enum |
| EmailEvent | `app/models/email_event.rb` | `belongs_to :user`, `belongs_to :episode` (optional) | Tracks opens and clicks per digest_date; `link_type` is `summary` or `listen` |
| User | `app/models/user.rb` | `has_many :user_episodes`, `has_many :email_events` | `digest_enabled`, `digest_sent_at` fields |
| Podcast | `app/models/podcast.rb` | `has_many :episodes` | Title used for subject line |

### Current Schema (Related Tables)

```sql
-- summaries
-- (from db/schema.rb)
CREATE TABLE summaries (
  id INTEGER PRIMARY KEY,
  episode_id BIGINT NOT NULL,
  sections JSON,
  quotes JSON,
  searchable_text TEXT,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- INDEX on episode_id

-- episodes
CREATE TABLE episodes (
  id INTEGER PRIMARY KEY,
  podcast_id BIGINT NOT NULL,
  title VARCHAR,
  guid VARCHAR,
  audio_url VARCHAR,
  description TEXT,
  duration_seconds INTEGER,
  published_at DATETIME,
  processing_status INTEGER DEFAULT 0 NOT NULL,
  processing_error TEXT,
  last_error_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- UNIQUE INDEX on [podcast_id, guid]

-- user_episodes
CREATE TABLE user_episodes (
  id INTEGER PRIMARY KEY,
  user_id BIGINT NOT NULL,
  episode_id BIGINT NOT NULL,
  location INTEGER DEFAULT 0 NOT NULL,
  processing_status INTEGER DEFAULT 0 NOT NULL,
  processing_error TEXT,
  retry_count INTEGER DEFAULT 0 NOT NULL,
  trashed_at DATETIME,
  last_error_at DATETIME,
  next_retry_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- UNIQUE INDEX on [user_id, episode_id]

-- email_events
CREATE TABLE email_events (
  id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL,
  episode_id INTEGER,
  event_type VARCHAR NOT NULL,
  link_type VARCHAR,
  token VARCHAR NOT NULL,
  digest_date VARCHAR NOT NULL,
  triggered_at DATETIME,
  user_agent VARCHAR,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- UNIQUE INDEX on token
-- INDEX on [user_id, digest_date]
```

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| TrackingController | `app/controllers/tracking_controller.rb` | `click`, `pixel` | Skips auth — token-based |
| EpisodesController | `app/controllers/episodes_controller.rb` | `show` | Requires auth, checks podcast subscription |

### Related Serializers

N/A — no API serializers in this project. Views render directly from models.

### Related API Endpoints (Current)

N/A — this is a mailer/template change. The tracking endpoints are internal:

| Method | Path | Purpose | Response Shape |
|--------|------|---------|---------------|
| GET | `/t/:token` | Click tracking redirect | Redirects to `episode_path` (summary) or `episode_path#audio` (listen) |
| GET | `/t/:token/pixel.gif` | Open tracking pixel | 1x1 transparent GIF |

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/mailers/digest_mailer_spec.rb` | Sends to user, subject line, HTML/text content, summary display, unsubscribe link, deliver_later fallback, no-duplicate events | Mailer |
| `spec/jobs/send_daily_digest_job_spec.rb` | Sends to enabled users with episodes, skips disabled users, skips users without subscriptions, updates digest_sent_at | Job |
| `spec/models/email_event_spec.rb` | (exists, not read — standard model spec) | Model |

### Related Background Jobs

| Job | File | Purpose |
|-----|------|---------|
| SendDailyDigestJob | `app/jobs/send_daily_digest_job.rb` | Iterates digest-enabled users, checks for new episodes via `library_ready_since`, enqueues DigestMailer per user, bumps `digest_sent_at` |

---

## 3. Cross-Platform Patterns

N/A -- single-platform project.

---

## 4. Key Code Analysis

### DigestMailer Data Flow

The mailer uses a two-phase architecture to handle ActionMailer's lazy rendering:

1. **Class method `self.daily_digest(user, since)`** (lines 16-51):
   - Calculates `since` from `user.digest_sent_at` or 24 hours ago
   - Calls `Episode.library_ready_since(user, since)` and groups by podcast
   - Returns `NullMail` if no episodes found
   - Creates EmailEvent tracking records (open + click per episode)
   - Stashes data in `Thread.current[:digest_mailer_data]`
   - Calls `super` to trigger the instance method

2. **Instance method `daily_digest(user, since)`** (lines 60-99):
   - Reads from thread-local (same-thread) or re-queries DB (deliver_later)
   - Sets `@episodes_by_show`, `@open_event`, `@click_events`
   - Generates subject: `"Your library — N episode(s) ready"`

### `library_ready_since` Scope (Episode model, line 19-25)

```ruby
scope :library_ready_since, ->(user, since) {
  joins(:user_episodes, :podcast)
    .where(user_episodes: { user_id: user.id, location: :library, processing_status: :ready })
    .where("user_episodes.updated_at > ?", since)
    .includes(:podcast, :summary)
    .order("podcasts.title ASC, episodes.published_at DESC")
}
```

**Critical observations:**
- Filters by `user_episodes.processing_status: :ready` — only library-ready episodes
- Does **NOT** filter for `summary.present?` — an episode can be `:ready` without a summary (edge case)
- Groups by podcast title alphabetically, then by `published_at` descending within each podcast
- Already `.includes(:summary)` — no N+1 for summary access
- Current ordering: grouped by podcast. The new design needs a **flat ordering by recency** to pick the single most recent episode across all shows

### Current Template Structure

**HTML template** (`daily_digest.html.erb`):
- Groups episodes by show (`@episodes_by_show.each`)
- Each episode: title + truncated first section content (200 chars) + "Read full summary" + "Listen" links
- Shows "Summary processing..." for episodes without summaries
- Footer with "Open Show Notes" and unsubscribe link

**Text template** (`daily_digest.text.erb`):
- Same structure in plain text
- Same truncated preview + links

### Current Subject Line

```ruby
"Your library — #{@episode_count} episode#{'s' unless @episode_count == 1} ready"
```

The PRD requires changing this to: `[Podcast Name]: Episode Title (+N more)`

### EmailEvent Tracking Pattern

Currently creates **two click events per episode** (summary + listen). The featured episode per ADR-001 only has a "Read in app" link (mapped to "summary" click type). Bottom episodes retain both link types.

### In-App Summary Display (Reference Pattern)

`app/views/episodes/show.html.erb` shows how summaries are rendered in the app:
- Each section: `section["title"]` as heading + `section["content"]` as body
- Quotes: `border-l-4 border-blue-500` blockquote with `"quote["text"]"` and optional timestamp
- Checks `@summary.quotes.any?` before rendering quotes block

This is the pattern the featured episode should mirror in the email template.

---

## 5. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| `library_ready_since` scope does not filter for `summary.present?` | Med | An episode with `user_episode.processing_status: :ready` but no `Summary` record would appear in the digest. The PRD requires excluding episodes without summaries. | Add `.where.associated(:summary)` or a subquery to the scope (or filter in the mailer) |
| Ordering change breaks grouped-by-show layout | Med | Current scope orders by `podcasts.title ASC` — the new design needs a flat list ordered by recency to identify the single featured episode. The bottom list also uses recency, not podcast grouping. | Change the scope's ordering or re-sort in the mailer. The `@episodes_by_show` hash structure may need to become a flat array. |
| Subject line requires eager access to featured episode data | Low | The subject line now depends on the featured episode's podcast name and title, which means the class method must identify the featured episode before calling `mail()`. Currently, the subject is set in the instance method. | Stash featured episode info in thread-local alongside existing data |
| Featured episode "Read in app" link creates only a "summary" click event, but the current code creates both "summary" and "listen" events for every episode | Low | Creating an unused "listen" event for the featured episode is wasteful but harmless. | Only create the "summary" click event for the featured episode; keep both for bottom episodes |
| Long summary content in emails | Low | The PRD says no truncation for the featured episode. Very long summaries (>2000 words) could cause email client rendering issues or clipping (Gmail clips at ~102KB). | Unlikely given typical podcast summary lengths, but worth monitoring |

### Performance Concerns

- **N+1 queries:** Already mitigated — `library_ready_since` uses `.includes(:podcast, :summary)`. No additional eager-loading needed.
- **Missing indexes:** No new indexes needed — existing indexes on `user_episodes` and `email_events` are sufficient.
- **Large data volumes:** The scope is per-user and time-bounded (since last digest). Even power users with many subscriptions won't have more than a few dozen episodes per digest window.

### Security Concerns

- No new security concerns. The tracking system uses opaque tokens and internal-only redirects. No changes to auth or scoping required.

---

## 6. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | Should "most recent" for featured episode use `episodes.published_at` or `user_episodes.updated_at`? The current scope orders by `published_at` within each podcast, but the ADR says "most recent across all subscriptions." | PRD Q1 / ADR-001 | No — default to `user_episodes.updated_at` since that reflects when the episode entered the user's library, which aligns with the digest's "since last sent" window. Can be changed later. |
| 2 | The current mailer creates both "summary" and "listen" click events for every episode. Should the featured episode only create a "summary" event (since it only has one link)? | ADR-001 §3 | No — can create both and only use one in the template, or optimize to create only what's needed. Either approach works. |
| 3 | The `library_ready_since` scope doesn't currently filter for summary presence. Should the filter be added to the scope itself, or applied in the mailer? | Code: `episode.rb:19-25` vs PRD FE-006/RE-005 | No — either approach works. Adding to the scope is cleaner but changes behavior for other callers (only `SendDailyDigestJob` uses it currently). |
| 4 | Should the mailer's `NullMail` check account for the new "must have summary" requirement? Currently it returns NullMail only when zero episodes match. With the new filter, it should also return NullMail when all matched episodes lack summaries. | PRD edge case: "All episodes lack summaries" | No — this naturally follows from adding the summary filter. |

---

## 7. Recommendations for Architecture Stage

- **Follow the in-app summary display pattern** from `app/views/episodes/show.html.erb` for the featured episode's sections and quotes. Adapt Tailwind classes to email-safe inline CSS.
- **Restructure the mailer data flow:** Replace `@episodes_by_show` (Hash grouped by podcast) with a flat list sorted by recency. Pick the first as featured; take up to 5 more as the bottom list.
- **Filter for summary presence** either in the `library_ready_since` scope or in the mailer class method. Since the scope is only used by the digest flow, adding it to the scope is cleanest.
- **Change the sort order** in the scope from `podcasts.title ASC, episodes.published_at DESC` to a single recency sort (likely `user_episodes.updated_at DESC` or `episodes.published_at DESC`).
- **Update the subject line** in the instance method using featured episode data stashed in the thread-local.
- **Only create a "summary" click event** for the featured episode (no "listen" link), while retaining both for bottom-list episodes. This is a minor optimization.
- **Keep the template self-contained** — the `daily_digest.html.erb` currently defines all styles inline in a `<style>` block. Continue this pattern; do not extract to a partial since email clients need everything inline.
- **Don't forget the text template** — `daily_digest.text.erb` must be updated in lockstep with the HTML template per TXT-001.
- **Existing test patterns** in `spec/mailers/digest_mailer_spec.rb` are straightforward — extend them to cover the featured/bottom split, new subject line format, and summary/quote rendering.
