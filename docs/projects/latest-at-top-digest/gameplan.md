---
pipeline_stage: 3
pipeline_stage_name: gameplan
pipeline_project: "latest-at-top-digest"
pipeline_started_at: "2026-02-19T07:54:44-0500"
pipeline_completed_at: "2026-02-19T07:54:57-0500"
pipeline_approved_at: "2026-02-19T00:00:00-0500"
---

# Latest-at-Top Digest Layout - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-19
> **PRD:** `docs/projects/latest-at-top-digest/prd.md`
> **Discovery Report:** `docs/projects/latest-at-top-digest/discovery-report.md`
> **Approved Architecture:** `docs/projects/latest-at-top-digest/architecture-proposal.md`

---

## 1. Project Overview

### Goals
- Make the daily digest immediately valuable by showing the full summary and quotes for the most recent episode inline
- Maintain discoverability of other recent episodes in a compact list below
- Increase click-through rates on the featured episode's "Read in app" link

### Scope Summary

| Description | Platform |
|-------------|----------|
| Update `library_ready_since` scope (summary filter + recency ordering) | Web (Rails) |
| Restructure `DigestMailer` class/instance methods (flat list, featured/recent split) | Web (Rails) |
| Redesign HTML digest template (featured episode + compact list) | Web (Rails) |
| Redesign text digest template to mirror HTML layout | Web (Rails) |
| Update and extend mailer specs | Web (Rails) |

### Out of Scope
- Changing the digest delivery schedule or frequency
- Adding user preferences for which episode to feature
- Modifying the episode page in the web app
- Changing the email tracking system (EmailEvent model unchanged)
- Adding new email event types beyond existing open/click
- Feature flags (this is a template change — rollback is a revert)

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (project root)
- Email templates must use email-safe inline CSS (no external stylesheets)
- No migrations — this is a mailer/template-only change
- No new models or controllers

---

## 2. Open Questions & Decisions

> Resolved during Stages 1-2 (Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| Should "most recent" use `published_at` or `user_episodes.updated_at`? | Resolved | `user_episodes.updated_at DESC` — reflects when the episode entered the user's library (ADR-001) |
| Should the scope filter for summary presence, or the mailer? | Resolved | Add INNER JOIN on `summary` to the scope — it's only used by the digest flow (Architecture §1) |
| Featured episode: one link or two? | Resolved | Single "Read in app" link (summary click type only). Bottom episodes keep both summary + listen. (Architecture §6) |
| When >6 episodes, mention overflow? | Resolved | Architecture recommends a brief "Plus N more" note, but this is optional polish (Open Question #2). Default to "That's all for now" sign-off per RE-006. |
| How should quotes be styled? | Resolved | Left blue border + light blue background, matching in-app display (Architecture §7, Open Question #3) |
| Should summary section headings be displayed? | Resolved | Yes — show headings for structure (Architecture §7, Open Question #4) |
| Header count: total or displayed? | Resolved | Displayed count only — avoids confusion (Architecture Open Question #1) |

---

## 3. Functional Milestones

> Organized by FEATURE AREA, not by platform.

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented across platforms (Stage 1)
- [x] Data model proposed and **approved** (Stage 2 + Architecture Review)
- [x] API endpoints designed — N/A for this project (Stage 2)
- [x] Open questions resolved (Stages 1-2 + Architecture Review)

---

### M1: Scope & Mailer Data Layer
**What:** Update the `library_ready_since` scope to filter for summary presence and sort by recency. Restructure `DigestMailer` class and instance methods to produce a featured episode + recent episodes list instead of grouped-by-show hash.
**Size:** M

**Acceptance Criteria:**
- [ ] FE-006 / RE-005: `library_ready_since` scope INNER JOINs on `summary`, excluding episodes without completed summaries
- [ ] FE-001 / RE-002: `library_ready_since` scope orders by `user_episodes.updated_at DESC` (flat recency, not grouped by podcast)
- [ ] FE-001: `DigestMailer.daily_digest` class method splits episodes into `featured_episode` (first) and `recent_episodes` (next 5)
- [ ] RE-004: When only 1 episode exists, `featured_episode` is set and `recent_episodes` is empty
- [ ] FE-004: Class method creates 1 click event (summary) for the featured episode; 2 click events (summary + listen) for each recent episode
- [ ] Edge case: When all qualifying episodes lack summaries, `NullMail` is returned (no digest sent)
- [ ] SL-001 / SL-002: Instance method generates subject line as `"Podcast Name: Episode Title"` with `" (+N more)"` appended when recent episodes exist
- [ ] Deliver-later fallback path mirrors the new class method logic (flat list, featured/recent split, re-queries EmailEvents)
- [ ] Thread-local data structure uses `featured_episode` and `recent_episodes` keys (not `episodes_by_show`)

**Web (Rails):**
- [ ] Modify `app/models/episode.rb` — update `library_ready_since` scope: add `:summary` to `joins`, change `order` to `user_episodes.updated_at DESC`
- [ ] Modify `app/mailers/digest_mailer.rb` — restructure `self.daily_digest`: flat episode list, featured/recent split, optimized EmailEvent creation
- [ ] Modify `app/mailers/digest_mailer.rb` — restructure `daily_digest` instance method: new ivars (`@featured_episode`, `@recent_episodes`, `@total_count`), new subject line
- [ ] Modify `app/mailers/digest_mailer.rb` — update deliver-later fallback to mirror new class method logic
- [ ] Modify `spec/mailers/digest_mailer_spec.rb` — update existing tests and add new tests for: featured/recent split, new subject line format, single-episode case, no-summary exclusion, NullMail when all episodes lack summaries, deliver-later fallback

**Dependencies:** None (first milestone)

---

### M2: Email Templates
**What:** Replace the grouped-by-show HTML and text templates with the new featured episode + compact recent list layout. Featured episode shows full summary sections, quotes, and a single "Read in app" link. Recent episodes use the current compact format.
**Size:** M

**Acceptance Criteria:**
- [ ] FE-002: Featured episode displays all summary sections with section title headings and full content (no truncation)
- [ ] FE-003: Featured episode displays quotes from `summary.quotes` as styled blockquotes (left blue border + light blue background)
- [ ] FE-004: Featured episode has a single "Read in app" tracked link
- [ ] RE-001: Up to 5 recent episodes displayed below the featured episode in compact format (title + 200-char preview + "Read full summary" + "Listen" links)
- [ ] RE-003: If fewer than 5 additional episodes exist, display however many are available
- [ ] RE-004: If only 1 episode total, show featured episode only — no "Latest episodes" section
- [ ] RE-006: "That's all for now" sign-off always present below the episode list
- [ ] Edge case: Featured episode has no quotes (or empty array) — quotes block omitted entirely
- [ ] Edge case: More than 6 total episodes — only 6 shown (1 featured + 5 recent), remainder omitted
- [ ] Edge case: Long summary content (>2000 words) — displayed in full, no truncation
- [ ] TXT-001: Plain-text template mirrors the HTML layout structure (full summary + quotes for featured, compact for recent)
- [ ] Header shows displayed episode count (not total qualifying count)
- [ ] Footer unchanged: "Open Show Notes" + unsubscribe link + tracking pixel

**Web (Rails):**
- [ ] Modify `app/views/digest_mailer/daily_digest.html.erb` — replace grouped layout with: header, featured episode (podcast name, episode title, summary sections with headings, quotes block, "Read in app" link), "Latest episodes" section (compact entries), sign-off, footer
- [ ] Add new CSS classes to `<style>` block: `.featured`, `.podcast-name`, `.episode-title`, `.section-title`, `.section-content`, `.quote-block`, `.quote-text`, `.signoff`
- [ ] Modify `app/views/digest_mailer/daily_digest.text.erb` — mirror new layout in plain text: full summary + quotes for featured, compact entries for recent, sign-off
- [ ] Modify `spec/mailers/digest_mailer_spec.rb` — add template-level tests: full summary rendering in HTML, quote rendering, section headings, sign-off presence, single-episode case (no "Latest episodes" heading), text template structure

**Dependencies:** M1 (needs restructured mailer data)

---

### M3: QA Test Data
**What:** Create a seed rake task that populates realistic test data covering all digest layout scenarios. This enables manual QA of the new digest format without requiring testers to construct their own data.
**Size:** S

**Acceptance Criteria:**
- [ ] Seed task exists at `lib/tasks/seed_digest_qa.rake`
- [ ] Task creates a test user with `digest_enabled: true` and a recent `digest_sent_at` (24+ hours ago)
- [ ] Task creates podcasts and episodes covering: (a) 6+ episodes with summaries (tests featured + full recent list + overflow), (b) 1 episode with summary (tests single-episode case), (c) episodes without summaries (tests exclusion), (d) episode with empty quotes array (tests no-quotes edge case)
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary of what was created (user email, episode count, instructions for previewing the digest)
- [ ] All scenarios from the manual QA checklist have supporting test data

**Web (Rails):**
- [ ] Create `lib/tasks/seed_digest_qa.rake` — idempotent rake task
- [ ] Uses existing model associations and enums
- [ ] No production-unsafe operations (dev/test only, guarded by `Rails.env`)

**Dependencies:** M1, M2 (needs the full feature implemented to QA)

---

### M4: Edge Cases & Polish
**What:** Handle remaining edge cases, ensure robust rendering across email clients, and verify all acceptance criteria are met end-to-end.
**Size:** S

**Acceptance Criteria:**
- [ ] Edge case: Quotes containing special characters or markdown render as plain text in email (no raw markdown leaks)
- [ ] Edge case: Summary section with very long content does not break email layout
- [ ] Edge case: Episode with summary but `quotes: []` shows no quotes block (no empty container)
- [ ] Email renders acceptably in Gmail, Apple Mail, and Outlook (manual visual check)
- [ ] All existing mailer specs continue to pass (no regressions)
- [ ] New specs cover all edge cases listed in PRD Section 8

**Web (Rails):**
- [ ] Review and harden HTML template for email client compatibility (inline styles, table fallbacks if needed)
- [ ] Review text template for formatting edge cases
- [ ] Verify spec coverage for all PRD edge cases — add any missing specs

**Dependencies:** M1, M2 (needs templates and mailer logic complete)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> These were reviewed and approved in the Architecture Review checkpoint. Reference the approved architecture for details.

- [x] Architecture proposal approved: `docs/projects/latest-at-top-digest/architecture-proposal.md`
- [ ] Milestones correctly reference the approved data model and API design
- [ ] No contradictions between gameplan and approved architecture

### Security & Access Control
- [x] All queries scoped to user via `user_episodes: { user_id: user.id }` — unchanged
- [x] No controller changes — digest runs in background job context
- [x] No new attack surfaces — no new endpoints, parameters, or data access paths
- [x] EmailEvent tracking unchanged — opaque tokens, internal redirects only
- [x] N/A — no API authentication changes

### Performance
- [x] Data volume: per-user, time-bounded query — unchanged
- [x] Query patterns: INNER JOIN on `summary` is more restrictive (fewer results), not less efficient
- [x] Indexes: existing indexes on `user_episodes` and `email_events` are sufficient
- [x] Caching needed? No
- [x] N+1 query risks: already mitigated via `.includes(:podcast, :summary)` in the scope

### Observability & Debuggability
- [x] Logging: `SendDailyDigestJob` already logs digest delivery — no changes needed
- [x] Debug path: existing `onboarding:engagement_report` rake task shows opens/clicks per user/date
- [x] Alerts needed? No — existing monitoring sufficient

### Analytics & Instrumentation

#### Success Metrics
- [ ] Digest click-through rate on featured episode "Read in app" link: +20% vs. current (30 days)
- [ ] Overall digest open rate: maintain or improve (30 days)
- [ ] Digest unsubscribe rate: no increase (60 days)

_Tracked via existing `EmailEvent` model (open/click events). No new analytics infrastructure needed._

#### Events to Track

| Event Name | Trigger | Key Properties | Platform |
|------------|---------|----------------|----------|
| `email_event` (open) | User opens digest email (tracking pixel) | `user_id`, `digest_date` | Web |
| `email_event` (click, summary) | User clicks "Read in app" on featured episode | `user_id`, `episode_id`, `link_type: summary` | Web |
| `email_event` (click, summary/listen) | User clicks links on recent episodes | `user_id`, `episode_id`, `link_type` | Web |

_All events use the existing `EmailEvent` model — no new tracking infrastructure._

#### Instrumentation Approach
- [x] Framework: Existing `EmailEvent` model with `TrackingController` endpoints
- [x] Implementation location: `DigestMailer` (event creation), `TrackingController` (event triggering)

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Model scope tests | `library_ready_since` scope behavior (summary filter, ordering) | Web (Rails) | Pipeline |
| Mailer unit tests | Featured/recent split, subject line, EmailEvent creation, NullMail, deliver-later fallback | Web (Rails) | Pipeline |
| Template content tests | Full summary rendering, quotes, sign-off, compact list, edge cases | Web (Rails) | Pipeline |
| Manual QA | Visual inspection of HTML email in Gmail, Apple Mail, Outlook | Web | Human |

### Feature Flags & Rollout
- [x] No feature flag needed — this is a template change with no behavioral risk
- [x] Existing per-user `digest_enabled` toggle provides opt-out
- [x] Rollback strategy: revert the commit

### Mobile-Specific
N/A — Pipeline Configuration lists Web only.

### Legacy & Migration
- [x] No backwards compatibility concerns — email templates only, no API consumers
- [x] No data migration needed — no schema changes
- [x] No old client versions to support

### Export/Reporting
- [x] N/A — no export functionality involved

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| `library_ready_since` scope change affects `SendDailyDigestJob#has_new_episodes?` | Low | Both callers (DigestMailer + Job) are part of the digest flow — the behavioral change (excluding summary-less episodes, flat ordering) is desired everywhere. Verify in specs. |
| Long summary content could trigger Gmail clipping (>102KB) | Low | Unlikely given typical podcast summary lengths. Monitor after deployment; if needed, can add a character cap in a follow-up. |
| Email CSS rendering varies across clients | Low | Use email-safe patterns (inline styles, table layouts). Manual visual check in M4. |
| Deliver-later fallback path must mirror class method logic | Med | Ensure spec coverage for the fallback path. Architecture already specifies the re-query pattern. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | All milestones (M1-M4) | N/A (no feature flag) | All digest-enabled users |

### Done Criteria
- [ ] All acceptance criteria met across M1-M4
- [ ] All specs passing (`bundle exec rspec`)
- [ ] Manual visual check of HTML digest in at least 2 email clients
- [ ] No regression in existing digest behavior for edge cases
- [ ] Deployed to production

---

## 7. Estimates

| Milestone | Size | Notes |
|-----------|------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 0-2 |
| M1: Scope & Mailer Data Layer | M | 3 files modified (episode.rb, digest_mailer.rb, spec), no migrations |
| M2: Email Templates | M | 3 files modified (HTML template, text template, spec), new CSS classes |
| M3: QA Test Data | S | 1 new file (rake task) |
| M4: Edge Cases & Polish | S | Review and harden existing files, add edge-case specs |

**Size guide:** S = 1-3 files, no migrations, no new patterns. M = 5-10 files, simple migration, follows existing conventions. L = 10-20 files, complex migrations, new patterns. XL = 20+ files, should probably be split.

---

## PRD Traceability Matrix

| PRD ID | Requirement | Milestone |
|--------|-------------|-----------|
| FE-001 | Most recently updated episode featured at top | M1 |
| FE-002 | Featured episode displays all summary sections | M2 |
| FE-003 | Featured episode displays choice quotes | M2 |
| FE-004 | Featured episode includes "Read in app" tracked link | M1 (event), M2 (template) |
| FE-006 | Skip episodes without summaries | M1 |
| RE-001 | Up to 5 additional recent episodes in compact format | M2 |
| RE-002 | Recent episodes ordered by recency | M1 (scope ordering) |
| RE-003 | Display however many are available if <5 | M2 |
| RE-004 | Single episode shown as featured, no recent section | M1 (data), M2 (template) |
| RE-005 | Only episodes with completed summaries in bottom list | M1 |
| RE-006 | "That's all for now" sign-off always present | M2 |
| SL-001 | Subject: `Podcast Name: Episode Title` | M1 |
| SL-002 | Subject appends `(+N more)` when additional episodes exist | M1 |
| TXT-001 | Text template mirrors new layout | M2 |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2026-02-19
### Status: Approved

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Milestone sizes are appropriate (no XL milestones that should be split)
- [x] Release plan is appropriate

#### Optional Notes
Approved as-is.

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-19 | Pipeline | Initial gameplan generated |
