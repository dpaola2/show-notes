---
pipeline_stage: 7
pipeline_stage_name: qa-plan
pipeline_project: "latest-at-top-digest"
pipeline_started_at: "2026-02-19T09:10:49-0500"
pipeline_completed_at: "2026-02-19T09:11:29-0500"
---

# QA Plan — Latest-at-Top Digest Layout

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-19
> **Branch:** `pipeline/latest-at-top-digest`
> **PR:** TBD
> **Gameplan:** `docs/projects/latest-at-top-digest/gameplan.md`
> **Progress:** `docs/projects/latest-at-top-digest/progress.md`

---

## 1. Feature Summary

The daily digest email has been redesigned so the most recently ready episode is featured prominently at the top with its full summary (all sections) and choice quotes displayed inline. Below the featured episode, up to 5 additional recent episodes appear in a compact format (title + 200-char preview + links). Episodes without completed summaries are excluded entirely from the digest.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Scope & Mailer Data Layer — updated `library_ready_since` scope (INNER JOIN on summary, `updated_at DESC` ordering), restructured DigestMailer (featured/recent split, new subject line) | `584d9d8` |
| M2 | Email Templates — HTML and text templates rewritten for featured + compact layout (committed as part of M1 due to ivar contract change) | `584d9d8` |
| M3 | QA Test Data — idempotent seed rake task covering all digest scenarios | `d9bee9d` |
| M4 | Edge Cases & Polish — inline CSS hardening for email client compatibility, overflow-wrap for long content | `64a4ee3` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests (project-related)** | 97 |
| **Passing** | 95 |
| **Failing** | 2 (pre-existing Stage 4 timing bugs) |
| **Test files** | 7 |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Model scope | `spec/models/episode_featured_digest_scope_spec.rb` | 3 | Summary filter, recency ordering |
| Model scope | `spec/models/episode_library_scope_spec.rb` | ~5 | Broader library scope behavior (updated for INNER JOIN) |
| Mailer (new) | `spec/mailers/featured_digest_mailer_spec.rb` | 21 | Featured/recent split, subject line, templates, edge cases |
| Mailer (existing) | `spec/mailers/digest_mailer_spec.rb` | ~12 | Core digest behavior (updated for new layout) |
| Mailer (existing) | `spec/mailers/onboarding_digest_mailer_spec.rb` | ~15 | Onboarding digest (updated for featured/recent) |
| Mailer (existing) | `spec/mailers/digest_mailer_library_spec.rb` | ~15 | Library-scoped digest behavior |
| Job | `spec/jobs/send_daily_digest_job_spec.rb` | ~10 | Job behavior (updated for summary requirement) |

### What Automated Tests Verify
- `library_ready_since` scope excludes episodes without summaries (INNER JOIN)
- Scope orders by `user_episodes.updated_at DESC` (flat recency)
- DigestMailer splits episodes into featured (1st) and recent (next 5)
- Subject line format: `"Podcast: Title"` and `"Podcast: Title (+N more)"`
- Featured episode gets 1 click event (summary only); recent get 2 (summary + listen)
- NullMail returned when no episodes have summaries
- HTML template renders full summary sections with headings
- HTML template renders quotes as styled blockquotes
- Featured episode has single "Read in app" link
- Recent episodes section appears only when >1 episode
- "That's all for now" sign-off always present
- Text template mirrors HTML layout (sections, quotes, sign-off, links)
- Episodes beyond 6th are omitted (1 featured + 5 recent cap)
- Deliver-later fallback produces same output as same-thread path
- Quotes with markdown characters render as plain text (no processing)

---

## 3. Test Data Setup

### Seed Command

```bash
bundle exec rake digest:seed_qa
```

**Prerequisites:** Development environment (`Rails.env.development?`), Letter Opener configured for email preview.

### Scenarios Seeded

| Scenario | Account/User | Data Created | Purpose |
|----------|-------------|--------------|---------|
| A: Featured + overflow | `digest-qa@example.com` | 8 episodes with summaries across 2 podcasts ("The Daily Deep Dive", "Tech Horizons") | Tests featured episode display, full recent list (5), and overflow (2 omitted) |
| B: Single episode | `digest-qa-single@example.com` | 1 episode with summary ("One-Off Interviews" podcast) | Tests single-episode digest — featured only, no "Latest episodes" section |
| C: No summaries | `digest-qa@example.com` | 2 episodes without summaries ("Unprocessed Episode 1" and "2") | Tests exclusion from digest — these should not appear |
| D: Empty quotes | `digest-qa@example.com` | 1 episode ("The Silent Revolution") with `quotes: []` | Tests no-quotes edge case — no quotes block rendered |

### Post-Seed Verification

1. Run the seed: `bundle exec rake digest:seed_qa`
2. Note the magic link token printed in output
3. Preview primary user digest:
   ```ruby
   DigestMailer.daily_digest(User.find_by(email: 'digest-qa@example.com')).deliver_now
   ```
4. Open Letter Opener at `/letter_opener` to view
5. Preview single-episode digest:
   ```ruby
   DigestMailer.daily_digest(User.find_by(email: 'digest-qa-single@example.com')).deliver_now
   ```
6. Open Letter Opener to view

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Featured Episode — Full Summary Display

#### QA-001: Featured episode shows full summary with section headings
**Criteria:** FE-002
**Test data:** Scenario A (primary user)
**Steps:**
1. Run `bundle exec rake digest:seed_qa`
2. In Rails console: `DigestMailer.daily_digest(User.find_by(email: 'digest-qa@example.com')).deliver_now`
3. Open Letter Opener at `/letter_opener`
4. Inspect the HTML email

**Expected:** The first episode ("Why Rust Is Eating the World") appears at the top as the featured episode. All three summary sections are displayed with their headings ("Key Takeaways", "Deep Dive", "Looking Ahead") and full content — no truncation.

---

#### QA-002: Featured episode displays quotes as styled blockquotes
**Criteria:** FE-003
**Test data:** Scenario A (primary user — featured episode has quotes)
**Steps:**
1. Using the same email from QA-001, inspect the featured episode section

**Expected:** Two quotes appear below the summary sections, styled with a left blue border (`#3b82f6`) and light blue background (`#eff6ff`). Quote text is italic. No raw markdown or special characters visible.

---

#### QA-003: Featured episode has single "Read in app" link
**Criteria:** FE-004
**Test data:** Scenario A
**Steps:**
1. Using the same email from QA-001, inspect the featured episode's links

**Expected:** Only one link appears for the featured episode: "Read in app". No "Listen" link. The link URL goes through the tracking redirect (`/t/...`).

---

### 4.2 Recent Episodes — Compact List

#### QA-004: Up to 5 recent episodes in compact format below featured
**Criteria:** RE-001, RE-002
**Test data:** Scenario A (8 episodes with summaries + 1 empty-quotes episode = 9 qualifying)
**Steps:**
1. Using the same email from QA-001, scroll below the featured episode

**Expected:** A "Latest episodes" heading appears, followed by exactly 5 episodes in compact format. Each shows: podcast name, episode title, ~200 character summary preview, "Read full summary" link, and "Listen" link. Episodes are ordered by recency (most recent first). The remaining episodes beyond 6 total are omitted.

---

#### QA-005: Recent episodes have both "Read full summary" and "Listen" links
**Criteria:** RE-001, FE-004 (contrast)
**Test data:** Scenario A
**Steps:**
1. Using the same email from QA-001, inspect any compact episode card

**Expected:** Each compact episode has two tracked links: "Read full summary" (goes through `/t/...`) and "Listen" (goes through `/t/...`). This is in contrast to the featured episode which has only "Read in app".

---

### 4.3 Single Episode Digest

#### QA-006: Single episode shows as featured with no recent section
**Criteria:** RE-004
**Test data:** Scenario B (single-episode user)
**Steps:**
1. In Rails console: `DigestMailer.daily_digest(User.find_by(email: 'digest-qa-single@example.com')).deliver_now`
2. Open Letter Opener, view this email

**Expected:** The single episode ("The One Big Idea") appears as the featured episode with full summary and quotes. No "Latest episodes" heading or compact section appears. The "That's all for now" sign-off appears directly after the featured episode.

---

#### QA-007: Single episode subject line format
**Criteria:** SL-001
**Test data:** Scenario B
**Steps:**
1. Using the same email from QA-006, check the subject line

**Expected:** Subject is `"One-Off Interviews: The One Big Idea"` — no `(+N more)` suffix.

---

### 4.4 Subject Line

#### QA-008: Multi-episode subject line includes (+N more)
**Criteria:** SL-001, SL-002
**Test data:** Scenario A
**Steps:**
1. Using the email from QA-001, check the subject line

**Expected:** Subject starts with the featured episode's podcast and title (e.g., `"The Daily Deep Dive: Why Rust Is Eating the World"`) followed by `(+5 more)` since there are 5 recent episodes displayed.

---

### 4.5 Edge Cases

#### QA-009: Episode with empty quotes array shows no quotes block
**Criteria:** PRD edge case — empty quotes `[]`
**Test data:** Scenario D ("The Silent Revolution" has `quotes: []`)
**Steps:**
1. This episode appears in the compact list for Scenario A. To test it as featured, temporarily adjust the seed data or manually set its `user_episodes.updated_at` to be most recent:
   ```ruby
   ep = Episode.find_by(title: "The Silent Revolution")
   ep.user_episodes.first.update_column(:updated_at, Time.current)
   DigestMailer.daily_digest(User.find_by(email: 'digest-qa@example.com')).deliver_now
   ```
2. View in Letter Opener

**Expected:** The featured episode shows full summary sections but no quotes block at all — no empty container, no "Quotes" heading, no empty space where quotes would be.

---

#### QA-010: Episodes without summaries are excluded
**Criteria:** FE-006, RE-005
**Test data:** Scenario C ("Unprocessed Episode 1" and "Unprocessed Episode 2" have no summaries)
**Steps:**
1. Using the email from QA-001, search for "Unprocessed"

**Expected:** Neither "Unprocessed Episode 1" nor "Unprocessed Episode 2" appear anywhere in the digest — not in the featured section, not in the compact list. They are completely excluded.

---

#### QA-011: "That's all for now" sign-off always present
**Criteria:** RE-006
**Test data:** Scenario A and Scenario B
**Steps:**
1. Check the Scenario A email (multi-episode) — scroll to the bottom
2. Check the Scenario B email (single episode) — scroll to the bottom

**Expected:** Both emails display "That's all for now" as a styled sign-off between the episode content and the footer.

---

#### QA-012: Footer unchanged (Open Show Notes + unsubscribe + tracking pixel)
**Criteria:** Gameplan §7 — footer unchanged
**Test data:** Any scenario
**Steps:**
1. Using any digest email, scroll to the very bottom

**Expected:** Footer contains "Open Show Notes" link, an unsubscribe/settings link, and a 1x1 tracking pixel image. No changes from the previous digest footer.

---

### 4.6 Email Client Rendering

#### QA-013: HTML email renders acceptably in Gmail (web)
**Criteria:** M4 acceptance — email client compatibility
**Steps:**
1. Send a digest to a real Gmail address (modify seed user email or use Rails console)
2. Open in Gmail web client

**Expected:** Featured episode section is clearly distinct. Summary section headings are bold. Quotes have visible left blue border and light blue background. Compact episodes are visually separated. No broken layouts, overlapping text, or missing styles. Long text wraps properly.

---

#### QA-014: HTML email renders acceptably in Apple Mail
**Criteria:** M4 acceptance — email client compatibility
**Steps:**
1. Send a digest to an email account configured in Apple Mail
2. Open in Apple Mail

**Expected:** Same rendering expectations as QA-013. Apple Mail typically renders `<style>` blocks, so the primary CSS should apply cleanly.

---

#### QA-015: HTML email renders acceptably in Gmail mobile (iOS/Android)
**Criteria:** M4 acceptance — email client compatibility
**Steps:**
1. Send a digest to a Gmail address
2. Open in Gmail mobile app

**Expected:** Layout is readable on mobile. Gmail mobile strips `<style>` blocks, so inline styles should provide the fallback. Quotes should still show the blue border and background. Text should wrap properly (no horizontal scrolling).

---

### 4.7 Plain-Text Template

#### QA-016: Plain-text version mirrors HTML layout
**Criteria:** TXT-001
**Test data:** Scenario A
**Steps:**
1. In Letter Opener, toggle to the plain-text version of the Scenario A email (Letter Opener shows both)

**Expected:** Featured episode shows: podcast name, episode title, all summary section headings (uppercased), full section content, quotes prefixed with `>`, and a "Read in app" link. Below: "LATEST EPISODES" heading, compact entries with title + preview + links. "That's all for now" sign-off at bottom. Footer with app link and unsubscribe.

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | All episodes lack summaries | Remove all summaries: `Summary.destroy_all` then trigger digest | NullMail returned — no email sent | FE-006 |
| 2 | Exactly 6 episodes with summaries | Adjust seed data to have exactly 6 episodes | 1 featured + 5 recent, no overflow, no omission | RE-001 |
| 3 | Exactly 1 episode | Use Scenario B user | Featured only, no compact section | RE-004 |
| 4 | Summary section with >2000 words | Create a summary with very long content via console | Displayed in full, no truncation, text wraps cleanly | PRD inferred |
| 5 | Quotes with markdown chars (`**bold**`, `*italic*`, backticks) | Create quote text with markdown via console | Rendered as literal text — no markdown processing | M4 |
| 6 | Episode title with special HTML characters (`<`, `>`, `&`) | Create episode with HTML chars in title | Characters are escaped in HTML output, displayed literally in text | Security |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| User preference for which episode to feature | Out of scope | Most recent (by `user_episodes.updated_at`) is always featured |
| Digest delivery schedule changes | Out of scope | Still 7 AM Eastern daily |
| "Plus N more in your library" overflow message | Not implemented | Gameplan Open Question #2 recommended it but was not required. Digest ends with "That's all for now" regardless of overflow. |
| Gmail clipping for very long emails (>102KB) | Acknowledged risk | Unlikely with typical podcast summaries. Monitor after deployment; add character cap in follow-up if needed. |
| Stage 4 timing bugs (2 tests) | Known test issue | `featured_digest_mailer_spec.rb:37` (SL-002) and `:303` (header count) fail due to test setup creating episodes at boundary timestamps. Not implementation bugs — test setup timing issue. |
| Flog score of 54.8 for `DigestMailer#daily_digest` | Accepted | Inherent to the two-phase architecture (class method + instance method with thread-local fallback). |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| `SendDailyDigestJob` | Low | Job uses `library_ready_since` scope — now INNER JOINs on summary. Verify job still sends digests for users with qualifying episodes and skips users without. |
| `has_new_episodes?` check | Low | Also uses `library_ready_since` — now excludes episodes without summaries. A user whose only new episodes lack summaries will NOT receive a digest (intentional). Verify this doesn't cause confusion. |
| Existing digest specs (11 updated) | Low | 11 pre-existing tests across 6 files were updated to add `create(:summary)` — verify no test logic was inadvertently changed. All passing. |
| OG Image specs (pre-existing failures) | None | 15 failures in `og_image_generator_spec.rb` and `og_image_job_spec.rb` are pre-existing and unrelated to this feature. |
| Onboarding digest flow | Low | Onboarding mailer specs were updated for the new layout. Verify onboarding emails still work correctly. |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag — rollback requires code revert | Per-user `digest_enabled` toggle provides opt-out if needed |
| Migration | N/A — no migrations in this project | No schema changes to reverse |
| Code revert | `git revert 64a4ee3 d9bee9d 584d9d8` | Reverts M4, M3, M1+M2. Run specs after revert to confirm clean state. |
| Data cleanup | Not needed | No new tables or columns. EmailEvent records created by the new format use the same schema — they remain valid after revert. |
| Verification | Run `bundle exec rspec` after revert | All tests should pass (minus the 15 pre-existing OG image failures) |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-016)
- [ ] Edge cases tested (table in Section 5)
- [ ] Regression areas checked (table in Section 7)
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
