<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f9fafb; margin: 0; padding: 20px; }
      .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden; }
      .header { background: #1e40af; color: white; padding: 24px; }
      .header h1 { margin: 0; font-size: 20px; }
      .header p { margin: 8px 0 0; opacity: 0.9; font-size: 14px; }
      .content { padding: 24px; }
      .show-group { margin-bottom: 28px; }
      .show-name { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #e5e7eb; }
      .episode { background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
      .episode-title { font-weight: 600; color: #111827; margin: 0 0 8px; font-size: 15px; }
      .episode-summary { font-size: 16px; color: #374151; line-height: 1.5; margin: 0 0 12px; }
      .episode-processing { font-size: 14px; color: #92400e; background: #fef3c7; padding: 8px 12px; border-radius: 4px; margin: 0 0 12px; }
      .episode-links { font-size: 14px; }
      .episode-links a { color: #2563eb; text-decoration: none; margin-right: 16px; }
      .footer { padding: 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; font-size: 13px; color: #6b7280; text-align: center; }
      .footer a { color: #2563eb; text-decoration: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Your podcasts this morning</h1>
        <p><%= @date %> &mdash; <%= @episode_count %> new episode<%= 's' unless @episode_count == 1 %></p>
      </div>

      <div class="content">
        <% @episodes_by_show.each do |podcast, episodes| %>
          <div class="show-group">
            <div class="show-name"><%= podcast.title %></div>

            <% episodes.each do |episode| %>
              <div class="episode">
                <p class="episode-title"><%= episode.title %></p>

                <% if episode.summary.present? %>
                  <p class="episode-summary"><%= truncate(episode.summary.sections.first["content"], length: 200) %></p>
                <% else %>
                  <p class="episode-processing">Summary processing...</p>
                <% end %>

                <div class="episode-links">
                  <a href="<%= tracking_click_url(@click_events[episode.id][:summary].token) %>">Read full summary</a>
                  <a href="<%= tracking_click_url(@click_events[episode.id][:listen].token) %>">Listen</a>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="footer">
        <p>
          <a href="<%= root_url %>">Open Show Notes</a>
        </p>
        <p style="margin-top: 12px;">
          You're receiving this because you have daily digest enabled.<br>
          <a href="<%= settings_url %>">Manage your settings</a> to unsubscribe.
        </p>
      </div>
    </div>

    <img src="<%= tracking_pixel_url(@open_event.token) %>" width="1" height="1" alt="">
  </body>
</html>
