---
pipeline_stage: 1
pipeline_stage_name: discovery
pipeline_project: "library-scoped-processing"
pipeline_started_at: "2026-02-17T08:23:44-0500"
pipeline_completed_at: "2026-02-17T08:26:04-0500"
---

# Library-Scoped Processing — Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** 2026-02-17
> **PRD:** `pipeline-projects/library-scoped-processing/prd.md`

---

## 1. PRD Understanding

### Feature Summary

Revert two behaviors that drifted toward a multi-user/newsletter model back to library-scoped operation. First, change the daily digest email to only include episodes the user has explicitly added to their library (currently includes all new episodes from subscribed podcasts). Second, stop auto-transcribing every new episode discovered by feed fetch — only transcribe when an episode is moved to the library.

### Entities Identified

| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| DigestMailer | DIG-001, DIG-002, DIG-003, DIG-004 | Yes | `app/mailers/digest_mailer.rb` |
| SendDailyDigestJob | DIG-001, DIG-004 | Yes | `app/jobs/send_daily_digest_job.rb` |
| FetchPodcastFeedJob | TRX-001, TRX-002 | Yes | `app/jobs/fetch_podcast_feed_job.rb` |
| AutoProcessEpisodeJob | TRX-001, CLN-001 | Yes | `app/jobs/auto_process_episode_job.rb` |
| ProcessEpisodeJob | TRX-003 | Yes | `app/jobs/process_episode_job.rb` |
| DetectStuckProcessingJob | TRX-004 | Yes | `app/jobs/detect_stuck_processing_job.rb` |
| UserEpisode | DIG-001, DIG-002 | Yes | `app/models/user_episode.rb` |
| Episode | CLN-002 | Yes | `app/models/episode.rb` |
| User (digest_sent_at) | DIG-002 | Yes | `app/models/user.rb` |
| EmailEvent | — (unchanged) | Yes | `app/models/email_event.rb` |

### Platforms Affected

- [x] Web (Rails)

---

## 2. Current State: Web (Rails)

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| UserEpisode | `app/models/user_episode.rb` | `belongs_to :user`, `belongs_to :episode` | `location` enum (inbox/library/archive/trash), `processing_status` enum, `move_to_library!` method |
| Episode | `app/models/episode.rb` | `belongs_to :podcast`, `has_many :user_episodes`, `has_one :transcript`, `has_one :summary` | Has its own `processing_status` enum (used by AutoProcessEpisodeJob) |
| User | `app/models/user.rb` | `has_many :subscriptions`, `has_many :podcasts, through: :subscriptions`, `has_many :user_episodes` | `digest_enabled` (boolean, default true), `digest_sent_at` (datetime, nullable) |
| Podcast | `app/models/podcast.rb` | `has_many :episodes`, `has_many :subscriptions` | — |
| Subscription | `app/models/subscription.rb` | `belongs_to :user`, `belongs_to :podcast` | Join model between User and Podcast |

### Current Schema (Related Tables)

```sql
-- users (from db/schema.rb)
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  email VARCHAR,
  digest_enabled BOOLEAN DEFAULT TRUE NOT NULL,
  digest_sent_at DATETIME,           -- tracks last digest send time
  magic_token VARCHAR,
  magic_token_expires_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);

-- episodes
CREATE TABLE episodes (
  id INTEGER PRIMARY KEY,
  podcast_id BIGINT NOT NULL,
  title VARCHAR,
  description TEXT,
  audio_url VARCHAR,
  guid VARCHAR,
  duration_seconds INTEGER,
  published_at DATETIME,
  processing_status INTEGER DEFAULT 0 NOT NULL,  -- used by AutoProcessEpisodeJob
  processing_error TEXT,
  last_error_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);

-- user_episodes
CREATE TABLE user_episodes (
  id INTEGER PRIMARY KEY,
  user_id BIGINT NOT NULL,
  episode_id BIGINT NOT NULL,
  location INTEGER DEFAULT 0 NOT NULL,           -- 0=inbox, 1=library, 2=archive, 3=trash
  processing_status INTEGER DEFAULT 0 NOT NULL,  -- used by ProcessEpisodeJob
  retry_count INTEGER DEFAULT 0 NOT NULL,
  next_retry_at DATETIME,
  processing_error TEXT,
  last_error_at DATETIME,
  trashed_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);

-- subscriptions
CREATE TABLE subscriptions (
  id INTEGER PRIMARY KEY,
  user_id BIGINT NOT NULL,
  podcast_id BIGINT NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

### Related Controllers

| Controller | File | Actions | Notes |
|-----------|------|---------|-------|
| InboxController | `app/controllers/inbox_controller.rb` | `index`, `add_to_library`, `archive` | `add_to_library` (lines 24-44) calls `move_to_library!` + `ProcessEpisodeJob.perform_later`. No changes needed. |
| LibraryController | `app/controllers/library_controller.rb` | `index`, `show`, `retry_processing`, `regenerate`, `archive` | `retry_processing` and `regenerate` both enqueue `ProcessEpisodeJob`. No changes needed. |

### Related Background Jobs

| Job | File | Purpose | Change Needed? |
|-----|------|---------|----------------|
| DigestMailer | `app/mailers/digest_mailer.rb` | Builds and sends daily digest email | **Yes** — query must change from subscription-scoped to library-scoped |
| SendDailyDigestJob | `app/jobs/send_daily_digest_job.rb` | Iterates digest-enabled users, checks for new episodes, triggers DigestMailer | **Yes** — `has_new_episodes?` query must change |
| FetchPodcastFeedJob | `app/jobs/fetch_podcast_feed_job.rb` | Fetches RSS feeds, creates Episode + UserEpisode records | **Yes** — remove `AutoProcessEpisodeJob.perform_later` call (line 35) |
| AutoProcessEpisodeJob | `app/jobs/auto_process_episode_job.rb` | Episode-level transcription + summarization | **Yes** — delete (single call site is being removed) |
| ProcessEpisodeJob | `app/jobs/process_episode_job.rb` | UserEpisode-level transcription + summarization | No |
| DetectStuckProcessingJob | `app/jobs/detect_stuck_processing_job.rb` | Marks stuck transcribing/summarizing records as error | **Yes** — remove Episode detection block (lines 19-29); keep UserEpisode block only |

### Current Digest Query (DigestMailer, lines 20-26)

The subscription-scoped query appears in **three places** — this is the key code to change:

**1. `DigestMailer.daily_digest` class method (line 20-26)** — eager episode fetch:
```ruby
episodes_by_show = Episode
  .joins(podcast: :subscriptions)
  .where(subscriptions: { user_id: user.id })
  .where("episodes.created_at > ?", since)
  .includes(:podcast, :summary)
  .order("podcasts.title ASC, episodes.published_at DESC")
  .group_by(&:podcast)
```

**2. `DigestMailer#daily_digest` instance method (lines 80-86)** — deliver_later fallback re-query:
```ruby
@episodes_by_show = Episode
  .joins(podcast: :subscriptions)
  .where(subscriptions: { user_id: user.id })
  .where("episodes.created_at > ?", since)
  .includes(:podcast, :summary)
  .order("podcasts.title ASC, episodes.published_at DESC")
  .group_by(&:podcast)
```

**3. `SendDailyDigestJob#has_new_episodes?` (lines 37-44)** — existence check:
```ruby
def has_new_episodes?(user)
  since = user.digest_sent_at || 1.day.ago
  Episode
    .joins(podcast: :subscriptions)
    .where(subscriptions: { user_id: user.id })
    .where("episodes.created_at > ?", since)
    .exists?
end
```

All three use `episodes.created_at > since` as the time filter. The PRD specifies filtering by `processing_status = ready` with readiness after `digest_sent_at` instead.

### Current Feed Fetch → Auto-Process Flow (FetchPodcastFeedJob, lines 34-35)

```ruby
# Auto-process: enqueue transcription + summarization
AutoProcessEpisodeJob.perform_later(episode.id)
```

This is the single call site for `AutoProcessEpisodeJob`. Removing this line is the entire TRX-001 change.

### Current DetectStuckProcessingJob (lines 1-31)

Two independent blocks:
- **Lines 7-17:** UserEpisode stuck detection — stays (used by ProcessEpisodeJob pathway)
- **Lines 19-29:** Episode stuck detection — remove (no episode-level processing after `AutoProcessEpisodeJob` deletion)

### Related Tests

| Test File | Coverage | Change Needed? |
|-----------|----------|----------------|
| `spec/mailers/digest_mailer_spec.rb` | Email sending, subject line, HTML/text body, thread-local race handling, deliver_later fallback | **Yes** — must verify library-only filtering |
| `spec/jobs/send_daily_digest_job_spec.rb` | Digest sent to users with new episodes, `digest_sent_at` update, skipping users with no episodes, disabled users | **Yes** — must verify library-only filtering |
| `spec/jobs/fetch_podcast_feed_job_spec.rb` | Episode creation, UserEpisode inbox creation, AutoProcessEpisodeJob enqueuing, initial_fetch limit | **Yes** — remove AutoProcessEpisodeJob assertions |
| `spec/jobs/auto_process_episode_job_spec.rb` | Transcription, summarization, error handling, retries, rate limit backoff | **Yes** — delete (job is being deleted) |
| `spec/jobs/auto_process_episode_job_state_tracking_spec.rb` | Episode-level processing state transitions | **Yes** — delete (job is being deleted) |
| `spec/jobs/process_episode_job_spec.rb` | Full pipeline, error catching, retry logic, concurrency, idempotency | No |
| `spec/jobs/detect_stuck_processing_job_spec.rb` | UserEpisode timeout, Episode timeout, boundary conditions, idempotency | **Yes** — remove Episode timeout detection tests; keep UserEpisode tests |

---

## 3. Cross-Platform Patterns

N/A — single-platform project.

---

## 4. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| Digest query has 3 copy-paste locations | Med | The subscription-scoped query is duplicated in the class method, instance method fallback, and `has_new_episodes?`. All three must be updated consistently or the digest will behave differently on `perform_now` vs `deliver_later`. | Extract to a shared scope on `Episode` (e.g., `Episode.library_ready_since(user, since)`) to eliminate drift risk |
| `since` semantics change | Med | Current query filters by `episodes.created_at > since`. PRD specifies filtering by `processing_status = ready` after `digest_sent_at`. These are different dimensions — `created_at` is when the episode was discovered, readiness is when processing completed. The new query needs a "became ready" timestamp, but neither `user_episodes.updated_at` nor a dedicated `ready_at` column tracks this precisely. | `updated_at` is the closest proxy — it's set when `processing_status` changes to `ready`. Acceptable for a single-user app. |
| NullMail early return depends on query | Low | `DigestMailer.daily_digest` returns `NullMail` when the episode count is zero (line 29). The new query must still return an empty result when no library episodes are ready, or the mailer will attempt to send an empty email. | The `NullMail` guard doesn't need changing — it responds to query results regardless of query shape |

### Performance Concerns

- None significant. The new query joins `user_episodes` instead of `subscriptions` — same cardinality for a single-user app.
- No missing indexes needed — `user_episodes` already has `user_id` and `location` columns (though a composite index on `[user_id, location, processing_status]` could help if data grows).

### Security Concerns

- None. All queries are already user-scoped. The change narrows scope (library only), which is more restrictive.

---

## 5. Open Questions

| # | Question | Source | Status |
|---|----------|--------|--------|
| 1 | Use `user_episodes.updated_at` as proxy for "became ready", or add a dedicated column? | DIG-002 vs current code | Resolved — use `updated_at` as proxy. Acceptable for single-user app; no migration needed. |
| 2 | Remove `DetectStuckProcessingJob`'s Episode block (lines 19-29) or leave to age out? | TRX-004, CLN-001 | Resolved — remove it. Episode-level processing is being deleted; the detection block should go with it. |
| 3 | Does the `since` race protection pattern survive the query change? | DigestMailer lines 11-15 | Resolved — yes, same pattern applies. The `since` parameter flows through identically. |

---

## 6. Recommendations for Architecture Stage

- **Extract shared query helper:** The subscription-scoped query exists in three places. Extract to a scope on `Episode` (e.g., `Episode.library_ready_since(user, since)`) so all three call sites use the same query. The `has_new_episodes?` check calls `.exists?` on the same scope.
- **FetchPodcastFeedJob change is a single line deletion** (line 35). The rest of the job stays intact.
- **Delete AutoProcessEpisodeJob** — it has exactly one call site (FetchPodcastFeedJob line 35). Delete the job class and both spec files (`auto_process_episode_job_spec.rb`, `auto_process_episode_job_state_tracking_spec.rb`).
- **Remove DetectStuckProcessingJob Episode block** (lines 19-29). Episode-level processing is being deleted; the detection block goes with it.
- **Digest subject line** (DigestMailer line 105) currently says "Your podcasts this morning" — PRD DIG-003 says to change to library-centric framing.
- **`since` race protection** pattern in DigestMailer (Thread.current stashing, `since` parameter serialization) must be preserved — the same race condition exists regardless of query shape.
- **24-hour digest cap:** Use `[digest_sent_at, 24.hours.ago].compact.max` to prevent stale backlogs after delivery gaps.
