---
pipeline_stage: 4
pipeline_stage_name: test-generation
pipeline_project: "library-scoped-processing"
pipeline_started_at: "2026-02-17T09:43:17-0500"
pipeline_completed_at: "2026-02-17T09:53:41-0500"
---

# Test Coverage Matrix — Library-Scoped Processing

> Generated by Pipeline Stage 4 (Test Generation)
> Maps every gameplan acceptance criterion to its test location(s).

---

## M1: Shared Scope & Digest Query Change

| Criterion | Description | Test File | Test Block |
|-----------|-------------|-----------|------------|
| DIG-001 | Digest queries user_episodes in library location | `spec/models/episode_library_scope_spec.rb` | `DIG-001: filters by library location` (4 tests: include library, exclude inbox/archive/trash) |
| DIG-001 | Digest queries user_episodes in library location | `spec/mailers/digest_mailer_library_spec.rb` | `DIG-001: only includes library episodes` (3 tests: include library, exclude inbox, exclude archived) |
| DIG-002 | 24-hour cap eligibility window | `spec/models/episode_library_scope_spec.rb` | `DIG-002: filters by processing_status and updated_at` (5 tests) + `DIG-002: 24-hour cap calculation` (2 tests) |
| DIG-002 | 24-hour cap eligibility window | `spec/mailers/digest_mailer_library_spec.rb` | `DIG-002: 24-hour cap on eligibility window` (4 tests: nil digest_sent_at, stale digest_sent_at, old updated_at, backlog cap) |
| DIG-003 | Library-centric subject and copy | `spec/mailers/digest_mailer_library_spec.rb` | `DIG-003: library-centric subject line and copy` (4 tests: subject includes "library", subject excludes "podcasts this morning", HTML heading, text heading) |
| DIG-004 | NullMail when no match | `spec/mailers/digest_mailer_library_spec.rb` | `DIG-004: NullMail when no library episodes match` (2 tests: inbox-only, not-ready) |
| `Episode.library_ready_since` scope | Scope exists with correct joins, filters, ordering | `spec/models/episode_library_scope_spec.rb` | All tests (14 total) — fails with NoMethodError until scope is added |
| `SendDailyDigestJob#has_new_episodes?` | Uses library scope with 24-hour cap | `spec/jobs/send_daily_digest_job_library_spec.rb` | `DIG-001` + `DIG-002` contexts (4 tests) |
| Since race protection | `since` flows through deliver_later serialization | `spec/mailers/digest_mailer_library_spec.rb` | `since race protection` (1 test) |
| Both query sites use shared scope | Class method and instance fallback match | `spec/mailers/digest_mailer_library_spec.rb` | `both query sites use shared scope` (1 test) |

## M2: Remove Auto-Processing from Feed Fetch

| Criterion | Description | Test File | Test Block |
|-----------|-------------|-----------|------------|
| TRX-001 | FetchPodcastFeedJob does not enqueue AutoProcessEpisodeJob | `spec/jobs/fetch_podcast_feed_job_no_auto_process_spec.rb` | `TRX-001: does not enqueue transcription on feed fetch` (1 test) |
| TRX-002 | FetchPodcastFeedJob still creates Episode + UserEpisode records | Existing: `spec/jobs/fetch_podcast_feed_job_spec.rb` | Covered by existing tests — episode creation and UserEpisode inbox entry are already tested |
| TRX-003 | ProcessEpisodeJob continues to work as-is | Existing: `spec/jobs/process_episode_job_spec.rb` | Covered by existing tests — no changes to this pathway |
| TRX-004 | DetectStuckProcessingJob: UserEpisode only, Episode detection removed | `spec/jobs/detect_stuck_processing_job_library_spec.rb` | `TRX-004: does not detect stuck Episodes` (3 tests) |
| CLN-001 | AutoProcessEpisodeJob and specs deleted | N/A | File deletion verified by Stage 5; no automated test needed |
| CLN-002 | Episode-level columns remain in schema | N/A | Schema preservation verified by existing model specs; no migration means no change |

## M3: QA Test Data

| Criterion | Description | Test File | Test Block |
|-----------|-------------|-----------|------------|
| Seed task exists | `lib/tasks/pipeline/library_scoped_processing_qa.rake` | N/A | Rake task creation verified by manual execution — QA seed tasks are inherently manual tools |
| Task creates test user | digest_enabled + digest_sent_at | N/A | Verified by running `rake pipeline:library_scoped_processing_qa` |
| Task seeds episodes in various states | inbox, library+ready, library+pending, library+error, archived | N/A | Verified by running seed task and inspecting output |
| Task seeds 24-hour boundary episodes | updated_at older/newer than 24 hours | N/A | Verified by running seed task and inspecting output |
| Task is idempotent | Can re-run without duplicates | N/A | Verified by running seed task twice |
| Task prints summary | User email, podcast names, episode counts | N/A | Verified by observing task output |

## M4: Edge Cases & Polish

| Criterion | Description | Test File | Test Block |
|-----------|-------------|-----------|------------|
| Already transcribed episode | ProcessEpisodeJob skips API calls | Existing: `spec/jobs/process_episode_job_spec.rb` | Already tested — "skips transcription and summarization when both exist" |
| Archive during processing | Processing continues to completion | Existing: `spec/jobs/process_episode_job_spec.rb` | Already tested — job operates on UserEpisode ID, doesn't re-check location |
| Legacy auto-transcribed episodes | Existing transcripts/summaries preserved | N/A | Data preservation — no code change means no test needed |
| DetectStuckProcessingJob after removal | Legacy episode rows not touched, no errors | `spec/jobs/detect_stuck_processing_job_library_spec.rb` | `M4: legacy episode-level stuck records are not touched` (1 test) |
| No AutoProcessEpisodeJob references | Grep confirmation in runtime code | N/A | Manual verification: `grep -r AutoProcessEpisodeJob app/ config/ lib/ spec/` |
| All specs pass | `bundle exec rspec` | N/A | Meta-criterion — verified after Stage 5 implementation |

---

## Summary

| Metric | Count |
|--------|-------|
| **New test files** | 5 |
| **New test cases** | 33 |
| **Acceptance criteria covered by new tests** | 18 |
| **Acceptance criteria covered by existing tests** | 5 (TRX-002, TRX-003, M4 edge cases) |
| **Criteria verified manually** | 9 (M3 rake task, CLN-001/002, M4 grep/suite) |
| **Total acceptance criteria** | 32 |
