---
pipeline_stage: 7
pipeline_stage_name: qa-plan
pipeline_project: "library-scoped-processing"
pipeline_started_at: "2026-02-17T10:56:53-0500"
pipeline_completed_at: "2026-02-17T11:03:10-0500"
---

# QA Plan — Library-Scoped Processing

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-17
> **Branch:** `pipeline/library-scoped-processing`
> **PR:** TBD
> **Gameplan:** `pipeline-projects/library-scoped-processing/gameplan.md`
> **Progress:** `pipeline-projects/library-scoped-processing/progress.md`

---

## 1. Feature Summary

This project reverts email digests and transcription to only operate on episodes the user has explicitly added to their library, rather than all episodes from subscribed podcasts. The digest email now queries `user_episodes` in the library with `processing_status: ready`, auto-transcription on feed fetch has been removed (`AutoProcessEpisodeJob` deleted), and Episode-level stuck detection has been removed from `DetectStuckProcessingJob`.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Shared Scope & Digest Query Change | `b65d265` |
| M2 | Remove Auto-Processing from Feed Fetch | `67e0c25` |
| M3 | QA Test Data | `f282dcc` |
| M4 | Edge Cases & Polish | `fad60cb` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests** | 500 |
| **Passing** | 499 |
| **Failing** | 1 (known spec gap — TRX-001) |
| **Test files** | 5 new + pre-existing updated |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Model spec | `spec/models/episode_library_scope_spec.rb` | 14 | `Episode.library_ready_since` scope — location filtering, processing_status, updated_at, 24-hour cap, ordering |
| Mailer spec | `spec/mailers/digest_mailer_library_spec.rb` | 15 | DigestMailer library filtering, subject line, NullMail, race protection, both query sites |
| Job spec | `spec/jobs/send_daily_digest_job_library_spec.rb` | 4 | SendDailyDigestJob library-scoped eligibility, inbox exclusion, 24-hour cap |
| Job spec | `spec/jobs/fetch_podcast_feed_job_no_auto_process_spec.rb` | 1 | TRX-001 (has spec gap — NameError on deleted constant) |
| Job spec | `spec/jobs/detect_stuck_processing_job_library_spec.rb` | 5 | Episode detection removed, legacy records not touched |

### What Automated Tests Verify
- `Episode.library_ready_since` scope correctly filters by library location, ready status, and updated_at window
- Digest email only includes library episodes (inbox, archive, trash excluded)
- 24-hour cap prevents stale backlogs when `digest_sent_at` is nil or very old
- `NullMail` returned when no eligible episodes exist
- Subject line uses library-centric framing ("Your library — N episodes ready")
- `since` race protection preserved through `deliver_later` serialization
- `SendDailyDigestJob` uses library-scoped eligibility check
- `DetectStuckProcessingJob` no longer detects Episode-level stuck records
- `FetchPodcastFeedJob` creates episodes and inbox entries without auto-processing
- All pre-existing digest and mailer specs updated and passing

---

## 3. Test Data Setup

### Seed Command

```bash
cd /Users/dave/projects/show-notes
bundle exec rake pipeline:library_scoped_processing_qa
```

### Scenarios Seeded

| Scenario | User | Data Created | Purpose |
|----------|------|--------------|---------|
| Library + ready (recent) | library-qa@example.com | 3 episodes (Show A x2, Show B x1) with summaries, `updated_at` 1-6 hours ago | Should appear in digest |
| Library + ready (old >24h) | library-qa@example.com | 1 episode with summary, `updated_at` 26 hours ago | Should NOT appear (24-hour cap) |
| Library + pending | library-qa@example.com | 1 episode, `processing_status: pending` | Should NOT appear (not ready) |
| Library + error | library-qa@example.com | 1 episode, `processing_status: error` | Should NOT appear (not ready) |
| Inbox only | library-qa@example.com | 2 episodes in inbox | Should NOT appear (not in library) |
| Archived | library-qa@example.com | 1 episode in archive with summary | Should NOT appear (not in library) |

### Post-Seed Verification
- [ ] Run `SendDailyDigestJob.perform_now` and check letter_opener
- [ ] Verify exactly 3 episodes appear in the digest email
- [ ] Verify episodes are grouped by show (Show A, Show B)
- [ ] Verify subject line reads "Your library — 3 episodes ready"

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Digest Email — Content & Filtering

#### QA-001: Digest contains only library-ready episodes
**Criteria:** DIG-001, DIG-002
**Steps:**
1. Run `bundle exec rake pipeline:library_scoped_processing_qa` to seed test data
2. Run `SendDailyDigestJob.perform_now` in the Rails console
3. Open letter_opener to view the generated digest email

**Expected:** Exactly 3 episodes appear: "Show A — Ready Recent 1", "Show A — Ready Recent 2", "Show B — Ready Recent 1". No inbox, pending, error, archived, or old (>24h) episodes are present.

---

#### QA-002: Digest subject line is library-centric
**Criteria:** DIG-003
**Steps:**
1. After QA-001, check the email subject line in letter_opener

**Expected:** Subject reads "Your library — 3 episodes ready". Does NOT say "Your podcasts this morning" or "new episodes".

---

#### QA-003: Digest heading and body copy are library-centric
**Criteria:** DIG-003
**Steps:**
1. After QA-001, check the HTML email body in letter_opener

**Expected:** Heading says "Your library". Subheading says "3 episodes ready". No references to "podcasts this morning" or "new episodes" in any copy.

---

#### QA-004: Digest groups episodes by show
**Criteria:** DIG-001
**Steps:**
1. After QA-001, check the HTML email body in letter_opener

**Expected:** Episodes are grouped under "BUILD YOUR SAAS" (or Show A title) and "SHOW B" (or Show B title) headings. The two Show A episodes appear together, the Show B episode appears under its own heading.

---

#### QA-005: No digest sent when no eligible episodes
**Criteria:** DIG-004
**Steps:**
1. In Rails console: `User.find_by(email: 'library-qa@example.com').update!(digest_sent_at: Time.current)`
2. Run `SendDailyDigestJob.perform_now`
3. Check letter_opener

**Expected:** No new digest email is generated (all library-ready episodes now have `updated_at` before `digest_sent_at`).

---

#### QA-006: 24-hour cap prevents stale backlogs
**Criteria:** DIG-002
**Steps:**
1. In Rails console: `User.find_by(email: 'library-qa@example.com').update!(digest_sent_at: 5.days.ago)`
2. Run `SendDailyDigestJob.perform_now`
3. Check letter_opener

**Expected:** Only the 3 episodes with `updated_at` within the last 24 hours appear. The episode with `updated_at: 26.hours.ago` does NOT appear despite `digest_sent_at` being 5 days old.

---

#### QA-007: Singular form for 1 episode
**Criteria:** DIG-003
**Steps:**
1. In Rails console, archive all but one library-ready episode (leaving only one with `updated_at` within 24 hours)
2. Reset `digest_sent_at` to 2 hours ago
3. Run `SendDailyDigestJob.perform_now`
4. Check letter_opener

**Expected:** Subject reads "Your library — 1 episode ready" (singular, no "s").

---

### 4.2 Feed Fetch — No Auto-Processing

#### QA-008: New episodes land in inbox without transcription
**Criteria:** TRX-001, TRX-002
**Steps:**
1. In Rails console: trigger `FetchPodcastFeedJob.perform_now(podcast_id)` for a subscribed podcast
2. Check newly created episodes

**Expected:** New Episode and UserEpisode records created. UserEpisode has `location: :inbox`, `processing_status: :pending`. No `ProcessEpisodeJob` or `AutoProcessEpisodeJob` enqueued.

---

#### QA-009: Existing feed fetch behavior preserved
**Criteria:** TRX-002
**Steps:**
1. In Rails console: trigger `FetchPodcastFeedJob.perform_now(podcast_id, initial_fetch: true)` for a new podcast
2. Check episode count

**Expected:** Up to 10 episodes created (initial_fetch limit). Each has a corresponding UserEpisode inbox entry.

---

### 4.3 Library Processing Flow

#### QA-010: Moving episode to library triggers processing
**Criteria:** TRX-003
**Steps:**
1. Find an inbox episode: `ue = UserEpisode.where(location: :inbox).first`
2. Run `ue.move_to_library!`
3. Check Solid Queue for enqueued jobs

**Expected:** `ProcessEpisodeJob` is enqueued. UserEpisode now has `location: :library`, `processing_status: :pending`.

---

#### QA-011: ProcessEpisodeJob completes successfully
**Criteria:** TRX-003
**Steps:**
1. After QA-010, allow `ProcessEpisodeJob` to run (or run manually)
2. Reload the UserEpisode

**Expected:** `processing_status` transitions through `transcribing` → `summarizing` → `ready`. Transcript and Summary records created. Episode now eligible for next digest.

---

### 4.4 Stuck Detection

#### QA-012: Stuck UserEpisode detection still works
**Criteria:** TRX-004
**Steps:**
1. Create a UserEpisode stuck in `transcribing` state with `updated_at` > 30 minutes ago
2. Run `DetectStuckProcessingJob.perform_now`

**Expected:** UserEpisode transitions to `error` state with processing_error containing "timed out".

---

#### QA-013: Legacy Episode-level stuck records are ignored
**Criteria:** M4 edge case
**Steps:**
1. If any Episode records exist with `processing_status: :transcribing` (legacy from before this change), run `DetectStuckProcessingJob.perform_now`

**Expected:** Job completes without errors. Episode-level records are NOT touched — only UserEpisodes are checked.

---

### 4.5 Cleanup Verification

#### QA-014: No AutoProcessEpisodeJob references remain
**Criteria:** CLN-001, M4 verification
**Steps:**
1. Run: `grep -r AutoProcessEpisodeJob app/ config/ lib/`

**Expected:** Zero results. No references to the deleted class in runtime code.

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Episode already transcribed when moved to library | Create episode with existing Transcript + Summary, move to library, run ProcessEpisodeJob | Job skips API calls, marks ready immediately | TRX-003 |
| 2 | Episode archived during processing | Move to library, start processing, archive before completion | Processing continues to completion (job uses UserEpisode ID, doesn't re-check location) | M4 edge case |
| 3 | First-ever digest (digest_sent_at is nil) | Set user.digest_sent_at to nil, create library-ready episode | Digest sent using 24-hour window as fallback | DIG-002 |
| 4 | Episode with processing_status: ready but no Summary | Create UserEpisode in library with ready status, no Summary record | Episode appears in digest with "Summary processing..." note | DIG-008 |
| 5 | Pre-existing auto-transcribed episodes | Check episodes transcribed before this change | Existing transcripts and summaries remain intact on Episode model | CLN-002 |

---

## 6. Known Limitations

| Item | Status | Notes |
|------|--------|-------|
| TRX-001 spec gap | Known | Stage 4 test references deleted `AutoProcessEpisodeJob` constant — causes NameError. Criterion verified in code (class and call site removed). Cannot fix without modifying Stage 4 test file. |
| Episode-level processing columns remain | By design (CLN-002) | `processing_status`, `processing_error`, `last_error_at` columns stay on `episodes` table for backward compatibility with legacy data. No migration to remove them. |
| No feature flag | By design | Single-user personal app — direct deploy, no flag needed. Rollback requires code revert. |
| Inbox processing indicators | Deferred | Inbox episodes will mostly show "pending" status. UX decision for indicating "not yet processed" is out of scope for this project. |
| Retroactive un-transcription | Out of scope | Episodes auto-processed before this change keep their transcripts/summaries. No cleanup needed. |

---

## 7. Regression Concerns

| Area | Risk | What to Check |
|------|------|---------------|
| Digest email delivery | Med | Verify digest is actually sent (not silently skipped) when library episodes exist. The query path changed completely. |
| Digest email tracking | Low | EmailEvent open/click tracking unchanged, but verify tracking pixel and redirect links still work in the new email. |
| Feed fetch job | Low | Verify episodes still land in inbox correctly after removing AutoProcessEpisodeJob call. |
| ProcessEpisodeJob | Low | Unchanged, but verify no regressions since it shares the UserEpisode model with the changed digest query. |
| OPML import flow | Low | `OpmlImportService.process_favorites` still creates library UserEpisodes and enqueues ProcessEpisodeJob. Unrelated to this change but touching the same models. |
| Stuck detection job | Low | Verify it still catches stuck UserEpisodes after removing the Episode detection block. |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | N/A — no feature flag | Rollback requires reverting the branch merge |
| Code revert | `git revert <merge-commit>` on main | Restores subscription-based digest, AutoProcessEpisodeJob, Episode stuck detection |
| Migration | None needed | No schema changes were made |
| Data cleanup | None needed | No new data structures; existing data is unaffected by rollback |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified
- [ ] Edge cases tested
- [ ] Regression areas checked
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
