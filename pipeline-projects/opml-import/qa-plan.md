# QA Plan — OPML Import

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-07
> **Branch:** `pipeline/opml-import`
> **PR:** TBD
> **Gameplan:** `opml-import/gameplan.md`
> **Progress:** `opml-import/progress.md`

---

## 1. Feature Summary

OPML Import is a one-time onboarding flow that lets new Show Notes users import their podcast subscriptions from apps like Overcast, Apple Podcasts, and Pocket Casts via OPML file upload. After uploading, users select their favorite podcasts, and the system processes the latest episode from each favorite in the background — so their first digest email arrives the next morning with real content. The feature is accessible from the dashboard empty state and the Settings page, supports re-import (skipping duplicates), and includes file size validation and a select-all/deselect-all toggle.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | OPML Parsing & Import Service | `8e871ab` |
| M2 | Import Controller & Views | `0a439b0` |
| M3 | Entry Points & Integration | `53e3d9d` |
| M4 | QA Test Data | `7e685eb` |
| M5 | Edge Cases & Polish | `94e7c3c` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests** | 61 (feature-specific) / 311 (full suite) |
| **Passing** | 60 / 310 |
| **Failing** | 1 (pre-existing test design issue — not an implementation bug) |
| **Test files** | 3 |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Service specs | `spec/services/opml_parser_spec.rb` | 11 | OPML parsing: valid files, nested folders, malformed XML, empty feeds, duplicates, title fallback |
| Service specs | `spec/services/opml_import_service_spec.rb` | 25 | Subscribe all (create, skip, fail), process favorites (episode creation, UserEpisode, job enqueue, error handling) |
| Request specs | `spec/requests/imports_spec.rb` | 24 | All 4 controller actions, authentication, file upload, error handling, favorites processing, confirmation page |

### What Automated Tests Verify
- OPML parsing: valid files extract feed URLs and titles; nested folders flatten; malformed XML and empty feeds raise distinct errors; duplicate feed URLs are deduplicated
- Subscribe all: creates Podcast + Subscription records; skips already-subscribed feeds; continues past failures and reports them
- Process favorites: fetches latest episode via RSS, creates Episode + UserEpisode, enqueues ProcessEpisodeJob; skips non-selected podcasts; handles feed parser errors gracefully
- Controller: authentication required on all actions; file upload, no-file, and malformed-file error paths; favorites selection with minimum 1 required; confirmation page with digest promise
- Re-import: uploading again skips already-subscribed feeds

### Pre-existing Test Issue
- `opml_import_service_spec.rb:203` uses `have_been_enqueued` (cumulative matcher) instead of block-form `expect { }.to have_enqueued_job`. Fails when run as part of the full file because a prior example's enqueued jobs leak. Passes in isolation. This is a Stage 4 test design issue, not an implementation bug.

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/show-notes
bundle exec rake pipeline:seed_opml_import
```

### Scenarios Seeded

| Scenario | User | Data Created | Purpose |
|----------|------|--------------|---------|
| Fresh user with pre-existing subs | `pipeline-test-opml@example.com` | User + magic link, 2 pre-existing subscriptions (The Daily, Acquired) | Test dedup on import — these feeds appear in valid_podcasts.opml and large_import.opml |
| Happy path (3 feeds) | Same user | `spec/fixtures/files/valid_podcasts.opml` | Standard import with 3 feeds, 2 of which overlap with pre-existing subs |
| Nested folders (5 feeds) | Same user | `spec/fixtures/files/nested_folders.opml` | Verifies folder structure is flattened |
| Large import (12 feeds) | Same user | `spec/fixtures/files/large_import.opml` | 12 feeds in 4 nested folders (Technology, Business, News, Science); tests 10+ feed display |
| Empty feeds | Same user | `spec/fixtures/files/empty_feeds.opml` | Valid OPML with zero podcast feeds — tests error handling |
| Duplicate feeds | Same user | `spec/fixtures/files/duplicate_feeds.opml` | OPML with duplicate feed URLs — tests dedup at parse level |

### Post-Seed Verification
- [ ] Run `bundle exec rake pipeline:seed_opml_import` — prints user email, magic link URL, subscription count, OPML file paths
- [ ] Open the magic link URL in browser — should log you in as the test user
- [ ] Navigate to `/inbox` — should see the empty state with "Import your podcasts" CTA (if no episodes yet)

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Import Entry Points

#### QA-001: Dashboard empty state shows import CTA
**Criteria:** IMP-001
**Steps:**
1. Run the seed task to get a fresh magic link
2. Log in as the test user
3. Navigate to `/inbox`
4. If the user has no episodes in their inbox, observe the empty state

**Expected:** Empty state includes an "Import your podcasts" button/link that navigates to `/import/new`. The existing "Find Podcasts" link should also still be present.

---

#### QA-002: Settings page shows import link
**Criteria:** IMP-001
**Steps:**
1. Log in as the test user
2. Navigate to `/settings`
3. Scroll to the "Import Podcasts" section

**Expected:** Settings page has an "Import Podcasts" section below the Save Settings button, with descriptive text and a link to `/import/new`.

---

### 4.2 OPML Upload

#### QA-003: Upload page shows generic instructions
**Criteria:** IMP-002
**Steps:**
1. Navigate to `/import/new`

**Expected:** Page displays generic export instructions (e.g., "Export your OPML file from your podcast app and upload it here") and a file picker. No app-specific instructions.

---

#### QA-004: Upload valid OPML file (happy path)
**Criteria:** IMP-003, IMP-004, IMP-005, IMP-006
**Steps:**
1. Navigate to `/import/new`
2. Upload `spec/fixtures/files/valid_podcasts.opml` (3 feeds, 2 overlap with pre-existing subs)

**Expected:**
- Redirects to favorites selection page
- Shows "We found 3 podcasts!" (total from OPML, including pre-existing)
- Shows "2 were already in your library" (The Daily + Acquired)
- Displays podcast names in a grid
- Existing podcasts show artwork (if available); new podcasts show a placeholder icon

---

#### QA-005: Upload large OPML file (12 feeds, nested folders)
**Criteria:** IMP-004, IMP-006, nested folder flattening
**Steps:**
1. Navigate to `/import/new`
2. Upload `spec/fixtures/files/large_import.opml`

**Expected:**
- Page loads within a few seconds (no noticeable delay)
- Shows "We found 12 podcasts!" (or appropriate count accounting for pre-existing)
- All feeds from nested folders (Technology, Business, News, Science) are displayed in a flat grid
- No folder hierarchy visible — all podcasts at the same level

---

#### QA-006: Upload empty OPML file (zero podcast feeds)
**Criteria:** IMP-007
**Steps:**
1. Navigate to `/import/new`
2. Upload `spec/fixtures/files/empty_feeds.opml`

**Expected:** Flash error message indicating no podcast feeds were found. Redirects back to `/import/new` for re-upload.

---

#### QA-007: Upload with no file selected
**Criteria:** Controller validation
**Steps:**
1. Navigate to `/import/new`
2. Click submit without selecting a file

**Expected:** Flash error: "Please select a file to upload". Redirects back to `/import/new`.

---

#### QA-008: Upload file exceeding 1MB
**Criteria:** M5 file size limit
**Steps:**
1. Create a text file larger than 1MB (e.g., `dd if=/dev/zero of=/tmp/large.opml bs=1024 count=1025`)
2. Navigate to `/import/new`
3. Upload the oversized file

**Expected:** Flash error: "File is too large (max 1MB). Please upload a smaller OPML file." Redirects back to `/import/new`. The file is NOT read into memory before rejection.

---

### 4.3 Favorites Selection

#### QA-009: Podcast grid with checkboxes
**Criteria:** FAV-001, IMP-005
**Steps:**
1. Upload `large_import.opml` to reach the favorites selection page
2. Inspect the podcast grid

**Expected:**
- Each podcast shown as a card with checkbox, artwork (or placeholder), and title
- Existing podcasts (already in DB) show their artwork image
- New podcasts show a gray placeholder with a music note icon
- Cards are arranged in a responsive grid (1 column on mobile, 2 on tablet, 3 on desktop)

---

#### QA-010: Select-all / deselect-all toggle
**Criteria:** FAV-004
**Steps:**
1. On the favorites selection page, click "Select all"
2. Observe all checkboxes
3. Click the button again (now says "Deselect all")
4. Observe all checkboxes

**Expected:**
- Clicking "Select all" checks all podcast checkboxes; button text changes to "Deselect all"
- Clicking "Deselect all" unchecks all checkboxes; button text changes back to "Select all"
- If some checkboxes are manually unchecked, clicking the button selects all again

---

#### QA-011: Recommended range hint
**Criteria:** FAV-003
**Steps:**
1. On the favorites selection page, look for guidance text

**Expected:** Page shows "Pick 5-10 of your favorites to process right away." No hard cap on selection count.

---

#### QA-012: Cost estimate display
**Criteria:** PRC-002
**Steps:**
1. On the favorites selection page, look at the footer area

**Expected:** Shows "Estimated cost: $0.46 per episode" in the footer near the submit button.

---

#### QA-013: Submit with zero selections
**Criteria:** FAV-002
**Steps:**
1. On the favorites selection page, ensure no checkboxes are checked
2. Click "Process my favorites"

**Expected:** Flash error: "Please select at least one podcast". Redirects to upload page.

---

#### QA-014: Submit with selections (favorites processing)
**Criteria:** PRC-001, PRC-003, PRC-004
**Steps:**
1. Upload `large_import.opml`
2. Select 3-5 podcasts as favorites
3. Click "Process my favorites"

**Expected:** Redirects to confirmation page at `/import/complete`. Page shows "Your first digest arrives tomorrow morning" and includes a link to the dashboard.

---

#### QA-015: Select all 12 podcasts as favorites
**Criteria:** No hard cap (PRD edge case)
**Steps:**
1. Upload `large_import.opml`
2. Click "Select all" to check all podcasts
3. Click "Process my favorites"

**Expected:** Allowed without warning. Cost estimate is the informed consent mechanism. Redirects to confirmation page.

---

### 4.4 Failed Feeds Summary

#### QA-016: Failed feeds display on favorites page
**Criteria:** SUB-004
**Steps:**
1. Create a custom OPML file with 3 valid feeds and 2 feeds using obviously invalid URLs (e.g., `http://invalid.example.com/nonexistent.rss`)
2. Upload this file

**Expected:**
- Favorites selection page shows a collapsed `<details>` element: "We couldn't find N feeds"
- Expanding it shows each failed feed URL and the error reason
- The expandable section does not clutter the main favorites selection grid
- Valid feeds are still shown for selection

---

### 4.5 Re-Import

#### QA-017: Re-import skips already-subscribed feeds
**Criteria:** IMP-006 (re-import), SUB-003
**Steps:**
1. Upload `valid_podcasts.opml` and complete the full flow (select favorites, confirm)
2. Navigate back to `/import/new`
3. Upload `valid_podcasts.opml` again

**Expected:**
- Favorites selection page shows podcast count
- Shows "N were already in your library" reflecting all previously subscribed feeds
- Only new podcasts (if any) can be selected as favorites
- No duplicate Podcast or Subscription records created

---

#### QA-018: Import accessible with existing subscriptions
**Criteria:** IMP-001
**Steps:**
1. After completing an import, navigate directly to `/import/new`

**Expected:** Import page is accessible. Not blocked by having existing subscriptions.

---

### 4.6 Authentication

#### QA-019: Unauthenticated access redirects to root
**Criteria:** Authentication
**Steps:**
1. Open a private/incognito browser window
2. Navigate to `/import/new`

**Expected:** Redirected to the root path (home page). Not shown the import form.

---

### 4.7 Confirmation & Post-Import

#### QA-020: Confirmation page content
**Criteria:** PRC-004
**Steps:**
1. Complete the full import flow (upload → select favorites → confirm)

**Expected:**
- Confirmation page shows "Your first digest arrives tomorrow morning"
- Includes a link back to the dashboard
- Background jobs have been enqueued for selected favorites (visible in Solid Queue dashboard if accessible)

---

### 4.8 Visual & Responsive Design

#### QA-021: Upload page responsive layout
**Criteria:** M5 responsive layout
**Steps:**
1. Open `/import/new` on a desktop browser
2. Resize browser to mobile width (~375px)

**Expected:** Upload form is usable at all viewport sizes. Instructions and file picker adapt cleanly. No horizontal scrolling or clipped content.

---

#### QA-022: Favorites grid responsive layout
**Criteria:** M5 responsive layout
**Steps:**
1. Upload `large_import.opml` to reach favorites page
2. Test at desktop (3 columns), tablet (~768px, 2 columns), and mobile (~375px, 1 column) widths

**Expected:** Grid adapts from 3 columns → 2 columns → 1 column as viewport shrinks. Podcast cards remain legible. Checkboxes are easily tappable on mobile.

---

#### QA-023: Tailwind style consistency
**Criteria:** M5 Tailwind pattern consistency
**Steps:**
1. Navigate through the full import flow
2. Compare card styles, button styles, and layout with existing pages (e.g., `/subscriptions`, `/podcasts/[id]`)

**Expected:** Card borders, shadow, rounded corners, button colors (blue-600 primary), and text styles match the existing Show Notes design. Placeholder artwork uses the same gray-200 background + music note icon pattern as podcast cards elsewhere in the app.

---

#### QA-024: Flash message auto-dismiss
**Criteria:** M5 flash messages
**Steps:**
1. Trigger a flash error (e.g., upload with no file)
2. Observe the flash message

**Expected:** Flash message appears and auto-dismisses after the standard timeout (existing `flash_controller.js` behavior). Message is styled consistently with other flash messages in the app.

---

### 4.9 Artwork Display

#### QA-025: Artwork for existing podcasts
**Criteria:** IMP-005
**Steps:**
1. Ensure the test user has pre-existing subscriptions (seed task creates The Daily and Acquired)
2. Upload an OPML that includes those feeds
3. Observe artwork on favorites selection page

**Expected:** Podcasts that already exist in the database display their `artwork_url` as a 40x40 rounded image. If no artwork URL is present, they show the placeholder.

---

#### QA-026: Placeholder for new podcasts
**Criteria:** IMP-005
**Steps:**
1. Upload an OPML with feeds that are NOT already in the database
2. Observe artwork on favorites selection page

**Expected:** New podcasts display a gray placeholder (40x40 rounded, gray-200 background) with a music note SVG icon — matching the existing placeholder pattern used elsewhere in Show Notes.

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Non-OPML file upload (.pdf, .jpg) | Upload a PDF or image file at `/import/new` | Flash error about unreadable/malformed file, redirect to re-upload | IMP-007 |
| 2 | OPML with only htmlUrl (no xmlUrl) | Upload `empty_feeds.opml` | "No podcast feeds found" error — outlines without `xmlUrl` are not podcasts | IMP-007 |
| 3 | OPML with duplicate feed URLs | Upload `duplicate_feeds.opml` | Duplicate URLs deduplicated at parse time; only unique feeds shown | IMP-004 |
| 4 | User closes browser mid-flow | Upload OPML, reach favorites page, close browser, reopen `/import/new` | No persisted state — user must re-upload. Upload page shown clean. | PRD edge case |
| 5 | Very large selection (all podcasts) | Select all podcasts and submit | Allowed without warning. Cost estimate serves as informed consent. | FAV-003 |
| 6 | File exactly at 1MB boundary | Upload a file that is exactly 1,048,576 bytes | Should be accepted (limit is > 1MB, not >=) | M5 |
| 7 | OPML with XML declaration and encoding | Upload OPML with `<?xml version="1.0" encoding="UTF-8"?>` | Parses normally — Nokogiri handles standard XML declarations | IMP-004 |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| App-specific export instructions | Deferred | PRD says ship with generic instructions; add per-app (Overcast, Apple Podcasts, Pocket Casts) instructions later if users get confused |
| Drag-and-drop upload | Out of scope | Standard file picker only per PRD |
| Real-time progress indicator | Out of scope | "Digest tomorrow" is the promise; no progress UI during background processing |
| Ongoing sync / persistent connection | Out of scope | One-time import only; re-import allowed but not a sync |
| Dynamic cost estimate updating | Not implemented | Gameplan M2 mentioned Stimulus for live cost update as checkboxes toggle; implementation uses static "$0.46 per episode" text instead. Acceptable — flat rate is simple and accurate. |
| Backlog episode processing | Out of scope | Only latest episode from each favorite processed; no historical import |
| Pre-existing queue isolation spec gap | Test design issue | `opml_import_service_spec.rb:203` uses cumulative matcher; passes in isolation, fails in full file. Not an implementation bug. |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| Inbox empty state (`inbox/index.html.erb`) | Low | Verify the existing "Find Podcasts" link still works alongside the new "Import your podcasts" CTA |
| Settings page (`settings/show.html.erb`) | Low | Verify existing settings form (email, timezone, etc.) still saves correctly; new "Import Podcasts" section is below the form |
| Routes (`config/routes.rb`) | Low | Verify existing routes are unaffected — import routes are additive (`resource :import`) |
| Podcast creation (search-subscribe flow) | Low | Verify that subscribing via search still works — unique index on `feed_url` should not conflict since search-subscribe uses `guid` (Podcast Index API ID), not `feed_url`, as the primary lookup |
| Schema (unique index on `podcasts.feed_url`) | Med | Verify that the existing `subscribe` action in `PodcastsController` still works when `feed_url` matches an existing podcast — `find_or_create_by` should handle this gracefully |
| Existing podcast artwork | Low | Verify that podcast show pages and subscription index still display artwork correctly — no changes to artwork rendering outside of import views |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag | Single-user app — rollback requires code revert |
| Migration | Reversible | `remove_index :podcasts, :feed_url, unique: true` — dropping the unique index is safe |
| Code revert | Revert the `pipeline/opml-import` branch | Removes controller, views, services, routes, seed task |
| Data cleanup | Manual if needed | Destroy Podcast, Subscription, Episode, and UserEpisode records created during import. Records are tied to the user and can be identified by creation timestamp or by podcasts whose `guid` matches their `feed_url` (OPML-imported pattern) |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-026)
- [ ] Edge cases tested (7 scenarios)
- [ ] Regression areas checked (6 areas)
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
