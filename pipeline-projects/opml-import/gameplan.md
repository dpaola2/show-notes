# OPML Import - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-07
> **PRD:** `opml-import/prd.md`
> **Discovery Report:** `opml-import/discovery-report.md`
> **Approved Architecture:** `opml-import/architecture-proposal.md`
> **Linear Project:** [Not yet created]

---

## 1. Project Overview

### Goals
- Enable new users to import podcast subscriptions from an OPML file, select favorites, and have the latest episode from each favorite processed — so their first digest email arrives the next morning with real content
- Keep per-user import cost in the $2-5 sweet spot by letting users pick 5-10 favorites

### Scope Summary

| Area | Description | Platform |
|------|-------------|----------|
| OPML Parsing | Parse uploaded OPML files, extract feed URLs + titles | Web |
| Bulk Subscription | Subscribe user to all discovered feeds, skip duplicates | Web |
| Favorites Selection | Let user pick favorites from imported list with cost estimate | Web |
| Favorite Processing | Fetch latest episode from each favorite, enqueue background processing | Web |
| Entry Points | Dashboard empty state CTA + Settings page link | Web |

### Out of Scope
- Ongoing sync — one-time import, not a persistent connection
- Merge UI / duplicate resolution — re-import silently skips already-subscribed feeds
- Backlog processing — only the latest episode from favorites; no historical import
- Drag-and-drop upload — standard file picker only
- Podcast search from import flow — import is file-based only
- Real-time progress indicator — "digest tomorrow" is the promise
- App-specific export instructions — generic text only; add per-app instructions later
- Mobile app import — web only

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (Show Notes repo root)
- No feature flag — single-user app with 5 beta testers; ship directly
- No mid-flow persistence — re-upload takes 10 seconds
- Flat cost estimate (~$0.46/episode) — no feed fetching for duration data during import
- Artwork only for podcasts already in DB; placeholder for new ones

---

## 2. Open Questions & Decisions

> Resolved during Stages 0-2 (PRD + Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| Where does the import entry point live? | Resolved | Dashboard empty state CTA (primary) + Settings page (secondary). No onboarding wizard. |
| Persist parsed OPML state mid-flow? | Resolved | No persistence. Re-upload takes 10 seconds. |
| Allow re-import? | Resolved | Yes — skip duplicates. Users may import from multiple apps. |
| Warn on 15+ favorites selected? | Resolved | No warning. Cost estimate IS the warning — informed consent. |
| Progress indicator during processing? | Resolved | No. "Digest tomorrow" is the promise. |
| Unresolvable feed URLs — inline or summary? | Resolved | Summary at end: "We couldn't find N feeds" with expandable details. |
| Podcast artwork in favorites selection? | Resolved | Show artwork for existing podcasts (already have it). Placeholder for new ones. Zero latency. |
| App-specific OPML export instructions? | Resolved | Ship with generic instructions. Add per-app instructions later if users get confused. |
| Feed fetching for cost estimates? | Resolved | Use flat ~$0.46/episode estimate. No feed fetching during import. |
| Import accessible when user has subscriptions? | Resolved | Always accessible via URL and Settings link. Re-import allowed per PRD. |
| Podcast GUID strategy for OPML imports? | Resolved | Use feed_url as guid for OPML-imported podcasts. Add unique index on `podcasts.feed_url` for dedup. Two guid formats coexist. |

---

## 3. Functional Milestones

> Organized by FEATURE AREA, not by platform.

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented (Stage 1)
- [x] Architecture proposed and **accepted** (Stage 2 + Architecture Review)
- [x] GUID coexistence strategy resolved (feed_url as guid for OPML imports)
- [x] All open questions resolved (Stages 0-2)

---

### M1: OPML Parsing & Import Service
**What:** Migration (unique index on feed_url), OPML parser service, and import service. This milestone delivers the core backend capability — parsing OPML files into feed structs, creating podcast + subscription records in bulk, and processing favorite episodes in the background.

**Size:** S

**Acceptance Criteria:**
- [ ] IMP-004: `OpmlParser.parse(xml_string)` extracts feed URLs and titles from valid OPML
- [ ] IMP-007: `OpmlParser` raises `OpmlParser::Error` for malformed XML and for OPML with zero podcast feeds (distinct error messages)
- [ ] SUB-001: `OpmlImportService.subscribe_all` creates Podcast and Subscription records for all feeds
- [ ] SUB-003: `OpmlImportService.subscribe_all` skips feeds the user is already subscribed to without error
- [ ] SUB-004: `OpmlImportService.subscribe_all` continues past feeds that fail (e.g., invalid feed_url) and reports them in the result
- [ ] PRC-001: `OpmlImportService.process_favorites` fetches the latest episode from each selected podcast's RSS feed and enqueues `ProcessEpisodeJob`
- [ ] PRC-003: Processing happens via `ProcessEpisodeJob` (background, via Solid Queue)
- [ ] PRC-005: Non-selected podcasts are subscribed but no episodes are processed — `subscribe_all` does not enqueue any jobs; only `process_favorites` enqueues `ProcessEpisodeJob`
- [ ] SUB-002: After import, subscribed feeds are polled by `RefreshAllFeedsJob` going forward. No backlog episodes are created during `subscribe_all` (no `initial_fetch`)
- [ ] Unique index on `podcasts.feed_url` prevents duplicate podcast records
- [ ] OPML-imported podcasts use `feed_url` as `guid`; existing search-subscribe podcasts keep their Podcast Index API ID as `guid`
- [ ] Nested OPML folder structures are flattened to a single list of feeds

**Web:**
- [ ] Migration: `add_unique_index_to_podcasts_feed_url` — add unique index on `podcasts.feed_url`
- [ ] Service: `app/services/opml_parser.rb` — parses OPML XML via Nokogiri, returns `Feed` structs, raises `Error` for invalid/empty
- [ ] Service: `app/services/opml_import_service.rb` — `subscribe_all(user, feeds)` and `process_favorites(user, podcast_ids)` class methods
- [ ] Tests: `spec/services/opml_parser_spec.rb` — valid OPML, nested folders, malformed XML, empty feeds, duplicate feed URLs
- [ ] Tests: `spec/services/opml_import_service_spec.rb` — subscribe all (new + duplicate skip + failure handling), process favorites (episode creation, UserEpisode in library, job enqueued)

**iOS:** N/A
**Android:** N/A

**Dependencies:** None (first milestone)

---

### M2: Import Controller & Views
**What:** The full import flow UI — upload form, favorites selection grid with cost estimate, and confirmation page. Controller with 4 actions, 3 views, routes.

**Size:** M

**Acceptance Criteria:**
- [ ] IMP-001: User can initiate import from `/import/new`
- [ ] IMP-002: Upload page shows generic instructions ("Export your OPML file from your podcast app and upload it here")
- [ ] IMP-003: User can upload an OPML file (`.opml` or `.xml` extension) via standard file picker
- [ ] IMP-005: After parsing, system displays discovered podcasts with names and artwork (artwork for existing podcasts; placeholder for new ones)
- [ ] IMP-006: System reports count: "We found N podcasts!" (total from OPML). On re-import, also shows how many were already subscribed (e.g., "We found 27 podcasts! 5 were already in your library.")
- [ ] IMP-007: Malformed/empty OPML files show clear error message via flash and redirect to upload
- [ ] FAV-001: User can select podcasts as favorites from the imported list using checkboxes
- [ ] FAV-002: System requires at least 1 selection before proceeding (inline validation)
- [ ] FAV-003: System shows recommended range ("Pick 5-10 of your favorites") but does not hard-cap the maximum
- [ ] PRC-002: Cost estimate displayed before confirmation: "We'll process N episodes from your favorite shows (~$X.XX)" using flat $0.46/episode
- [ ] PRC-004: Confirmation page shows: "Your first digest arrives tomorrow morning"
- [ ] Controller rejects uploads with no file attached (flash + redirect)

**Web:**
- [ ] Routes: `resource :import, only: [:new, :create]` with `post :process_favorites` and `get :complete` on collection
- [ ] Controller: `app/controllers/imports_controller.rb` — `new`, `create`, `process_favorites`, `complete` actions
- [ ] View: `app/views/imports/new.html.erb` — upload form with generic instructions and file picker
- [ ] View: `app/views/imports/select_favorites.html.erb` — podcast grid with checkboxes, count header, cost estimate footer, confirm button
- [ ] View: `app/views/imports/complete.html.erb` — confirmation message with "Go to dashboard" link
- [ ] Stimulus: JavaScript for live cost estimate update as checkboxes are toggled (count × $0.46)
- [ ] Tests: `spec/requests/imports_spec.rb` — upload valid OPML, upload invalid file, upload with no file, process favorites with selection, process favorites with empty selection, authentication required

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs OpmlParser and OpmlImportService)

---

### M3: Entry Points & Integration
**What:** Wire up the import flow to the existing UI — dashboard (inbox) empty state CTA and Settings page link. Also add the failed feeds summary display.

**Size:** S

**Acceptance Criteria:**
- [ ] IMP-001: Dashboard empty state shows "Import your podcasts" CTA that links to `/import/new`
- [ ] IMP-001: Settings page has an "Import Podcasts" section with link to `/import/new`
- [ ] SUB-004: If any feeds failed during import, the favorites selection page shows a summary: "We couldn't find N feeds" with expandable details (not inline per feed)
- [ ] Re-import works: uploading again skips already-subscribed feeds, imports only new ones
- [ ] Import page is accessible via direct URL even when user has existing subscriptions

**Web:**
- [ ] Modify: `app/views/inbox/index.html.erb` — add "Import your podcasts" CTA in empty state (alongside existing "Find Podcasts" link)
- [ ] Modify: `app/views/settings/show.html.erb` — add "Import Podcasts" section with link
- [ ] Modify: `app/views/imports/select_favorites.html.erb` — add failed feeds summary (collapsed by default) if `@result.failed.any?`
- [ ] Tests: verify inbox empty state includes import link, settings includes import link

**iOS:** N/A
**Android:** N/A

**Dependencies:** M2 (needs import controller and views)

---

### M4: QA Test Data
**What:** Create a seed task that populates realistic test data for manual QA of the import flow. Includes sample OPML files and pre-existing podcast/subscription data to test dedup behavior.

**Size:** S

**Acceptance Criteria:**
- [ ] Rake task exists at `lib/tasks/opml_import_seed.rake`
- [ ] Task creates a test user (if not already present) with known credentials
- [ ] Task includes sample OPML file content (embedded or as a fixture file) covering: standard OPML with 10+ feeds, nested folders, edge case with zero podcast feeds
- [ ] Task creates a few pre-existing Podcast + Subscription records to test duplicate-skip behavior
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary: user email, magic link URL, number of pre-existing subscriptions, path to sample OPML files
- [ ] All manual QA scenarios have supporting test data

**Web:**
- [ ] Seed task: `lib/tasks/opml_import_seed.rake` — idempotent, dev/staging only
- [ ] Fixture files: sample OPML files in `spec/fixtures/files/` (reusable by both specs and seed task)

**iOS:** N/A
**Android:** N/A

**Dependencies:** M3 (needs the full feature implemented)

---

### M5: Edge Cases & Polish
**What:** Handle remaining edge cases from PRD Section 8, add file size validation, and polish the UI.

**Size:** S

**Acceptance Criteria:**
- [ ] File size limit: reject uploads > 1MB with clear error message
- [ ] Large OPML files (100+ feeds) parse and display within acceptable time
- [ ] Select-all / deselect-all convenience buttons (FAV-004 — Nice to have)
- [ ] Artwork placeholder is visually consistent with existing podcast artwork patterns
- [ ] Flash messages use existing `flash_controller.js` pattern for auto-dismiss
- [ ] All Tailwind styles match existing app patterns (cards, buttons, layout)

**Web:**
- [ ] Controller: add file size check in `create` action
- [ ] View: add select-all/deselect-all toggle in favorites selection
- [ ] View: verify responsive layout on mobile viewport
- [ ] Stimulus: wire up select-all/deselect-all toggle to update cost estimate

**iOS:** N/A
**Android:** N/A

**Dependencies:** M3 (needs entry points wired up)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> Reviewed and approved in the Architecture Review checkpoint.

- [x] Architecture proposal approved: `opml-import/architecture-proposal.md` (Status: Accepted)
- [x] Milestones correctly reference the approved data model (unique index on feed_url, guid coexistence)
- [x] No contradictions between gameplan and approved architecture

### Security & Access Control
- [x] All queries scoped to `current_user` (subscriptions, podcasts, user_episodes)
- [x] Controller uses `before_action :require_authentication` (from ApplicationController)
- [x] No feature permissions needed — all authenticated users can import
- [ ] File upload validates type and size (max 1MB, OPML/XML only)
- [x] Nokogiri disables XXE by default — no external entity risk
- [x] No cross-tenant risk (single-user app)

### Performance
- [x] Data volume: 15-30 podcasts per import, 5-10 episodes processed — negligible
- [x] Write-heavy operation (no N+1 read risk in the import itself)
- [x] Unique index on `feed_url` supports efficient `find_or_create_by`
- [x] Caching needed? No
- [x] Background processing via Solid Queue — no request-blocking for episode processing

### Observability & Debuggability
- [x] `OpmlImportService` logs warnings for failed feed fetches (`Rails.logger.warn`)
- [x] `OpmlImportService.subscribe_all` returns structured result (subscribed, skipped, failed counts)
- [x] `ProcessEpisodeJob` already logs transcription and summarization progress
- [x] Debug path: check Solid Queue dashboard for job status, check `user_episodes.processing_status`
- [x] Alerts needed? No — single-user app, Dave will see failures in the digest

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Service specs | OpmlParser (valid/invalid/edge cases), OpmlImportService (subscribe + process) | Rails | Pipeline |
| Request specs | ImportsController (all 4 actions, auth, error handling) | Rails | Pipeline |
| Manual QA | Full import flow, re-import, edge cases, digest delivery | Web | Human |

### Feature Flags & Rollout
- N/A — no feature flag. Single-user app, ship directly.

### Mobile-Specific
- N/A — web-only project.

### Legacy & Migration
- [x] Pre-migration check: verify no duplicate `feed_url` values exist before adding unique index
- [x] Existing search-subscribe flow unaffected — continues using `find_or_create_by!(guid:)`
- [x] Two guid formats coexist without conflict

### Export/Reporting
- N/A — no exports affected. Digest email automatically includes processed episodes from any source.

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| Duplicate `feed_url` values in production database | Med | Pre-migration check: `Podcast.group(:feed_url).having("count(*) > 1").count`. Deduplicate before migrating if any found. |
| RSS feed fetch failures during `process_favorites` | Low | `OpmlImportService` rescues `PodcastFeedParser::Error` per podcast, logs warning, continues with remaining. Digest sends with whatever is ready. |
| Very large OPML file (500+ feeds) | Low | Parse and display all. Nokogiri handles large XML efficiently. Bulk `find_or_create_by` may be slow but acceptable for one-time operation. |
| Podcast Index API rate limits (not applicable) | None | OPML import does NOT call Podcast Index API. All data comes from the OPML file and RSS feeds directly. |
| Solid Queue worker saturation from 5-10 concurrent ProcessEpisodeJobs | Low | Single-user app with in-process Solid Queue. 5-10 jobs is well within capacity. Jobs have exponential backoff for external API rate limits. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | Full import flow (M1-M5) | No flag | All users (5 beta testers) |

### Done Criteria
- [ ] All acceptance criteria met
- [ ] All specs passing (`bundle exec rspec`)
- [ ] Rubocop clean (`bin/rubocop -A`)
- [ ] Brakeman clean (`bin/brakeman --quiet --no-pager --exit-on-warn --exit-on-error`)
- [ ] Manual QA: complete import flow → next-day digest with real content
- [ ] PR created against `main`

---

## 7. Estimates

| Milestone | Size | Notes |
|-----------|------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 0-2 |
| M1: OPML Parsing & Import Service | S | Migration + 2 services + specs |
| M2: Import Controller & Views | M | Controller + 3 views + Stimulus + request specs |
| M3: Entry Points & Integration | S | 2 view modifications + failed feeds summary |
| M4: QA Test Data | S | Rake task + fixture OPML files |
| M5: Edge Cases & Polish | S | File size validation, select-all toggle, responsive polish |

---

## PRD Traceability Matrix

> Every PRD requirement ID mapped to a milestone.

| Requirement | Description | Milestone |
|-------------|-------------|-----------|
| IMP-001 | Prominent entry point in UI | M2 (controller), M3 (empty state + settings) |
| IMP-002 | Generic export instructions | M2 |
| IMP-003 | Upload OPML file (.opml or .xml) | M2 |
| IMP-004 | Parse OPML, extract feed URLs and titles | M1 |
| IMP-005 | Display discovered podcasts with names and artwork | M2 |
| IMP-006 | Report count: "We found N podcasts!" | M2 |
| IMP-007 | Handle malformed/empty OPML with clear error | M1 (parser errors), M2 (controller error handling) |
| FAV-001 | Select 5-10 favorites from imported list | M2 |
| FAV-002 | Enforce minimum 1 selection | M2 |
| FAV-003 | Show recommended range, no hard max | M2 |
| FAV-004 | Select-all / deselect-all | M5 |
| PRC-001 | Process latest episode from each favorite | M1 |
| PRC-002 | Display cost estimate before confirming | M2 |
| PRC-003 | Background processing after confirmation | M1 |
| PRC-004 | Confirmation: "Your first digest arrives tomorrow morning" | M2 |
| PRC-005 | Non-selected podcasts subscribed, no episodes processed | M1 |
| SUB-001 | All imported podcasts added as subscriptions | M1 |
| SUB-002 | Subscriptions poll going forward, no backlog | M1 (subscribe_all creates subscription, no initial_fetch; RefreshAllFeedsJob polls all subscribed feeds) |
| SUB-003 | Duplicate feeds skipped without error | M1 |
| SUB-004 | Unresolvable feeds show warning, don't block import | M1 (service handles failures), M3 (UI summary) |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2/7/2026
### Status: Accepted

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Estimates are realistic
- [x] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-07 | Pipeline | Initial gameplan generated |
