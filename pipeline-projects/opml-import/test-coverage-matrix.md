# Test Coverage Matrix — OPML Import

> Generated by Pipeline Stage 4 (Test Generation)
> Maps every gameplan acceptance criterion to its test location(s).

## Coverage Summary

| Spec File | Test Count | Milestones Covered |
|-----------|------------|-------------------|
| `spec/services/opml_parser_spec.rb` | 10 | M1 |
| `spec/services/opml_import_service_spec.rb` | 19 | M1 |
| `spec/requests/imports_spec.rb` | 22 | M2, M3 |
| **Total** | **51** | |

## Fixture Files Created

| File | Purpose |
|------|---------|
| `spec/fixtures/files/valid_podcasts.opml` | 3-feed standard OPML (happy path) |
| `spec/fixtures/files/nested_folders.opml` | 5 feeds in 2 folders + 1 top-level (folder flattening) |
| `spec/fixtures/files/empty_feeds.opml` | Valid OPML with no podcast feeds (htmlUrl only) |
| `spec/fixtures/files/duplicate_feeds.opml` | OPML with duplicate feed URLs |

## M1: OPML Parsing & Import Service

| Criterion | Description | Test File | Context/It |
|-----------|-------------|-----------|------------|
| IMP-004 | Parse OPML, extract feed URLs and titles | `spec/services/opml_parser_spec.rb` | `"with a valid OPML file containing podcast feeds"` — returns Feed structs, extracts URLs, extracts titles |
| IMP-004 | Title fallback (title attr instead of text) | `spec/services/opml_parser_spec.rb` | `"IMP-004: with title attribute instead of text"` |
| IMP-007 | Malformed XML error | `spec/services/opml_parser_spec.rb` | `"IMP-007: with malformed XML"` |
| IMP-007 | Zero feeds error (distinct message) | `spec/services/opml_parser_spec.rb` | `"IMP-007: with valid XML but no podcast feeds"` |
| IMP-007 | Empty string error | `spec/services/opml_parser_spec.rb` | `"IMP-007: with an empty string"` |
| — | Nested folder flattening | `spec/services/opml_parser_spec.rb` | `"with nested folder structure"` |
| — | Duplicate feed URL dedup | `spec/services/opml_parser_spec.rb` | `"with duplicate feed URLs"` |
| — | Non-podcast outlines skipped | `spec/services/opml_parser_spec.rb` | `"with outlines that have no xmlUrl"` |
| SUB-001 | subscribe_all creates Podcast + Subscription | `spec/services/opml_import_service_spec.rb` | `"SUB-001: creating podcasts and subscriptions"` — creates Podcast records, creates Subscription records, sets guid, sets title, returns Result |
| SUB-003 | Skip already-subscribed feeds | `spec/services/opml_import_service_spec.rb` | `"SUB-003: skipping duplicate feeds"` — no duplicate Podcast, no duplicate Subscription, reports skipped, preserves original guid |
| SUB-004 | Continue past failed feeds | `spec/services/opml_import_service_spec.rb` | `"SUB-004: continuing past feeds that fail"` — continues processing, reports failures |
| PRC-001 | process_favorites fetches latest episode | `spec/services/opml_import_service_spec.rb` | `"PRC-001: fetching and processing latest episode"` — creates Episode, creates UserEpisode in library, sets pending status |
| PRC-003 | Background processing via ProcessEpisodeJob | `spec/services/opml_import_service_spec.rb` | `"PRC-003: background processing"` — enqueues job, passes user_episode id |
| PRC-005 | Non-selected podcasts not processed | `spec/services/opml_import_service_spec.rb` | `"PRC-005: non-selected podcasts"` — does not fetch unselected feed |
| SUB-002 | No backlog — subscribe_all enqueues no jobs | `spec/services/opml_import_service_spec.rb` | `"PRC-005/SUB-002: subscribe_all does not enqueue any jobs"` — no ProcessEpisodeJob, no FetchPodcastFeedJob |
| — | Ignores podcasts not belonging to user | `spec/services/opml_import_service_spec.rb` | `"when the podcast is not subscribed by the user"` |
| — | Handles PodcastFeedParser errors gracefully | `spec/services/opml_import_service_spec.rb` | `"when PodcastFeedParser raises an error"` — continues, logs warning |
| — | Existing episode: no duplicate, still creates UE | `spec/services/opml_import_service_spec.rb` | `"when the episode already exists"` |
| — | Already processed: no re-enqueue | `spec/services/opml_import_service_spec.rb` | `"when the UserEpisode already exists in library and is ready"` |

## M2: Import Controller & Views

| Criterion | Description | Test File | Context/It |
|-----------|-------------|-----------|------------|
| IMP-001 | User can initiate import from /import/new | `spec/requests/imports_spec.rb` | `"IMP-001: user can initiate import"` |
| IMP-002 | Upload page shows generic instructions | `spec/requests/imports_spec.rb` | `"IMP-002: shows generic export instructions"` |
| IMP-003 | Upload OPML file | `spec/requests/imports_spec.rb` | `"IMP-003/IMP-004: uploading a valid OPML file"` |
| IMP-005 | Display discovered podcasts with names | `spec/requests/imports_spec.rb` | `"IMP-005: displays podcast names"` |
| IMP-006 | Report count of discovered podcasts | `spec/requests/imports_spec.rb` | `"IMP-006: displays the count"` |
| IMP-006 | Re-import shows already-subscribed count | `spec/requests/imports_spec.rb` | `"IMP-006: re-import shows already-subscribed count"` |
| IMP-007 | Malformed file shows error and redirects | `spec/requests/imports_spec.rb` | `"IMP-007: uploading a malformed file"` |
| FAV-001 | Checkboxes for podcast selection | `spec/requests/imports_spec.rb` | `"FAV-001: renders checkboxes"` |
| FAV-002 | Minimum 1 selection required | `spec/requests/imports_spec.rb` | `"FAV-002: with empty selection"` — empty array, missing param |
| FAV-003 | Shows recommended range hint | `spec/requests/imports_spec.rb` | `"FAV-003: shows the recommended range hint"` |
| PRC-002 | Cost estimate displayed | `spec/requests/imports_spec.rb` | `"PRC-002: displays cost estimate"` |
| PRC-004 | Confirmation page shows digest promise | `spec/requests/imports_spec.rb` | `"PRC-004: confirmation page"` — renders, shows message, includes dashboard link |
| — | No file uploaded | `spec/requests/imports_spec.rb` | `"when no file is attached"` |
| — | Authentication required (all 4 actions) | `spec/requests/imports_spec.rb` | `"when not authenticated"` blocks in each describe |
| — | Accessible with existing subscriptions | `spec/requests/imports_spec.rb` | `"when user has existing subscriptions"` |
| PRC-001/PRC-003 | process_favorites redirects and enqueues | `spec/requests/imports_spec.rb` | `"PRC-001/PRC-003: processing selected favorites"` |

## M3: Entry Points & Integration

> M3 acceptance criteria for entry points (inbox empty state CTA, settings link) are tested via the request specs above — specifically the "user can initiate import" and "accessible with existing subscriptions" contexts. The failed feeds summary (SUB-004 UI) is covered by the import service spec at the data level; the view assertion will be added during M3 implementation.

## M4: QA Test Data

> Not applicable for automated tests — M4 produces a rake seed task, not testable behavior.

## M5: Edge Cases & Polish

> M5 criteria (file size limit, select-all/deselect-all, responsive layout) are UI-level concerns that will be verified during manual QA. The file size validation can be tested via request spec once implemented; the spec can be added during M5 implementation.

## Criteria NOT Covered by Automated Tests

| Criterion | Reason |
|-----------|--------|
| IMP-005 artwork display | View-level concern — artwork for existing vs placeholder for new. Verified via manual QA. |
| FAV-004 select-all/deselect-all | Stimulus/JavaScript behavior. Verified via manual QA (M5). |
| M5 file size limit | Will add request spec during M5 implementation. |
| M5 responsive layout | Visual concern. Verified via manual QA. |
| M5 Tailwind pattern consistency | Visual concern. Verified via manual QA. |
