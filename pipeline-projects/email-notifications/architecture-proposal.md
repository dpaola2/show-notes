# New User Signup Email Notifications - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** 2026-02-07
> **PRD:** `email-notifications/prd.md`
> **Discovery Report:** `email-notifications/discovery-report.md`

---

## 1. Data Model Changes

No schema changes required. The existing `users` table has all necessary fields:
- `email` — the signing-up user's email (the content of the notification)
- `created_at` — the signup timestamp (included in the notification body)

No new tables, no modified tables, no migrations.

### Rails Models

No model changes. The `User` model (`app/models/user.rb`) is read-only for this feature.

### Detection of New Users

The `SessionsController#create` action uses `User.find_or_create_by!(email:)`, which returns a User record whether it was just created or already existed. To detect new signups (EML-007), use `user.previously_new_record?` immediately after the `find_or_create_by!` call.

`previously_new_record?` is a built-in ActiveRecord method (Rails 6.1+) that returns `true` if the record was just `INSERT`ed by the preceding operation, and `false` if it was `SELECT`ed. This is deterministic — no timing heuristics, no race conditions.

```ruby
user = User.find_or_create_by!(email: @email)

if user.previously_new_record?
  # New signup — send notification
  SignupNotificationMailer.new_signup(user).deliver_later
end
```

---

## 2. API Endpoints

N/A — no API changes. This is a server-side-only feature.

---

## 3. Backwards Compatibility

### Compatibility Matrix

| Feature / Behavior | Web (current) |
|-------------------|:---:|
| Login flow (existing) | Unchanged — no visible change to the user |
| Magic link email (existing) | Unchanged — still sent to the user |
| Signup notification (new) | Internal only — user never sees it |

No API consumers are affected. No client-facing changes.

### API Versioning

N/A — no API changes.

---

## 4. Security Design

### Query Scoping

N/A — no new data access paths. The mailer reads `user.email` and `user.created_at`, which are already available in the controller action that created the user.

### Authorization

N/A — no new user-facing actions. The notification is triggered server-side, not by a user request.

### New Attack Surface

| Vector | Risk | Mitigation |
|--------|------|------------|
| Recipient list manipulation | None — recipients are hardcoded constants, not user input | No dynamic input involved |
| Email content injection | None — email body contains `user.email` (validated by model) and `user.created_at` (system-generated) | Model-level email format validation (`URI::MailTo::EMAIL_REGEXP`) prevents malformed addresses |
| Abuse via rapid signups | Low — an attacker could trigger many notification emails by creating many accounts | Notification volume is bounded by unique email addresses (validated, one-per-user). Resend has built-in rate limiting. Not a new attack surface — the existing magic link email has the same exposure. |

---

## 5. Export Impact

N/A — no export changes.

---

## 6. Implementation Design

### New Mailer: `SignupNotificationMailer`

A new mailer class, separate from `UserMailer` (which handles user-facing auth emails). This mailer sends to internal recipients, not to the signing-up user.

```ruby
# app/mailers/signup_notification_mailer.rb
class SignupNotificationMailer < ApplicationMailer
  RECIPIENTS = [
    "dpaola2@gmail.com",
    "dpaola2-ceo@agentmail.to"
  ].freeze

  def new_signup(user)
    @user = user
    @signed_up_at = user.created_at

    mail(
      to: RECIPIENTS,
      subject: "New Show Notes signup: #{user.email}"
    )
  end
end
```

**Design decisions:**
- **Separate mailer class** (not a method on `UserMailer`) — `UserMailer` sends to the user; `SignupNotificationMailer` sends to internal admins. Different audiences, different concerns.
- **`RECIPIENTS` constant** — per CFG-001, hardcoded in the mailer class. No ENV var, no database table. To change recipients, change the constant and deploy.
- **`mail(to: RECIPIENTS)`** — ActionMailer accepts an array for `to:`, sending one email with multiple recipients (not separate emails per recipient).
- **Subject format** — `"New Show Notes signup: #{user.email}"` per EML-003. The user's email in the subject line makes inbox scanning fast.

### Mailer Views

Two templates (HTML + text), following the existing multipart pattern used by `UserMailer` and `DigestMailer`.

**HTML template** (`app/views/signup_notification_mailer/new_signup.html.erb`):
- Inline CSS (same approach as `magic_link.html.erb`)
- Shows: user email, signup timestamp
- Simple layout — no action buttons needed (this is informational)

**Text template** (`app/views/signup_notification_mailer/new_signup.text.erb`):
- Plain text fallback
- Same content: user email, signup timestamp

### Controller Integration

Modify `SessionsController#create` to trigger the notification after a new user is created:

```ruby
# app/controllers/sessions_controller.rb
def create
  @email = params[:email]&.downcase&.strip

  if @email.blank?
    flash.now[:alert] = "Please enter your email address"
    render :new, status: :unprocessable_entity
    return
  end

  user = User.find_or_create_by!(email: @email)
  token = user.generate_magic_token!

  # Notify internal team of new signups
  if user.previously_new_record?
    SignupNotificationMailer.new_signup(user).deliver_later
  end

  UserMailer.magic_link(user, token).deliver_later

  redirect_to magic_link_sent_path, notice: "Check your email for a login link"
rescue ActiveRecord::RecordInvalid => e
  flash.now[:alert] = "Invalid email address"
  render :new, status: :unprocessable_entity
end
```

**Error handling (EML-006):** `deliver_later` enqueues the job asynchronously via Solid Queue. The `mail()` call itself happens in the background worker, not in the controller action. If the mailer has a coding error (missing template, bad constant), the Solid Queue job fails — the user's login flow is unaffected. No explicit `rescue` is needed around the `deliver_later` call because it only enqueues; it doesn't execute the mailer inline.

**Placement:** The notification call is placed *before* the magic link email. Both use `deliver_later`, so ordering in the controller doesn't determine delivery order — but logically, the notification is a side effect of user creation and belongs near the `find_or_create_by!` call.

---

## 7. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | Should `mail(to:)` use an array (one email, multiple recipients in the To field) or send separate emails per recipient? | A: Single email with array `to:` (recipients see each other) / B: Iterate and send one email per recipient (recipients don't see each other) | **A: Single email with array.** Simpler. Only 2 internal recipients who know each other. No privacy concern. If recipient list grows or includes external parties, switch to B. |

---

## 8. Alternatives Considered

### Alternative 1: Model Callback Instead of Controller Trigger

**Description:** Use an `after_create` callback on the `User` model to send the notification.
**Pros:** Catches all user creation paths (console, seed, admin, controller).
**Cons:** Fires for console/seed operations (undesirable per PRD Section 8). Couples mailer delivery to the model layer. Makes testing harder (every test that creates a user triggers mailer logic). Model callbacks are generally discouraged for side effects in Rails convention.
**Why rejected:** PRD explicitly recommends controller-level only. The team wants notifications only for web signup flow, not console/seed operations.

### Alternative 2: Add `new_signup` Method to Existing `UserMailer`

**Description:** Add a `new_signup(user)` method to `UserMailer` instead of creating a new mailer class.
**Pros:** One fewer file. Keeps all user-related emails in one place.
**Cons:** Mixes concerns — `UserMailer` currently sends emails *to* users (magic links). The signup notification sends *about* users to admins. Different audience, different purpose.
**Why rejected:** Separate mailer class preserves single-responsibility. Follows the existing pattern where each mailer has a distinct audience (`UserMailer` → users, `DigestMailer` → users, `SignupNotificationMailer` → admins).

### Alternative 3: Detect New User via `created_at` Timestamp

**Description:** Instead of `previously_new_record?`, check `user.created_at > 1.second.ago` to detect new signups.
**Pros:** Works in older Rails versions.
**Cons:** Timing-based heuristic — could produce false positives if the clock skews, or false negatives under heavy load. Not deterministic.
**Why rejected:** `previously_new_record?` is the standard Rails idiom for this exact use case. Available since Rails 6.1, and Show Notes is on Rails 8.1. No reason to use a less precise approach.

---

## 9. Summary

### Files to Create
| File | Purpose |
|------|---------|
| `app/mailers/signup_notification_mailer.rb` | Mailer class with `RECIPIENTS` constant and `new_signup` method |
| `app/views/signup_notification_mailer/new_signup.html.erb` | HTML email template |
| `app/views/signup_notification_mailer/new_signup.text.erb` | Plain text email template |

### Files to Modify
| File | Changes |
|------|---------|
| `app/controllers/sessions_controller.rb` | Add `previously_new_record?` check and `SignupNotificationMailer.new_signup(user).deliver_later` call (3 lines) |

### Files NOT Changed
| File | Why |
|------|-----|
| `app/models/user.rb` | No model changes — no callbacks, no new methods |
| `config/routes.rb` | No new routes — no user-facing endpoints |
| `db/migrate/` | No migrations — no schema changes |

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: Dave
### Date: 2/7/2026
### Status: Accepted

#### Must Verify
- [x] Detection strategy (`previously_new_record?`) is correct for the `find_or_create_by!` pattern
- [x] Separate mailer class is the right choice (vs. method on `UserMailer`)
- [x] Controller-level trigger is correct (not model callback)
- [x] Recipient list (`dpaola2@gmail.com`, `dpaola2-ceo@agentmail.to`) is correct
- [x] Error isolation is sufficient (`deliver_later` won't block login flow)

#### Should Check
- [x] Email subject format is acceptable: `"New Show Notes signup: {email}"`
- [x] Single email with array `to:` is acceptable (vs. separate emails per recipient)
- [x] No additional context needed in the email body beyond email + timestamp

#### Notes
[Reviewer notes, modifications requested, or rejection reasons]
