# New User Signup Email Notifications - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-07
> **PRD:** `email-notifications/prd.md`
> **Discovery Report:** `email-notifications/discovery-report.md`
> **Approved Architecture:** `email-notifications/architecture-proposal.md`

---

## 1. Project Overview

### Goals
- Internal team receives an email notification within minutes of each new user signup
- Notification includes the user's email address and signup timestamp
- Notification delivery never interferes with the user's login flow

### Scope Summary

| Description | Platform |
|-------------|----------|
| New `SignupNotificationMailer` class with `new_signup` method | Web (Rails) |
| HTML + text email templates | Web (Rails) |
| Controller integration in `SessionsController#create` | Web (Rails) |
| Mailer spec | Web (Rails) |
| Request spec update | Web (Rails) |
| QA seed task | Web (Rails) |

### Out of Scope
- Admin UI for managing notification recipients
- User-facing welcome/confirmation emails
- SMS or push notification channels
- Notification preferences or unsubscribe functionality
- Analytics or delivery tracking
- Notifications for actions other than signup

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (Show Notes repo root)
- Level 1 project — web only, no API/iOS/Android changes
- Follow existing mailer patterns (`UserMailer`, `DigestMailer`)

---

## 2. Open Questions & Decisions

> Resolved during Stages 1-2 (Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| How to detect new vs. returning user with `find_or_create_by!`? | Resolved | Use `user.previously_new_record?` (Rails 6.1+) |
| New mailer class or method on `UserMailer`? | Resolved | Separate `SignupNotificationMailer` — different audience (admins vs. users) |
| Model callback or controller trigger? | Resolved | Controller-level only — notifications fire only from web login flow |
| Recipient list storage? | Resolved | `RECIPIENTS` constant in mailer class — hardcoded, per CFG-001 |
| Single email or per-recipient emails? | Resolved | Single email with array `to:` — 2 internal recipients who know each other |
| Error handling approach? | Resolved | `deliver_later` enqueues async — failures don't block login flow |

No open questions remain.

---

## 3. Functional Milestones

> Organized by FEATURE AREA, not by platform.

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented — existing mailers, SessionsController, User model (Stage 1)
- [x] Architecture proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Signup Notification Mailer & Controller Integration
**What:** Create the `SignupNotificationMailer` with HTML+text templates, integrate the trigger in `SessionsController#create`, and add tests for both the mailer and the controller integration.

**Acceptance Criteria:**
- [ ] EML-001: When a new user is created via the login flow, an email notification is sent to all configured recipients
- [ ] EML-002: The recipient list includes `dpaola2@gmail.com` and `dpaola2-ceo@agentmail.to`
- [ ] EML-003: The email subject is `"New Show Notes signup: {user email}"`
- [ ] EML-004: The email body includes the user's email address and signup timestamp
- [ ] EML-005: Email delivery is asynchronous via `deliver_later` (Solid Queue)
- [ ] EML-006: If email delivery fails, the failure does not prevent the user from completing login
- [ ] EML-007: Notification fires only for newly created users, not for existing users logging in again
- [ ] CFG-001: The recipient list is defined as a `RECIPIENTS` constant in the mailer class

**Web/Rails:**
- [ ] Create `app/mailers/signup_notification_mailer.rb` — `RECIPIENTS` constant, `new_signup(user)` method, `mail(to: RECIPIENTS, subject:)` call
- [ ] Create `app/views/signup_notification_mailer/new_signup.html.erb` — inline CSS, shows user email + signup timestamp
- [ ] Create `app/views/signup_notification_mailer/new_signup.text.erb` — plain text fallback with same content
- [ ] Modify `app/controllers/sessions_controller.rb` — add `previously_new_record?` check after `find_or_create_by!`, call `SignupNotificationMailer.new_signup(user).deliver_later`
- [ ] Create `spec/mailers/signup_notification_mailer_spec.rb` — test recipients, subject, body content (email + timestamp)
- [ ] Update `spec/requests/sessions_spec.rb` — add test that new user signup enqueues `SignupNotificationMailer`, add test that returning user login does NOT enqueue it

**iOS:** N/A — Level 1 project
**Android:** N/A — Level 1 project

**Dependencies:** None (first milestone)

---

### M2: QA Test Data
**What:** Create a seed task that exercises the signup notification flow so a human tester can verify emails in a development/staging environment.

**Acceptance Criteria:**
- [ ] Seed task exists at `lib/tasks/seed_signup_notification.rake`
- [ ] Task creates a brand-new user via `User.find_or_create_by!` and triggers the notification mailer (simulating the controller flow)
- [ ] Task is idempotent (uses a deterministic test email, cleans up or skips if user exists)
- [ ] Task prints a summary: the test user's email, the expected notification recipients, and instructions for verifying delivery
- [ ] In development, the notification email appears in Letter Opener; in staging/production, it arrives via Resend

**Web/Rails:**
- [ ] Create `lib/tasks/seed_signup_notification.rake` — `pipeline:seed_signup_notification` task
- [ ] Task directly calls `SignupNotificationMailer.new_signup(user).deliver_later` (since the seed bypasses the controller, it must invoke the mailer explicitly)
- [ ] No production-unsafe operations

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs mailer and templates to exist)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> These were reviewed and approved in the Architecture Review checkpoint.

- [x] Architecture proposal approved: `email-notifications/architecture-proposal.md` (Status: Accepted, 2/7/2026)
- [x] Milestones correctly reference the approved architecture
- [x] No contradictions between gameplan and approved architecture
- N/A — no data model changes, no API changes

### Security & Access Control
- [x] No new data access paths — mailer reads `user.email` and `user.created_at`, already available in controller
- [x] No new controller actions — modification to existing `create` action only
- [x] Recipient list is hardcoded — no user-controlled input in email recipients
- [x] Email body uses model-validated email and system-generated timestamp — no injection risk
- N/A — no query scoping changes, no permission changes, no API auth changes

### Performance
- [x] No database queries added — mailer reads user attributes already loaded in controller
- [x] `deliver_later` offloads email construction + delivery to Solid Queue background worker
- [x] Signup volume is very low — no batching, rate limiting, or caching needed
- N/A — no indexes, no N+1 risks

### Observability & Debuggability
- [x] Solid Queue logs job execution (enqueue, execute, fail) — no custom logging needed
- [x] Failed deliveries appear in Solid Queue's failed jobs table — queryable via `SolidQueue::FailedExecution`
- [x] In development, Letter Opener shows the email in the browser — immediate visual verification
- N/A — no custom metrics or alerts needed for this volume

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Mailer spec | Recipients, subject, body content (email + timestamp), multipart (HTML + text) | Rails | Pipeline |
| Request spec | New user enqueues notification; returning user does not | Rails | Pipeline |
| Manual QA | Seed task → verify email arrives in Letter Opener (dev) or inbox (staging) | Rails | Human |

### Feature Flags & Rollout
- N/A — no feature flag needed. This is an internal notification with no user-facing impact. Deploy and it's live. (Per PRD Section 12.)

### Mobile-Specific
- N/A — Level 1 (web-only) project.

### Legacy & Migration
- [x] No backwards compatibility concerns — no API changes, no client-facing changes
- N/A — no data migration

### Export/Reporting
- N/A — no export changes.

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| `previously_new_record?` not available | Low — Rails 8.1 includes this (available since 6.1) | Verify method exists in Rails console before implementation |
| Resend delivery failure | Low — login flow is unaffected | `deliver_later` is async; Solid Queue handles retries; Resend has its own retry logic |
| Mailer template error (missing view, typo) | Low — would cause Solid Queue job failure, not login failure | Mailer spec catches template errors at test time |

No external dependencies. No inter-team dependencies. No third-party integrations beyond Resend (already configured).

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | M1 + M2 (all milestones) | None — always on | Internal team only (notification recipients) |

Single-phase release. No feature flag. No staged rollout. Deploy the branch and notifications begin.

### Done Criteria
- [x] All acceptance criteria met
- [x] All tests passing (`bundle exec rspec`)
- [x] Post-flight checks pass (RuboCop, Brakeman, bundler-audit)
- [x] Manual QA via seed task (Letter Opener in dev)
- [ ] PR reviewed and merged to `main`

---

## 7. Estimates

| Milestone | Rails | Notes |
|-----------|-------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 1-2 |
| M1: Signup Notification Mailer | < 1 day | 3 new files, 1 modified file, 2 spec files |
| M2: QA Test Data | < 1 day | 1 rake task |
| **Total** | **< 1 day** | Very small project |

---

## PRD Traceability Matrix

| PRD Requirement | Milestone | Acceptance Criterion |
|----------------|-----------|---------------------|
| EML-001 | M1 | New user creation triggers notification |
| EML-002 | M1 | Recipient list includes both addresses |
| EML-003 | M1 | Subject format matches spec |
| EML-004 | M1 | Body includes email + timestamp |
| EML-005 | M1 | Uses `deliver_later` |
| EML-006 | M1 | Delivery failure doesn't block login |
| EML-007 | M1 | Only new users, not returning users |
| CFG-001 | M1 | `RECIPIENTS` constant in mailer class |

All 8 PRD requirements are mapped. No gaps.

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2/7/2026
### Status: Accepted

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Estimates are realistic
- [x] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-07 | Pipeline | Initial gameplan generated |
