# QA Plan — New User Signup Email Notifications

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-07
> **Branch:** `pipeline/email-notifications`
> **PR:** TBD
> **Gameplan:** `email-notifications/gameplan.md`
> **Progress:** `email-notifications/progress.md`

---

## 1. Feature Summary

When a new user signs up for Show Notes via the login form, an internal email notification is sent to hardcoded recipients (`dpaola2@gmail.com` and `dpaola2-ceo@agentmail.to`). The email includes the user's email address and signup timestamp. Returning users who log in again do not trigger a notification. Email delivery is asynchronous via `deliver_later` (Solid Queue) and never blocks the user's login flow.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M0 | Discovery & Alignment (Stages 1-3) | N/A |
| M1 | Signup Notification Mailer & Controller Integration | `21c3104` |
| M2 | QA Test Data (seed rake task) | `7db3ddf` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests (full suite)** | 250 |
| **Passing** | 250 |
| **Failing** | 0 |
| **New test files** | 2 |
| **New test cases** | 9 |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Mailer spec | `spec/mailers/signup_notification_mailer_spec.rb` | 7 | Recipients (EML-002, CFG-001), subject format (EML-003), sender address, HTML body content — email + timestamp (EML-004), text body content — email + timestamp (EML-004) |
| Request spec | `spec/requests/signup_notifications_spec.rb` | 2 | New user enqueues notification (EML-001, EML-005, EML-007), existing user does NOT enqueue (EML-007) |

### What Automated Tests Verify

- Notification email is sent to exactly `dpaola2@gmail.com` and `dpaola2-ceo@agentmail.to`
- Subject line follows the format `"New Show Notes signup: {user email}"`
- Email sender is `noreply@listen.davepaola.com` (inherited from `ApplicationMailer`)
- HTML body contains the user's email address
- HTML body contains the signup timestamp
- Text body contains the user's email address
- Text body contains the signup timestamp
- New user signup (via POST /login) enqueues a `SignupNotificationMailer` job
- Existing user login (via POST /login) does NOT enqueue a `SignupNotificationMailer` job

### What Automated Tests Do NOT Verify

| Criterion | Why Not Automated | QA Coverage |
|-----------|-------------------|-------------|
| EML-006: Delivery failure doesn't block login | Architectural guarantee — `deliver_later` is async. Testing this would mean testing Solid Queue internals. | Verified by code review (no `deliver_now`, no inline rescue needed) |
| M2: Seed task works end-to-end | Seed tasks are not unit-tested (codebase convention) | Manual QA (Section 4 below) |
| Email rendering in real mail clients | Mailer specs test content, not visual rendering | Manual QA (Section 4 below) |
| Actual Resend delivery in staging/production | Test environment uses `:test` delivery method | Manual QA in staging (Section 4 below) |

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/show-notes
bundle exec rake pipeline:seed_signup_notification
```

The task:
1. Destroys any existing user with email `pipeline-test-signup@example.com`
2. Creates a new user with that email
3. Enqueues a `SignupNotificationMailer.new_signup(user).deliver_later` call
4. Prints a summary with the test email, recipients, and verification instructions

### Scenarios Seeded

| Scenario | User | Data Created | Purpose |
|----------|------|--------------|---------|
| New signup notification | `pipeline-test-signup@example.com` | User record + enqueued notification email | Verify notification email content and delivery in Letter Opener (dev) or inbox (staging) |

### Post-Seed Verification

- [ ] Run the rake task and confirm the summary output shows correct email, recipients, and instructions
- [ ] Open Letter Opener at `/letter_opener` (development) and verify the notification email appears
- [ ] Verify the email shows the correct subject: `"New Show Notes signup: pipeline-test-signup@example.com"`
- [ ] Verify the email body contains the user's email and signup timestamp

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 New User Signup Flow

#### QA-001: New user triggers notification email
**Criteria:** EML-001, EML-007
**Steps:**
1. Open the app in a browser (development environment)
2. Navigate to the login page (`/login`)
3. Enter a **brand new** email address (one that has never been used before, e.g., `qa-test-new-YYYYMMDD@example.com`)
4. Submit the login form
5. Open Letter Opener at `/letter_opener`

**Expected:** Two emails appear in Letter Opener:
- A magic link email sent TO the new user's email address (existing behavior)
- A signup notification email sent TO `dpaola2@gmail.com` and `dpaola2-ceo@agentmail.to`

---

#### QA-002: Returning user does NOT trigger notification
**Criteria:** EML-007
**Steps:**
1. Use the same email address from QA-001 (which now exists in the database)
2. Navigate to `/login`
3. Enter that email address again
4. Submit the login form
5. Open Letter Opener at `/letter_opener`

**Expected:** Only one email appears — the magic link email. **No** signup notification email is sent.

---

#### QA-003: Login flow still works correctly after changes
**Criteria:** EML-006 (non-blocking)
**Steps:**
1. Navigate to `/login`
2. Enter any valid email address
3. Submit the login form
4. Observe the redirect

**Expected:** User is redirected to the "Check your email" page with the notice "Check your email for a login link." The login flow completes without delay or error, regardless of whether a notification was enqueued.

---

### 4.2 Email Content Verification

#### QA-004: Notification email subject format
**Criteria:** EML-003
**Steps:**
1. Run `bundle exec rake pipeline:seed_signup_notification`
2. Open Letter Opener at `/letter_opener`
3. Find the signup notification email

**Expected:** Subject line reads `"New Show Notes signup: pipeline-test-signup@example.com"`

---

#### QA-005: Notification email recipients
**Criteria:** EML-002
**Steps:**
1. Open the notification email from QA-004 in Letter Opener
2. Check the "To" field

**Expected:** To field shows both `dpaola2@gmail.com` and `dpaola2-ceo@agentmail.to`

---

#### QA-006: Notification email HTML body content
**Criteria:** EML-004
**Steps:**
1. Open the notification email from QA-004 in Letter Opener
2. View the HTML version of the email

**Expected:** The email body contains:
- The text "pipeline-test-signup@example.com" (user's email address)
- A human-readable signup timestamp (e.g., "February 07, 2026 at 3:45 PM UTC")
- Clean formatting — no broken HTML, no missing styles

---

#### QA-007: Notification email text body content
**Criteria:** EML-004
**Steps:**
1. Open the notification email from QA-004 in Letter Opener
2. View the plain text version of the email (if Letter Opener supports toggling, or check `.text.erb` rendering)

**Expected:** The plain text body contains:
- The user's email address
- The signup timestamp
- Readable without HTML tags

---

### 4.3 Seed Task Verification

#### QA-008: Seed task runs successfully
**Criteria:** M2 acceptance criteria
**Steps:**
1. Open a terminal in the Show Notes project directory
2. Run `bundle exec rake pipeline:seed_signup_notification`

**Expected:** Output includes:
- "Created test user: pipeline-test-signup@example.com (id: N)"
- "Enqueued signup notification email"
- Summary section with test user email, recipients, and verification instructions

---

#### QA-009: Seed task is idempotent
**Criteria:** M2 acceptance criteria
**Steps:**
1. Run `bundle exec rake pipeline:seed_signup_notification` a first time
2. Note the output (user id)
3. Run `bundle exec rake pipeline:seed_signup_notification` a second time
4. Note the output (user id)

**Expected:** Both runs complete without error. The second run shows "Destroyed existing test user" before creating a new one. A new notification email is enqueued each time.

---

### 4.4 Async Delivery Verification

#### QA-010: Notification uses deliver_later (async)
**Criteria:** EML-005
**Steps:**
1. Navigate to `/login` and enter a new email address
2. Observe the redirect timing

**Expected:** The redirect to the "Check your email" page happens immediately — no perceptible delay from email delivery. (In development, Letter Opener may open a new tab, but the redirect should not wait for the email to be constructed or sent.)

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Empty email submission | Submit the login form with a blank email field | Flash alert "Please enter your email address" — no notification sent | EML-007 |
| 2 | Invalid email format | Submit the login form with "not-an-email" | Flash alert "Invalid email address" — no user created, no notification sent | EML-007 |
| 3 | Rapid re-submission with same new email | Submit the login form twice quickly with the same new email (before the first request completes) | Only one notification should be sent (second request finds existing user via `find_or_create_by!`) | EML-007 |
| 4 | Case sensitivity | Submit "Test@Example.com" (mixed case) | Email is downcased and stripped. If the user is new, one notification is sent for "test@example.com" | EML-001 |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| Admin UI for managing recipients | Out of scope | Recipients are hardcoded in `SignupNotificationMailer::RECIPIENTS`. To change, edit the constant and deploy. |
| User-facing welcome/confirmation email | Out of scope | Only internal admin notification. No email is sent to the new user about the notification. |
| SMS or push notification channels | Out of scope | Email only. |
| Notification preferences / unsubscribe | Out of scope | Hardcoded recipients, no opt-out mechanism. |
| Analytics or delivery tracking | Out of scope | No custom metrics. Solid Queue logs job execution. Failed deliveries visible in `SolidQueue::FailedExecution`. |
| Notifications for non-signup actions | Out of scope | Only new user signup triggers notification. |
| `previously_new_record?` gotcha | Implementation note | The `previously_new_record?` flag is cleared by `update!`. The implementation captures it in a local variable **before** calling `generate_magic_token!` (which internally calls `update!`). This was caught during development and fixed. |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| Login flow (SessionsController#create) | Low | The only modification is 2 new lines (capture `previously_new_record?`, call `deliver_later`). Verify: login form renders, form submission works for new AND existing users, magic link email still sent, redirect to "check your email" page works. |
| Existing magic link emails (UserMailer) | None | UserMailer is unchanged. No shared state between `SignupNotificationMailer` and `UserMailer`. |
| Solid Queue job processing | None | No changes to job infrastructure. `deliver_later` uses the same queue as existing mailers. |
| User model | None | No model changes. `User.find_or_create_by!` behavior is unchanged. |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | None — no feature flag. | This is an internal notification with no user-facing impact. Rollback requires code revert. |
| Code revert | Revert the 2 lines added to `SessionsController#create` (the `new_signup` variable and the `SignupNotificationMailer` call). | The mailer class and templates can remain — they're inert without the controller trigger. |
| Migration | N/A — no migrations. | No schema changes to revert. |
| Data cleanup | None needed. | No new data is created by this feature (no new tables, no new columns). The `pipeline-test-signup@example.com` user from the seed task can be deleted manually if desired. |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-010)
- [ ] Edge cases tested (4 scenarios)
- [ ] Regression areas checked (login flow)
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
