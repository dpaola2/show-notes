---
pipeline_stage: 3
pipeline_stage_name: gameplan
pipeline_project: "shareable-episode-cards"
pipeline_started_at: "2026-02-18T09:13:54-0500"
pipeline_completed_at: "2026-02-18T09:14:28-0500"
pipeline_approved_at: "2026-02-18T09:32:04-0500"
---

# Shareable Episode Cards - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-18
> **PRD:** `shareable-episode-cards/prd.md`
> **Discovery Report:** `shareable-episode-cards/discovery-report.md`
> **Approved Architecture:** `shareable-episode-cards/architecture-proposal.md`

---

## 1. Project Overview

### Goals
- Make episode synopsis pages publicly accessible as standalone reading experiences without authentication
- Auto-generate branded OG images (1200x630) for every summarized episode so shared links render rich previews
- Add share functionality (copy link, Twitter/X, LinkedIn, Web Share API) to both public and authenticated views
- Track share events and UTM attribution to close the growth loop: share → read → sign up

### Scope Summary

| Area | Description | Platform |
|------|-------------|----------|
| Public episode pages | Unauthenticated `/e/:id` route with summary display, OG meta tags, CTA | Web (Rails) |
| OG image generation | Background job using vips to composite podcast artwork + title + quote + branding | Web (Rails) |
| Share UI | Stimulus-powered share button with clipboard, Twitter/X, LinkedIn, Web Share API | Web (Rails) |
| Share tracking | ShareEvent model, UTM params, referral_source attribution on User | Web (Rails) |

### Out of Scope
- Custom image editor for OG cards
- Instagram/TikTok vertical format images
- Embeddable widgets ("embed this summary on your blog")
- Social media posting integration (OAuth posting on user's behalf)
- Quote-specific OG image generation (SHR-006 is Nice priority — deferred)
- Analytics dashboard for share metrics
- RSS feed modification
- Audio player on public pages

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (repo root)
- Single platform: Web (Rails 8.1) only
- No feature flag — ship all at once when branch merges (architecture decision Q4)
- No audio on public page — summary is the free sample, audio is the product (architecture decision Q1)
- Public pages are SEO-indexable (architecture decision Q2)
- First quote used for OG image excerpt, fallback to first section content (architecture decision Q3)

---

## 2. Open Questions & Decisions

> Resolved during Stages 1-2 (Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| New controller vs action on existing EpisodesController? | Resolved | New `PublicEpisodesController` — separation of concerns, avoids subscription-scoping leakage |
| Public URL format? | Resolved | `/e/:id` (short, shareable). Authenticated `/episodes/:id` unchanged. |
| Which layout for public pages? | Resolved | New `public` layout modeled after `sessions` layout — minimal, no nav bar, OG meta tags via `yield :head` |
| Active Storage vs simpler approach for OG images? | Resolved | Active Storage with `has_one_attached :og_image` — requires migration but gives clean API |
| OG image generation approach? | Resolved | `image_processing` gem with vips — already in Gemfile and Docker, no new dependencies |
| What quote/excerpt for OG image? | Resolved | First quote (`summary.quotes[0].text`), fallback to first sentence of first section content |
| Audio on public page? | Resolved | No — summary is the free sample, audio access incentivizes signup |
| SEO indexable? | Resolved | Yes — `<meta name="robots" content="index, follow">`, no sitemap needed for v1 |
| Feature flag strategy? | Resolved | No flag — deploy behind branch, ship all at once |
| Inline vs separate job for OG image? | Resolved | Separate `GenerateOgImageJob` enqueued after `create_summary!` in `ProcessEpisodeJob` |
| Artwork quality handling? | Resolved | vips scales gracefully; use placeholder if artwork missing or unusable |

---

## 3. Functional Milestones

> Organized by FEATURE AREA, not by platform.

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented (Stage 1)
- [x] Data model proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Data Model, Public Page & OG Meta Tags
**What:** Set up Active Storage, create the ShareEvent model and migrations, build the public episode page with OG meta tags, and add the public layout. This is the foundation — public pages work and render rich link previews (text-only OG tags until M2 generates images).
**Size:** M (8-10 files, 3 migrations, follows existing controller/view patterns)

**Acceptance Criteria:**
- [ ] PUB-001: Episode synopsis pages (sections + quotes) are accessible at `/e/:id` without authentication
- [ ] PUB-002: Public page displays episode title, podcast name, and podcast artwork
- [ ] PUB-003: Public page displays the full AI summary (all sections and quotes)
- [ ] PUB-004: Public page includes a prominent CTA ("Get summaries for your podcasts") linking to the signup flow
- [ ] PUB-005: Public page includes OG meta tags (`og:title`, `og:description`, `og:image`, `og:url`) for rich link previews
- [ ] PUB-006: Public page has a clean, readable design using the `public` layout (no nav bar, Tailwind-styled)
- [ ] PUB-007: Management actions (library, triage, audio playback) are NOT accessible from the public page
- [ ] PUB-008: Public page URL is stable and permanent (`/e/:id`)
- [ ] Data model: `share_events` table created with indexes on `episode_id`, `user_id`, and `(episode_id, share_target)`
- [ ] Data model: `referral_source` column added to `users` table (nullable, no backfill)
- [ ] Data model: Active Storage tables installed (`active_storage_blobs`, `active_storage_attachments`, `active_storage_variant_records`)
- [ ] Model: `ShareEvent` model with validations (`share_target` inclusion in `[clipboard, twitter, linkedin, native]`) and associations
- [ ] Model: `Episode` gains `has_many :share_events`, `has_one_attached :og_image`, `og_image_url` method, `shareable?` method
- [ ] Model: `User` gains `has_many :share_events, dependent: :nullify`
- [ ] Public page returns friendly 404 for non-existent episodes
- [ ] Public page handles episodes without summaries (shows "Summary not yet available" with basic metadata)
- [ ] Public page is SEO-indexable (`<meta name="robots" content="index, follow">`)

**Web (Rails):**
- [ ] Migration: Install Active Storage (`rails active_storage:install`)
- [ ] Migration: Create `share_events` table with indexes
- [ ] Migration: Add `referral_source` to `users`
- [ ] Model: `app/models/share_event.rb` — validations, associations, scopes
- [ ] Model: `app/models/episode.rb` — add `has_many :share_events`, `has_one_attached :og_image`, `og_image_url`, `shareable?`
- [ ] Model: `app/models/user.rb` — add `has_many :share_events, dependent: :nullify`
- [ ] Route: `resources :public_episodes, only: [:show], path: "e"` + `post "e/:id/share"` route
- [ ] Controller: `app/controllers/public_episodes_controller.rb` — `show` action with `skip_before_action :require_authentication`
- [ ] Layout: `app/views/layouts/public.html.erb` — minimal public layout with OG meta tags via `yield :head`
- [ ] View: `app/views/public_episodes/show.html.erb` — summary display, artwork, CTA, share button placeholder
- [ ] Factory: `spec/factories/share_events.rb`
- [ ] Tests: `spec/models/share_event_spec.rb` — validations, associations
- [ ] Tests: `spec/requests/public_episodes_spec.rb` — public access without auth, OG meta tags rendered, 404 for missing episodes, summary-less episode handling, subscription scoping NOT leaking

**Dependencies:** None (first milestone)

---

### M2: OG Image Generation
**What:** Build the background job and service that generates branded OG images (1200x630) using vips, and wire it into the episode processing pipeline. Add backfill rake task for existing summarized episodes.
**Size:** M (6-8 files, new service + job pattern, vips compositing)

**Acceptance Criteria:**
- [ ] OGI-001: An OG image (1200x630) is auto-generated for each summarized episode
- [ ] OGI-002: The OG image includes the podcast artwork (scaled appropriately)
- [ ] OGI-003: The OG image includes the episode title
- [ ] OGI-004: The OG image includes a compelling quote (first from `summary.quotes`, fallback to first sentence of first section)
- [ ] OGI-005: The OG image includes Show Notes branding (small, tasteful)
- [ ] OGI-006: Generated images are stored via Active Storage and served via `og:image` meta tag on public page
- [ ] OGI-007: Image generation handles variable podcast artwork quality (100x100 to 3000x3000) gracefully — scales or uses placeholder
- [ ] OGI-008: Image generation is triggered automatically when a summary is created (via `ProcessEpisodeJob`)
- [ ] Backfill: Rake task generates OG images for existing summarized episodes that don't have one
- [ ] OG image generation failure does not break the public page (falls back to text-only OG tags)
- [ ] Missing/broken artwork URL handled gracefully (placeholder used)

**Web (Rails):**
- [ ] Service: `app/services/og_image_generator.rb` — vips-based image compositing (artwork + title + quote + branding → 1200x630 PNG)
- [ ] Job: `app/jobs/generate_og_image_job.rb` — fetches artwork, calls `OgImageGenerator`, attaches result to `episode.og_image`
- [ ] Modify: `app/jobs/process_episode_job.rb` — enqueue `GenerateOgImageJob` after `create_summary!`
- [ ] Modify: `app/views/public_episodes/show.html.erb` — update `og:image` meta tag to use `episode.og_image_url` when available
- [ ] Rake task: `lib/tasks/backfill_og_images.rake` — iterates episodes with summaries but no OG image, enqueues `GenerateOgImageJob`
- [ ] Tests: `spec/services/og_image_generator_spec.rb` — image dimensions, artwork handling, text truncation, placeholder fallback
- [ ] Tests: `spec/jobs/generate_og_image_job_spec.rb` — job enqueue, artwork fetch failure handling, Active Storage attachment

**Dependencies:** M1 (needs Active Storage tables, Episode model changes, public page view)

---

### M3: Share UI, Tracking & UTM Attribution
**What:** Build the share button Stimulus controller, wire up share event tracking, add UTM parameter handling to shared links, and persist referral attribution through the signup flow.
**Size:** M (7-9 files, Stimulus controller + controller action + session flow modification)

**Acceptance Criteria:**
- [ ] SHR-001: A "Share" button is present on the public episode page, the authenticated episode page (`episodes/show`), and the library episode page (`library/show`)
- [ ] SHR-002: "Copy Link" copies the public episode URL (with UTM params) to clipboard and shows confirmation toast
- [ ] SHR-003: "Twitter/X" opens a pre-filled tweet with episode title + public link (with UTM params)
- [ ] SHR-004: "LinkedIn" opens a pre-filled post with the public episode link (with UTM params)
- [ ] SHR-005: On mobile browsers with Web Share API support, a "More..." option triggers the native share sheet
- [ ] TRK-001: Shared links include UTM parameters (`utm_source=share`, `utm_medium=social`, `utm_content=episode_{id}`)
- [ ] TRK-002: Share events are recorded (episode, share target, user_agent, referrer) when user clicks a share option
- [ ] TRK-003: Public page visits with UTM params are logged at `info` level with structured format (episode_id, utm_source, utm_medium, utm_content)
- [ ] TRK-004: UTM source from shared links is persisted as `referral_source` on the User record during signup
- [ ] Share button debounces clicks (client-side) to prevent duplicate share events
- [ ] Share event creation handles concurrent/duplicate POSTs gracefully

**Web (Rails):**
- [ ] Stimulus controller: `app/javascript/controllers/share_controller.js` — clipboard copy, Twitter/LinkedIn intent URLs, Web Share API detection, share event POST, debounce
- [ ] Partial: `app/views/shared/_share_button.html.erb` — reusable share button component
- [ ] Controller: `PublicEpisodesController#share` action — creates `ShareEvent` record, returns redirect/turbo response
- [ ] Modify: `app/views/public_episodes/show.html.erb` — render share button partial
- [ ] Modify: `app/views/episodes/show.html.erb` — render share button partial
- [ ] Modify: `app/views/library/show.html.erb` — render share button partial
- [ ] Modify: `app/controllers/sessions_controller.rb` — capture UTM params from query string in session, persist `referral_source` on user creation
- [ ] Modify: `app/controllers/public_episodes_controller.rb` — log UTM params on `show` action when present
- [ ] Tests: `spec/requests/public_episodes_spec.rb` — share action creates ShareEvent, UTM logging
- [ ] Tests: `spec/requests/sessions_spec.rb` — UTM params persisted through signup flow as `referral_source`

**Dependencies:** M1 (needs ShareEvent model, public page, routes)

---

### M4: QA Test Data
**What:** Create a rake task that populates realistic test data covering all shareable episode card scenarios — public pages, OG images, share events, and UTM attribution — for manual QA.
**Size:** S (1-2 files, uses existing factories/models)

**Acceptance Criteria:**
- [ ] Seed task exists at `lib/tasks/seed_shareable_episode_cards.rake`
- [ ] Task creates a test user with an email and active subscription
- [ ] Task creates a podcast with artwork URL and multiple episodes in various states:
  - Episode with summary and OG image (happy path)
  - Episode with summary but no OG image (fallback OG tags)
  - Episode without summary (no-summary public page)
  - Episode with very long title (100+ characters) for truncation testing
  - Episode with summary that has no quotes (fallback to section content for OG image)
- [ ] Task creates sample share events across different targets (clipboard, twitter, linkedin, native)
- [ ] Task creates a user with `referral_source` set (UTM attribution scenario)
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary of what was created (user email, episode IDs, public page URLs)
- [ ] All scenarios from the manual QA checklist have supporting test data

**Web (Rails):**
- [ ] Rake task: `lib/tasks/seed_shareable_episode_cards.rake` — idempotent, uses ActiveRecord directly
- [ ] No production-unsafe operations (dev/test only — guarded by `Rails.env` check)

**Dependencies:** M1, M2, M3 (needs full feature implemented)

---

### M5: Edge Cases, Empty States & Polish
**What:** Handle all edge cases from the PRD, add empty state messages, ensure OG image fallback behavior, and polish the public page design.
**Size:** S (3-5 files, view tweaks and edge case handling)

**Acceptance Criteria:**
- [ ] Edge case: Episode with no summary shows "Summary not yet available" with basic metadata on public page (handled in M1, verify)
- [ ] Edge case: OG image generation failure — public page falls back to text-only OG tags (no `og:image` tag if no image attached)
- [ ] Edge case: Podcast has no artwork — OG image uses a default placeholder; public page shows generic podcast icon
- [ ] Edge case: Very long episode title (100+ chars) — truncated with ellipsis on OG image and in `og:title` meta tag
- [ ] Edge case: Very long quote — truncated with ellipsis on OG image
- [ ] Edge case: Episode deleted after being shared — shared links return friendly 404 ("This episode is no longer available")
- [ ] Edge case: Summary regenerated — OG image is regenerated with latest content (old image replaced)
- [ ] Edge case: Concurrent share clicks — debounced client-side (verify from M3)
- [ ] Edge case: Social platform caches old OG image — documented as known limitation (no in-app fix)
- [ ] Edge case: User's account is deactivated — public pages still accessible (public pages serve episode data, not user data; already handled by architecture)
- [ ] Public page responsive design (mobile-friendly)
- [ ] Share popover/menu styled consistently with app design system

**Web (Rails):**
- [ ] View: Polish `app/views/public_episodes/show.html.erb` — responsive layout, empty states, truncation
- [ ] Service: `OgImageGenerator` — verify text truncation, placeholder artwork handling
- [ ] View: `app/views/shared/_share_button.html.erb` — polish popover styling
- [ ] Stimulus: `share_controller.js` — verify debounce, error handling for failed POST

**Dependencies:** M1, M2, M3 (needs all feature milestones complete)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> These were reviewed and approved in the Architecture Review checkpoint.

- [x] Architecture proposal approved: `shareable-episode-cards/architecture-proposal.md`
- [ ] Milestones correctly reference the approved data model and API design
- [ ] No contradictions between gameplan and approved architecture

### Security & Access Control
- [ ] Public page only exposes intended data: episode title, published_at, podcast title, podcast artwork_url, summary sections, summary quotes
- [ ] Public page does NOT expose: audio URL, user data, processing status, management actions
- [ ] `PublicEpisodesController` uses `skip_before_action :require_authentication` — explicit public access
- [ ] Existing `EpisodesController` and `LibraryController` subscription scoping unchanged
- [ ] UTM params sanitized before persisting to `referral_source` (length validation, string-only)
- [ ] CSRF protection applies to share event POST
- [ ] Active Storage blob URLs are signed by default (no enumeration risk)
- [ ] No new API authentication surfaces (all routes serve HTML)

### Performance
- [ ] Public page loads: 2 joins (episode → podcast, episode → summary) — use `includes` to avoid N+1
- [ ] OG image generation in background job — does not block web requests
- [ ] External artwork fetch in background job — network latency isolated from user experience
- [ ] Public pages cacheable — consider `Cache-Control` / `ETag` headers for traffic spikes
- [ ] Active Storage `og_image` queried once per public page load
- [ ] `share_events` table indexed on `episode_id` and `(episode_id, share_target)` — sufficient for write pattern

### Observability & Debuggability
- [ ] UTM params logged at `info` level on public page visits (structured format: episode_id, utm_source, utm_medium, utm_content)
- [ ] OG image generation failures logged (artwork fetch failure, vips error) — job retries gracefully
- [ ] Share events are queryable via Rails console for debugging
- [ ] No alerts needed for v1 — monitor via logs

### Analytics & Instrumentation

#### Success Metrics
- [ ] 100% of summarized episodes have public pages with OG images at launch
- [ ] 10+ shares initiated per week within 30 days
- [ ] 50+ click-throughs from shared links within 60 days
- [ ] 1+ signup attributed to shared links within 90 days

#### Events to Track

| Event Name | Trigger | Key Properties | Platform |
|------------|---------|----------------|----------|
| Share event (ShareEvent record) | User clicks share option | episode_id, share_target, user_id (nullable), user_agent, referrer | Web |
| Public page visit with UTM | Visitor arrives via shared link | episode_id, utm_source, utm_medium, utm_content (logged) | Web |
| Signup attribution | New user signs up from shared link | user_id, referral_source | Web |

#### Instrumentation Approach
- [ ] Framework: Server-side — ShareEvent model for shares, Rails logger for UTM visits, `referral_source` column for attribution
- [ ] Implementation location: `PublicEpisodesController` (UTM logging), `SessionsController` (UTM persistence), Stimulus controller (share event POST)

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Model specs | ShareEvent validations, associations, scopes | Web (Rails) | Pipeline |
| Request specs | Public page access, OG meta tags, share action, UTM logging, auth boundary, 404 handling | Web (Rails) | Pipeline |
| Job specs | GenerateOgImageJob enqueue, artwork fetch, Active Storage attachment | Web (Rails) | Pipeline |
| Service specs | OgImageGenerator compositing, text truncation, artwork handling, placeholder fallback | Web (Rails) | Pipeline |
| Manual QA | Share button UX, OG card preview on Twitter/LinkedIn, mobile Web Share API, CTA flow, signup attribution | Web | Human |

### Feature Flags & Rollout
- [x] No feature flag — deploy all at once when branch merges (architecture decision)
- [ ] Public pages are always-on once deployed (no selective exposure)
- [ ] Ship behind `pipeline/shareable-episode-cards` branch until merge

### Mobile-Specific
N/A — single-platform web project.

### Legacy & Migration
- [ ] No backwards compatibility concerns — single-platform web app, no old clients
- [ ] Backfill rake task generates OG images for existing summarized episodes (post-deploy)
- [ ] No data migration from old → new

### Export/Reporting
- [x] N/A — no export requirements

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| Active Storage tables don't exist yet | Med — `has_one_attached` will fail without migration | M1 runs `rails active_storage:install` as first migration |
| External artwork URL reliability | Med — broken/slow artwork URLs break OG image generation | `GenerateOgImageJob` handles fetch failures gracefully (placeholder image). Background job isolated from user experience. |
| vips/image_processing availability in dev | Low — already in Gemfile + Docker, but dev machines need `libvips` | Verify `libvips` installed locally; document in PR if needed |
| Social platform OG cache invalidation | Low — Twitter/LinkedIn cache OG images aggressively | No in-app fix. Document limitation. `og:image` URL changes when image is regenerated (new Active Storage blob URL). |
| OG image quality/design | Low — vips compositing is more limited than HTML/CSS rendering | Keep design simple (solid background, artwork, text, branding). Iterate on template after v1 launch. |
| SQLite in dev vs PostgreSQL in CI | Low — Active Storage works on both, but test behavior may differ | Run full test suite on CI. No database-specific features used. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | All milestones (M1-M5) | No flag — all at once | All users + public visitors |

### Done Criteria
- [ ] All acceptance criteria met
- [ ] All tests passing (`bundle exec rspec`)
- [ ] Post-flight checks pass (RuboCop, Brakeman, bundler-audit, importmap audit)
- [ ] Backfill rake task ready for post-deploy execution
- [ ] OG images verified on Twitter Card Validator / LinkedIn Post Inspector
- [ ] QA sign-off on share UX, public page, and CTA flow

---

## 7. Estimates

| Milestone | Size | Notes |
|-----------|------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 0-2 |
| M1: Data Model, Public Page & OG Meta Tags | M | 3 migrations, new controller/layout/view, model changes, factory + specs |
| M2: OG Image Generation | M | New service + job, vips compositing, backfill task, specs |
| M3: Share UI, Tracking & UTM Attribution | M | Stimulus controller, share button partial, session flow changes, specs |
| M4: QA Test Data | S | Rake task with idempotent seed data |
| M5: Edge Cases, Empty States & Polish | S | View polish, edge case verification, responsive design |

---

## PRD Traceability Matrix

| PRD Requirement | Milestone | Acceptance Criterion |
|----------------|-----------|---------------------|
| PUB-001 | M1 | Public page accessible without auth |
| PUB-002 | M1 | Displays title, podcast name, artwork |
| PUB-003 | M1 | Displays full AI summary |
| PUB-004 | M1 | CTA linking to signup |
| PUB-005 | M1 | OG meta tags rendered |
| PUB-006 | M1 | Clean readable design with public layout |
| PUB-007 | M1 | Management actions not accessible |
| PUB-008 | M1 | Stable URL at `/e/:id` |
| OGI-001 | M2 | 1200x630 OG image generated |
| OGI-002 | M2 | Includes podcast artwork |
| OGI-003 | M2 | Includes episode title |
| OGI-004 | M2 | Includes quote/excerpt |
| OGI-005 | M2 | Includes Show Notes branding |
| OGI-006 | M2 | Stored via Active Storage, served via og:image |
| OGI-007 | M2 | Handles variable artwork quality |
| OGI-008 | M2 | Triggered on summary creation |
| SHR-001 | M3 | Share button on public + authenticated views |
| SHR-002 | M3 | Copy link to clipboard |
| SHR-003 | M3 | Twitter/X pre-filled tweet |
| SHR-004 | M3 | LinkedIn pre-filled post |
| SHR-005 | M3 | Web Share API on mobile |
| TRK-001 | M3 | UTM params on shared links |
| TRK-002 | M3 | Share events recorded |
| TRK-003 | M3 | UTM visits logged |
| TRK-004 | M3 | Signup attribution via referral_source |
| SHR-006 | Out of scope | Nice priority — quote share deferred |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2026-02-18
### Status: Approved

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Milestone sizes are appropriate (no XL milestones that should be split)
- [x] Release plan is appropriate

#### Optional Notes
M2 and M3 are independent — either can be built first after M1.

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-18 | Pipeline | Initial gameplan generated |
| 2026-02-18 | Dave | Approved |
