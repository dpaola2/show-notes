---
pipeline_stage: 2
pipeline_stage_name: architecture
pipeline_project: "shareable-episode-cards"
pipeline_started_at: "2026-02-18T08:50:01-0500"
pipeline_completed_at: "2026-02-18T08:51:04-0500"
pipeline_approved_at: "2026-02-18T09:11:40-0500"
---

# Shareable Episode Cards - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** 2026-02-18
> **PRD:** `shareable-episode-cards/prd.md`
> **Discovery Report:** `shareable-episode-cards/discovery-report.md`

---

## 1. Data Model Changes

### New Tables

```sql
-- share_events: tracks share button clicks
-- Unlike email_events (which are created before the user acts and triggered later),
-- share events are created at the moment the user clicks — no deferred trigger flow.
CREATE TABLE share_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  episode_id INTEGER NOT NULL REFERENCES episodes(id),
  user_id INTEGER REFERENCES users(id),        -- NULL for public page shares (unauthenticated)
  share_target VARCHAR NOT NULL,                -- "clipboard", "twitter", "linkedin", "native"
  user_agent VARCHAR,
  referrer VARCHAR,                             -- page URL where the share was initiated
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);

-- Indexes
CREATE INDEX index_share_events_on_episode_id ON share_events (episode_id);
CREATE INDEX index_share_events_on_user_id ON share_events (user_id);
CREATE INDEX index_share_events_on_episode_id_and_share_target ON share_events (episode_id, share_target);
```

### Modified Tables

```sql
-- Add referral_source to users for UTM attribution on signup
ALTER TABLE users
  ADD COLUMN referral_source VARCHAR;
  -- Stores the utm_source value from signup (e.g., "share")
  -- NULL for users who signed up without UTM params
```

### Active Storage Tables (Framework Setup)

Running `rails active_storage:install` creates three standard tables:

- `active_storage_blobs` — file metadata (filename, content_type, byte_size, checksum)
- `active_storage_attachments` — polymorphic join table (record_type, record_id, blob_id)
- `active_storage_variant_records` — variant tracking for image transformations

These are framework infrastructure, not feature tables. They enable `has_one_attached :og_image` on Episode.

### Models

```ruby
# app/models/share_event.rb
# Simpler than EmailEvent: share events are created synchronously when the user
# clicks share — no deferred trigger flow, no token lookup.
class ShareEvent < ApplicationRecord
  belongs_to :episode
  belongs_to :user, optional: true  # NULL for unauthenticated shares

  validates :share_target, presence: true,
            inclusion: { in: %w[clipboard twitter linkedin native] }

  scope :for_episode, ->(episode) { where(episode: episode) }
  scope :by_target, ->(target) { where(share_target: target) }
end
```

```ruby
# app/models/episode.rb (modifications)
class Episode < ApplicationRecord
  # Existing associations...
  has_many :share_events, dependent: :destroy
  has_one_attached :og_image  # Active Storage attachment for OG image

  def og_image_url
    return nil unless og_image.attached?
    Rails.application.routes.url_helpers.rails_blob_url(og_image, only_path: false)
  end

  def shareable?
    summary.present?
  end
end
```

```ruby
# app/models/user.rb (modifications)
class User < ApplicationRecord
  # Existing associations...
  has_many :share_events, dependent: :nullify  # Don't destroy tracking data

  # No new validations — referral_source is optional, free-text
end
```

### Associations Map

```
Podcast 1──* Episode 1──1 Summary
                │
                ├──* ShareEvent *──1 User (optional)
                │
                └──1 og_image (Active Storage attachment)
```

### Migration Plan

| # | Migration | Type | Notes |
|---|-----------|------|-------|
| 1 | Install Active Storage | DDL | `rails active_storage:install` — creates 3 framework tables. Standard Rails migration, safe and reversible. |
| 2 | Create share_events | DDL | New table with indexes. Standard migration. |
| 3 | Add referral_source to users | DDL | Nullable column, no backfill needed. Safe `add_column`. |

### Expected Data Volumes

| Table | Expected Records | Access Frequency | Growth Rate |
|-------|-----------------|------------------|-------------|
| share_events | ~100 in first month | Low writes (on share click), low reads (analytics) | ~50-200/month depending on adoption |
| active_storage_blobs | 1 per summarized episode | Read on every public page load (URL generation) | ~100-300/month (matches episode processing rate) |
| users.referral_source | Backfill: none. New signups only. | Write once on signup | Negligible |

---

## 2. API Endpoints

N/A — this project does not expose a JSON API. All routes serve HTML via ERB views. The share tracking endpoint below serves HTML responses (redirects) following the existing `TrackingController` pattern.

---

## 3. Backwards Compatibility

N/A — no backwards compatibility concerns for this project. Show Notes is a single-platform web app with no old client versions to support.

---

## 4. Security Design

### Authorization

| Action | Permitted Roles | Check |
|--------|----------------|-------|
| View public episode page | Anyone (no auth) | `skip_before_action :require_authentication` |
| View share button on public page | Anyone | No auth needed — share button is always visible on public page |
| View share button on authenticated pages | Authenticated users | Existing `require_authentication` on Library/Episodes controllers |
| Initiate share (POST share event) | Anyone on the public page; authenticated users on library/episode views | Rate limiting via debounce (client-side) |
| View episode in library | Authenticated user with subscription to podcast | Existing subscription scoping in `LibraryController` |
| OG image generation | System (background job) | No user-facing trigger — runs automatically after summary creation |

### New Attack Surface

| Vector | Risk | Mitigation |
|--------|------|------------|
| Episode enumeration via public URLs | Low — integer IDs reveal total episode count and allow sequential crawling | Acceptable for v1. Public pages are intentionally public. Consider slug-based URLs in a future iteration if needed. |
| Share event spam | Low — someone could POST many share events | Client-side debounce. Server-side: no sensitive data exposed. Share events are write-only from user perspective. |
| UTM parameter injection / XSS | Med — UTM params from query strings stored in `referral_source` | Sanitize UTM values before persisting. Only store `utm_source` value (a simple string), not arbitrary params. Validate length. |
| Public page data exposure | Low — summary content is intentionally public | Public page only exposes: episode title, podcast title, podcast artwork URL, summary sections, summary quotes, published_at. No user data, no management actions, no audio URLs (the public page does NOT include the audio player). |
| OG image URL predictability | Low — Active Storage URLs include a signed token | Active Storage blob URLs are signed by default. No enumeration risk. |
| CSRF on share event creation | Low | Standard Rails CSRF protection applies. Public page includes CSRF token in the form. |

### Data Exposure on Public Page

The public page intentionally exposes:
- Episode: `title`, `published_at`
- Podcast: `title`, `artwork_url`
- Summary: `sections` (all), `quotes` (all)

The public page does NOT expose:
- Audio URL (no audio player on public page — keeps the value proposition for signing up)
- User data (no user info on public pages)
- Episode description (original show notes)
- Processing status, error state, retry info
- Any management actions (archive, regenerate, retry)

---

## 5. Export Impact

N/A — no export impact.

---

## 6. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | Should the public page include the audio player? | A: Yes — full audio access on public page / B: No — audio only for authenticated users (incentive to sign up) | **B: No audio on public page.** The summary is the free sample. Audio access is the product. This creates a natural conversion step: "Want to listen? Sign up." |
| 2 | Should public pages be indexable by search engines (SEO)? | A: Yes — add `<meta name="robots" content="index, follow">` and consider a sitemap / B: No — add `<meta name="robots" content="noindex">` for v1 | **A: Yes, make indexable.** SEO drives organic traffic for free. No sitemap needed for v1 — search engines will discover pages via shared links. |
| 3 | What quote/excerpt to feature on the OG image? | A: First quote from `summary.quotes[0].text` / B: First sentence of first section's content / C: Add a new "shareable_excerpt" field to Summary (requires ClaudeClient prompt change) | **A: First quote.** Simplest, requires no model changes. Quotes are already the most compelling text in the summary. If `quotes` is empty, fall back to first sentence of first section content. |
| 4 | Feature flag strategy — the PRD mentions `shareable_episode_cards` flag, but no feature flag system exists | A: Skip the flag — deploy all-at-once behind the branch / B: Add a simple ENV var (`ENABLE_SHAREABLE_CARDS=true`) / C: Build a DB-backed feature flag system | **A: Skip the flag.** The public pages are all-or-nothing (can't selectively expose some episodes). The share button is part of the same feature. Ship it all at once when the branch merges. |

---

## 7. Alternatives Considered

### Alternative: New Action on Existing EpisodesController

**Description:** Add a `public_show` action to the existing `EpisodesController` instead of creating a new `PublicEpisodesController`.

**Pros:** Fewer controllers. All episode display logic in one place.

**Cons:** The existing `EpisodesController#show` has subscription scoping (`current_user.podcasts.exists?`). Mixing public and authenticated access in the same controller creates risk of accidentally bypassing subscription checks. Requires conditional `skip_before_action` logic which is error-prone.

**Why rejected:** Separation of concerns. A dedicated public controller with `skip_before_action :require_authentication` is the established pattern (see `TrackingController`). Cleaner to reason about security when public and authenticated access are in separate controllers.

### Alternative: Generate OG Images On-the-Fly with Caching

**Description:** Instead of pre-generating and storing OG images via Active Storage, generate them dynamically on each request and rely on HTTP caching (CDN, browser cache).

**Pros:** No storage needed. Always up-to-date with latest summary. Simpler — no background job.

**Cons:** Image generation takes ~200-500ms (artwork fetch + vips compositing). First request is slow. Social platform crawlers may timeout. Adds CPU load to the web process on every crawl.

**Why rejected:** Pre-generation in a background job is more reliable. Social platform crawlers have strict timeout requirements. A 500ms delay risks the crawler giving up and showing no preview card.

### Alternative: External OG Image Service (Vercel OG, Cloudinary)

**Description:** Use a third-party service to generate OG images from a template URL.

**Pros:** No image processing on our servers. Rich template support. CDN built-in.

**Cons:** External dependency. Per-image cost. Another service to manage. Vendor lock-in.

**Why rejected:** The `image_processing` gem and `libvips` are already available in the Docker image. No reason to add an external dependency when we have the tools locally. The OG image layout is simple enough for vips compositing.

---

## 8. Architecture Decision Records

> ADRs for significant decisions are in the `decisions/` subdirectory. Only decisions with 2+ genuinely viable alternatives are recorded here.

| ADR | Title | Summary |
|-----|-------|---------|
| [ADR-001](decisions/ADR-001-og-image-generation-approach.md) | OG Image Generation Approach | Use `image_processing` gem with vips over Puppeteer or external services — already in Gemfile and Dockerfile. |
| [ADR-002](decisions/ADR-002-og-image-storage.md) | OG Image Storage | Use Active Storage with `has_one_attached :og_image` — requires running migration but gives clean API and future flexibility. |

---

## 9. Summary

### New Routes

```ruby
# config/routes.rb additions

# Public episode pages (no auth)
resources :public_episodes, only: [:show], path: "e"
# → GET /e/:id → public_episodes#show

# Share event tracking (no auth)
post "e/:id/share", to: "public_episodes#share", as: :share_episode
# → POST /e/:id/share → records share event

# OG image endpoint (no auth, serves Active Storage redirect)
# No custom route needed — Active Storage provides rails_blob_url
```

**URL design:** Public pages use `/e/:id` (short, clean, easy to share). The authenticated `episodes#show` route (`/episodes/:id`) remains unchanged for digest email links. The two routes serve different purposes: `/episodes/:id` is the authenticated detail view, `/e/:id` is the public read-only page.

### New Layout

A `public` layout (`app/views/layouts/public.html.erb`) modeled after the `sessions` layout — minimal, no nav bar, with OG meta tags injected via `yield :head`. Includes the Show Notes footer and CTA section.

### New Background Job

`GenerateOgImageJob` — enqueued after `episode.create_summary!` in `ProcessEpisodeJob`. Fetches podcast artwork from external URL, composites with episode title + quote + branding using vips, attaches result to `episode.og_image` via Active Storage.

### Backfill Strategy

Episodes that already have summaries won't have OG images (the `GenerateOgImageJob` enqueue point is only reached on new summary creation). A one-time `lib/tasks/backfill_og_images.rake` task will iterate over episodes with summaries but no attached OG image and enqueue `GenerateOgImageJob` for each. Run after deployment.

### Visit Tracking (TRK-003)

Public page visits from shared links are tracked by reading UTM params (`utm_source`, `utm_medium`, `utm_content`) in `PublicEpisodesController#show`. When UTM params are present, the controller logs them to Rails logger at `info` level with a structured format (episode_id, utm_source, utm_medium, utm_content). This is sufficient for v1 analytics via log aggregation. A dedicated `PageVisit` model is not needed yet — if visit volume warrants it, that can be added later without changing the public page contract.

### Active Storage URL Note

`rails_blob_url` serves OG images through Active Storage's redirect controller (signed URL → 302 → blob). Most social platform crawlers (Twitter, LinkedIn, Facebook) follow redirects and this works fine. If crawler compatibility issues arise post-launch, the fallback is to use `rails_storage_proxy_url` (serves the file directly without redirect) or a dedicated controller action that streams the blob.

### New Stimulus Controller

`share_controller.js` — handles share button click, clipboard copy with confirmation toast, Twitter/LinkedIn share intent URLs, Web Share API detection and fallback. Also POSTs to the share tracking endpoint.

### Files to Create

| File | Purpose |
|------|---------|
| `db/migrate/YYYYMMDD_install_active_storage.rb` | Active Storage framework tables (via `rails active_storage:install`) |
| `db/migrate/YYYYMMDD_create_share_events.rb` | Share tracking table |
| `db/migrate/YYYYMMDD_add_referral_source_to_users.rb` | UTM attribution column |
| `app/models/share_event.rb` | Share event tracking model |
| `app/controllers/public_episodes_controller.rb` | Public episode page + share action |
| `app/views/public_episodes/show.html.erb` | Public episode page view |
| `app/views/layouts/public.html.erb` | Minimal public layout with OG meta tags |
| `app/jobs/generate_og_image_job.rb` | Background OG image generation |
| `app/services/og_image_generator.rb` | vips-based image compositing service |
| `app/javascript/controllers/share_controller.js` | Share button Stimulus controller |
| `spec/models/share_event_spec.rb` | ShareEvent model specs |
| `spec/requests/public_episodes_spec.rb` | Public page request specs |
| `spec/jobs/generate_og_image_job_spec.rb` | OG image generation job specs |
| `spec/services/og_image_generator_spec.rb` | Image generator service specs |
| `app/views/shared/_share_button.html.erb` | Reusable share button partial (used by public, library, and episode views) |
| `spec/factories/share_events.rb` | ShareEvent factory |
| `lib/tasks/backfill_og_images.rake` | One-time rake task to generate OG images for existing summarized episodes |

### Files to Modify

| File | Changes |
|------|---------|
| `app/models/episode.rb` | Add `has_many :share_events`, `has_one_attached :og_image`, `og_image_url` method, `shareable?` method |
| `app/models/user.rb` | Add `has_many :share_events` |
| `app/jobs/process_episode_job.rb` | Enqueue `GenerateOgImageJob` after `create_summary!` |
| `app/controllers/sessions_controller.rb` | Capture UTM params from query string, persist `referral_source` on user creation |
| `config/routes.rb` | Add public episode routes and share endpoint |
| `app/views/episodes/show.html.erb` | Add share button partial (PRD SHR-001: share on both public and authenticated views) |
| `app/views/library/show.html.erb` | Add share button partial (PRD SHR-001: share on both public and authenticated views) |

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: Pipeline (automated review)
### Date: 2026-02-18
### Status: Approved with Modifications

#### Must Verify
- [x] Data model is architecturally sound (tables, columns, relationships, constraints)
- [x] Public page security is correct — only intended data exposed, no user data leakage
- [x] Migration strategy is safe (Active Storage install + 2 simple migrations)
- [x] Public/authenticated controller separation is clean
- [x] OG image generation approach is appropriate (vips + Active Storage)

#### Should Check
- [x] URL design (`/e/:id` for public, `/episodes/:id` for authenticated) makes sense
- [x] Share tracking model follows established EmailEvent pattern
- [x] UTM attribution approach (referral_source on User) is sufficient
- [x] Open questions are answerable
- [x] No conflicts with in-progress work or upcoming changes

#### Modifications Applied
1. **Simplified ShareEvent model** — removed `token`, `triggered_at`, and `trigger!` method. Unlike EmailEvent (created before user acts, triggered later), share events are created synchronously when the user clicks. No deferred trigger flow needed.
2. **Added authenticated view files** — `episodes/show.html.erb` and `library/show.html.erb` added to Files to Modify for share button (PRD SHR-001 requires both public and authenticated views). Added shared `_share_button.html.erb` partial.
3. **Added TRK-003 visit tracking** — public controller logs UTM params at info level for v1 analytics. Dedicated PageVisit model deferred unless volume warrants it.
4. **Added backfill strategy** — rake task to generate OG images for existing summarized episodes.
5. **Added Active Storage URL note** — `rails_blob_url` redirect behavior documented as known limitation with social crawlers; fallback to proxy URL if needed.

#### Open Questions — Decisions
All four open questions resolved per recommendations:
1. No audio on public page (B)
2. SEO indexable (A)
3. First quote for OG image (A)
4. No feature flag — ship all at once (A)
