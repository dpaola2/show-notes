---
pipeline_stage: 1
pipeline_stage_name: discovery
pipeline_project: "shareable-episode-cards"
pipeline_started_at: "2026-02-18T08:35:12-0500"
pipeline_completed_at: "2026-02-18T08:37:28-0500"
---

# Shareable Episode Cards — Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** 2026-02-18
> **PRD:** `shareable-episode-cards/prd.md`

---

## 1. PRD Understanding

### Feature Summary

Make episode synopsis pages publicly accessible without authentication, auto-generate branded Open Graph images (1200x630) for each summarized episode, add a share button with Copy Link / Twitter / LinkedIn / Web Share API support, and track share events with UTM attribution through the magic link signup flow. This is a growth loop: user shares → follower sees branded card → clicks through to public page → reads synopsis → signs up.

### Entities Identified

| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| Episode | PUB-001 through PUB-008 | Yes | `app/models/episode.rb` |
| Summary | PUB-003, OGI-004 | Yes | `app/models/summary.rb` |
| Podcast | PUB-002, OGI-002 | Yes | `app/models/podcast.rb` |
| User | TRK-004 (UTM attribution) | Yes | `app/models/user.rb` |
| UserEpisode | (context — library/inbox flow) | Yes | `app/models/user_episode.rb` |
| EmailEvent | TRK-002 (tracking pattern reference) | Yes | `app/models/email_event.rb` |
| OG Image (attachment or model) | OGI-001 through OGI-008 | **No** | N/A — new |
| Share Event (tracking model) | TRK-001 through TRK-004 | **No** | N/A — new |

### Platforms Affected

- [x] Web (Rails) — single platform project

---

## 2. Current State: Primary Platform

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| Episode | `app/models/episode.rb` | `belongs_to :podcast`, `has_one :summary`, `has_one :transcript`, `has_many :user_episodes`, `has_many :email_events` | Core entity. `processing_status` enum tracks transcription/summarization pipeline. `guid` unique per podcast. |
| Summary | `app/models/summary.rb` | `belongs_to :episode` | JSON columns: `sections` (array of `{title, content, start_time, end_time}`), `quotes` (array of `{text, start_time, end_time}`). `before_save :update_searchable_text` extracts text for search. Validates `sections` presence and `quotes` is array. |
| Podcast | `app/models/podcast.rb` | `has_many :episodes`, `has_many :subscriptions`, `has_many :users through: :subscriptions` | Has `artwork_url` (string — external URL from RSS feed). This URL is the source for OG image artwork. |
| User | `app/models/user.rb` | `has_many :subscriptions`, `has_many :podcasts through: :subscriptions`, `has_many :user_episodes`, `has_many :email_events` | Magic link auth (`generate_magic_token!`, `magic_token_valid?`, `clear_magic_token!`). No UTM/referral tracking fields exist. |
| UserEpisode | `app/models/user_episode.rb` | `belongs_to :user`, `belongs_to :episode` | Join model with `location` enum (inbox/library/archive/trash) and `processing_status` enum. Delegates `summary`, `podcast` to episode. |
| EmailEvent | `app/models/email_event.rb` | `belongs_to :user`, `belongs_to :episode, optional: true` | Tracking model for digest email opens/clicks. Token-based, `event_type` in `[open, click]`, `link_type` in `[summary, listen]`. Pattern reference for share tracking. |

### Current Schema (Related Tables)

```sql
-- episodes
-- (from db/schema.rb)
CREATE TABLE episodes (
  id INTEGER PRIMARY KEY,
  audio_url VARCHAR,
  description TEXT,
  duration_seconds INTEGER,
  guid VARCHAR,
  last_error_at DATETIME,
  podcast_id BIGINT NOT NULL,      -- FK → podcasts
  processing_error TEXT,
  processing_status INTEGER DEFAULT 0 NOT NULL,
  published_at DATETIME,
  title VARCHAR,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- Indexes: (podcast_id, guid) UNIQUE, (podcast_id)

-- summaries
CREATE TABLE summaries (
  id INTEGER PRIMARY KEY,
  episode_id BIGINT NOT NULL,      -- FK → episodes
  sections JSON,
  quotes JSON,
  searchable_text TEXT,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- Indexes: (episode_id)

-- podcasts
CREATE TABLE podcasts (
  id INTEGER PRIMARY KEY,
  artwork_url VARCHAR,             -- External URL from RSS feed
  author VARCHAR,
  description TEXT,
  feed_url VARCHAR,
  guid VARCHAR,
  last_fetched_at DATETIME,
  title VARCHAR,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- Indexes: (feed_url) UNIQUE, (guid) UNIQUE

-- users
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  digest_enabled BOOLEAN DEFAULT TRUE NOT NULL,
  digest_sent_at DATETIME,
  email VARCHAR,
  magic_token VARCHAR,
  magic_token_expires_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- Indexes: (email) UNIQUE
-- NOTE: No UTM/referral_source columns exist

-- email_events (tracking pattern reference)
CREATE TABLE email_events (
  id INTEGER PRIMARY KEY,
  digest_date VARCHAR NOT NULL,
  episode_id INTEGER,
  event_type VARCHAR NOT NULL,     -- "open" or "click"
  link_type VARCHAR,               -- "summary" or "listen"
  token VARCHAR NOT NULL,          -- opaque tracking token
  triggered_at DATETIME,
  user_agent VARCHAR,
  user_id INTEGER NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
-- Indexes: (token) UNIQUE, (episode_id, event_type), (user_id, digest_date)
```

**Note: Active Storage tables do NOT exist in schema.rb.** The `active_storage_blobs`, `active_storage_attachments`, and `active_storage_variant_records` tables have never been created, despite Active Storage being configured in `config/environments/` and `config/storage.yml`.

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| EpisodesController | `app/controllers/episodes_controller.rb` | `show` | `require_authentication` (inherited). Also checks `current_user.podcasts.exists?(id: @episode.podcast_id)` — subscription-scoped. |
| LibraryController | `app/controllers/library_controller.rb` | `index`, `show`, `archive`, `retry_processing`, `regenerate` | `require_authentication` (inherited). Scoped to `current_user.user_episodes`. |
| SessionsController | `app/controllers/sessions_controller.rb` | `new`, `create`, `sent`, `verify`, `destroy` | `skip_before_action :require_authentication` for `new`, `create`, `sent`, `verify`. Uses `session[:return_to]` for post-login redirect. |
| TrackingController | `app/controllers/tracking_controller.rb` | `click`, `pixel` | `skip_before_action :require_authentication`. Token-based, no auth. Pattern reference for public endpoints. |
| ApplicationController | `app/controllers/application_controller.rb` | (base) | `before_action :require_authentication`. Provides `current_user`, `logged_in?` helpers. `session[:return_to]` for return-after-login. |

### Related Serializers

N/A — Show Notes does not use serializers or API endpoints. It is a traditional server-rendered Rails app using ERB views.

### Related API Endpoints (Current)

N/A — No API layer. All routes serve HTML via ERB views.

### Current API Response Examples

N/A — No API.

### Related Views

| View File | Purpose | Notes |
|-----------|---------|-------|
| `app/views/episodes/show.html.erb` | Episode detail (for digest email click-through links) | Simpler view — shows title, podcast name, summary sections/quotes, audio player. Behind auth. No OG tags. |
| `app/views/library/show.html.erb` | Episode detail (full product experience) | Full view — summary, quotes with audio-seek, original show notes, archive/regenerate actions. Behind auth. |
| `app/views/layouts/application.html.erb` | Main authenticated layout | Has `<title>`, basic meta tags, `yield :head` for content_for. Nav bar with Inbox/Library/Archive/Find/Podcasts/Settings/Logout. **No OG meta tags.** |
| `app/views/layouts/sessions.html.erb` | Unauthenticated layout (login pages) | Minimal — no nav bar. Flash messages, footer. `yield :head` available. |
| `app/views/sessions/new.html.erb` | Login/signup page | Magic link form. `form_with url: login_path`. Clean centered layout. |

**Key observation:** There are TWO episode detail views — `episodes/show` (for digest links) and `library/show` (for in-app navigation). The public page would be a third view with a different layout.

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/requests/episodes_spec.rb` | Episode show page rendering, summary display, subscription scoping, auth required | Request |
| `spec/requests/sessions_spec.rb` | Login flow, magic link creation and verification | Request |
| `spec/requests/tracking_spec.rb` | Email event click/pixel tracking (public endpoints) | Request |
| `spec/requests/library_spec.rb` | Library listing and detail page | Request |
| `spec/models/summary_spec.rb` | Summary validations, searchable text generation | Model |
| `spec/models/episode_spec.rb` | Episode validations, associations | Model |
| `spec/models/podcast_spec.rb` | Podcast validations | Model |
| `spec/models/user_spec.rb` | User validations, magic token methods | Model |
| `spec/models/email_event_spec.rb` | Email event tracking (pattern reference) | Model |
| `spec/support/authentication_helpers.rb` | `sign_in_as(user)` — stubs `current_user` via `allow_any_instance_of` | Support |

**Existing test patterns:**
- Request specs use `sign_in_as(user)` for auth
- Unauthenticated endpoints test without `sign_in_as`
- Subscription scoping tested by creating episodes for unsubscribed podcasts
- Factories exist for all core models including `summary` with realistic JSON structure

### Related Background Jobs

| Job | File | Purpose |
|-----|------|---------|
| ProcessEpisodeJob | `app/jobs/process_episode_job.rb` | Transcribes (AssemblyAI) then summarizes (Claude) an episode. Creates `Summary` record at line 34: `episode.create_summary!(sections:, quotes:)`. **This is the natural hook point for triggering OG image generation** — after `create_summary!` and before marking `processing_status: :ready`. |
| FetchPodcastFeedJob | `app/jobs/fetch_podcast_feed_job.rb` | Fetches RSS feeds, creates Episode records. Source of `artwork_url`. |
| SendDailyDigestJob | `app/jobs/send_daily_digest_job.rb` | Sends daily digest emails with episode links. Uses `EmailEvent` for tracking. |

### Related Services

| Service | File | Purpose |
|---------|------|---------|
| ClaudeClient | `app/services/claude_client.rb` | Summarization via Claude API. Returns `{sections, quotes}` hash. |
| AssemblyAiClient | `app/services/assembly_ai_client.rb` | Transcription. |
| PodcastFeedParser | `app/services/podcast_feed_parser.rb` | RSS feed parsing — extracts `artwork_url` from feeds. |

### Stimulus Controllers

| Controller | File | Purpose |
|-----------|------|---------|
| flash | `app/javascript/controllers/flash_controller.js` | Auto-dismiss flash messages |
| audio-player | `app/javascript/controllers/audio_player_controller.js` | Audio playback control |
| audio-seek | `app/javascript/controllers/audio_seek_controller.js` | Click-to-seek on quotes in library view |
| select-all | `app/javascript/controllers/select_all_controller.js` | Bulk selection (inbox) |

**Note:** No clipboard or share-related Stimulus controllers exist yet.

---

## 3. Cross-Platform Patterns

N/A — single-platform project.

---

## 4. Data Flow & Existing Patterns

### How Episode Summaries Flow Today

```
RSS Feed → FetchPodcastFeedJob → Episode (pending)
         → User triage (inbox → library) → ProcessEpisodeJob
         → AssemblyAI (transcript) → Claude (summary)
         → episode.create_summary!(sections:, quotes:)
         → user_episode.update!(processing_status: :ready)
         → User views in Library or via digest email link
```

### How Similar Features Are Structured

**Email tracking (closest pattern to share tracking):**
- `EmailEvent` model with opaque `token`, `event_type`, `episode_id`, `user_id`
- `TrackingController` with `skip_before_action :require_authentication`
- Token-based lookup, no auth needed
- Events tracked: `open` (pixel), `click` (redirect)
- `trigger!` method idempotent (checks `triggered?` first)

**This pattern maps well to share tracking** — a `ShareEvent` model could follow the same structure with `event_type` for share targets.

### Public Endpoint Pattern

Two controllers already skip authentication:
1. `SessionsController` — login/signup pages (uses `sessions` layout)
2. `TrackingController` — email tracking (no layout/view, returns redirects or GIF)

The established pattern for public pages is `skip_before_action :require_authentication`. Public pages that need a distinct look (no nav bar) use an alternate layout (see `sessions` layout).

### Layout & Head Pattern

The main layout has `yield :head` which enables `content_for(:head)` for per-page meta tags. Currently only used for `<title>`. OG meta tags can be injected via this mechanism.

### Artwork URL Pattern

Podcast artwork comes from RSS feeds as an external URL string (`podcasts.artwork_url`). The URL points to the podcast's cover image hosted externally (CDN, podcast host, etc.). Quality and size vary dramatically — from tiny favicons to high-res cover art.

---

## 5. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| Active Storage tables don't exist | Med | `image_processing` gem and `libvips` are available, but `active_storage_blobs/attachments` tables were never migrated. `has_one_attached` will fail. | Run `rails active_storage:install` migration. OR: skip Active Storage, store images on disk with a simple path column. |
| Episode subscription scoping in public context | Med | `EpisodesController#show` checks `current_user.podcasts.exists?`. A public page must bypass both auth AND subscription check. Must not accidentally expose a way to bypass subscription checks for authenticated views. | Use a separate controller (e.g., `PublicEpisodesController`) or a separate action with explicit `skip_before_action`. Do not modify the existing `EpisodesController`. |
| External artwork URL reliability | Med | OG image generation depends on fetching podcast artwork from external URLs. URLs may be broken, slow, or return unexpected content types/sizes. | Cache artwork locally on first fetch. Handle fetch failures gracefully (use placeholder image). |
| No feature flag system | Low | PRD proposes a `shareable_episode_cards` feature flag, but no feature flag infrastructure exists in the codebase. | Either build a simple DB-backed flag (boolean on a settings table) or use an environment variable. Or skip the flag entirely — deploy behind a branch and ship all at once. |
| OG image generation latency | Low | Image generation (vips compositing) adds processing time to the episode pipeline. If done synchronously, it blocks `ProcessEpisodeJob`. | Generate OG images in a separate job (e.g., `GenerateOgImageJob`) enqueued after summary creation. Fail gracefully — public page works without OG image. |
| No UTM tracking in signup flow | Low | `SessionsController#create` does `User.find_or_create_by!(email:)` with no UTM capture. `users` table has no referral columns. | Add `referral_source` or `utm_params` (JSON) column to users. Capture from `session` or params in the create action. |
| Social platform OG cache invalidation | Low | Twitter, LinkedIn, etc. cache OG images aggressively. If an image is regenerated, old caches persist. | No in-app fix. Include `og:image` URL with a cache-busting parameter (e.g., timestamp or summary updated_at). Document the limitation. |

### Performance Concerns

- **Image generation:** vips is fast for compositing, but fetching external artwork URLs could be slow. Keep in a background job.
- **Public page traffic spikes:** If a shared link goes viral, the public page could see unexpected load. Consider fragment caching or HTTP caching headers (`Cache-Control`, `ETag`).
- **N+1 on public page:** The public page loads `episode.podcast` and `episode.summary` — two joins. With `includes` this is fine, but verify.

### Security Concerns

- **Public page scope:** The public page exposes episode summaries without auth. This is intentional per the PRD, but verify that only the intended data is exposed (no user-specific data, no management actions).
- **Episode enumeration:** Public episode URLs with integer IDs (`/episodes/123`) allow enumeration. If this is a concern, consider slug-based URLs or UUIDs.
- **UTM parameter injection:** UTM params come from query strings. Validate/sanitize before persisting to avoid XSS in any future analytics dashboard.

---

## 6. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | Should the public page use a new controller (`PublicEpisodesController`) or a new action on the existing `EpisodesController`? The existing controller has subscription scoping that must not leak to public access. | Code: `episodes_controller.rb:5` | No — architecture decision |
| 2 | Should public episode URLs use integer IDs (`/episodes/123`), or a slug/token to prevent enumeration? Integer IDs are sequential and reveal total episode count. | Code: `routes.rb:55` — `resources :episodes, only: [:show]` | No — architecture decision |
| 3 | Should the public page use the existing `application` layout (with nav bar, requiring `current_user` for inbox count) or a new public layout (like the `sessions` layout)? The application layout calls `inbox_count` which requires `current_user`. | Code: `application.html.erb:48`, `application_helper.rb:36` | No — architecture decision, but note the `inbox_count` dependency |
| 4 | Should Active Storage be used for OG images (requires running migration), or a simpler approach (file on disk + path column on a model)? Active Storage adds abstraction but the tables don't exist yet. | Code: `db/schema.rb` — no AS tables | No — architecture decision |
| 5 | Summary `quotes[0].text` is the obvious default for the OG image excerpt. But some quotes may be too long or not compelling. Should Claude be asked to produce a "shareable excerpt" during summarization (PRD Q4 option c)? This would change `ClaudeClient` prompts and `Summary` schema. | Code: `claude_client.rb:8-27` | No — can be deferred to a later enhancement |
| 6 | The `ProcessEpisodeJob` is the hook for OG image generation. Should image generation be inline (after `create_summary!`) or a separate job? Inline is simpler but couples concerns. Separate job is more resilient. | Code: `process_episode_job.rb:34-37` | No — architecture decision |
| 7 | How should the public page handle episodes where the podcast artwork URL is broken or missing? The `podcasts.artwork_url` column is nullable. ~Some podcasts may have no artwork. | Code: `db/schema.rb:51` — `artwork_url` is nullable | No — architecture decision (placeholder image) |

---

## 7. Recommendations for Architecture Stage

- **Follow the `TrackingController` pattern for public endpoints** — `skip_before_action :require_authentication` is the established way to make endpoints public. Use a separate controller to avoid contaminating existing subscription-scoped logic.
- **Use the `sessions` layout as inspiration for a public layout** — it's already a minimal, no-nav-bar layout for unauthenticated users. The public episode page needs something similar but with OG meta tags and the CTA.
- **Enqueue a separate `GenerateOgImageJob` after summary creation** rather than adding image generation inline in `ProcessEpisodeJob`. This follows the existing pattern of focused, single-responsibility jobs.
- **Use `image_processing` gem with vips** — already in Gemfile with `libvips` in Docker. No new dependencies needed for image compositing. Avoid Puppeteer/browser-based solutions (adds major Docker complexity).
- **Model share tracking after `EmailEvent`** — same token-based, event-type pattern. Proven in this codebase.
- **Consider Active Storage** for OG image attachment on Episode/Summary — the migration is one command away and the gems are ready. But a simple `og_image_path` column would also work for v1.
- **The `yield :head` / `content_for(:head)` pattern** is already in the layout for injecting per-page meta tags. Use this for OG tags.
- **Extend the `sessions/new` signup page** to accept UTM params via query string and persist them through the magic link flow (store in session, save on user after verification).
