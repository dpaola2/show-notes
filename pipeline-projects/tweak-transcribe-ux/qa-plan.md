---
pipeline_stage: 7
pipeline_stage_name: qa-plan
pipeline_project: "tweak-transcribe-ux"
pipeline_started_at: "2026-02-10T07:45:05-0500"
pipeline_completed_at: "2026-02-10T07:45:30-0500"
---

# QA Plan — Transcription Resilience & Retry UX

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-10
> **Branch:** `pipeline/tweak-transcribe-ux`
> **PR:** TBD
> **Gameplan:** `~/projects/show-notes/pipeline-projects/tweak-transcribe-ux/gameplan.md`
> **Progress:** `~/projects/show-notes/pipeline-projects/tweak-transcribe-ux/progress.md`

---

## 1. Feature Summary

This project closes error handling gaps in the transcription pipeline that caused episodes to become permanently stuck in `transcribing` state during bulk OPML imports. It adds Solid Queue concurrency throttling (limit 3 concurrent transcription jobs), a recurring stuck-job detector, and consistent error/retry UX across both Inbox and Library tabs. The core problem — AssemblyAI rate limit errors bypassing error handlers — is now caught and surfaced to users with retry capability.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Data Model & Core Error Handling | `7bc178b` |
| M2 | Stuck Job Detection | `ddeaf87` |
| M3 | Inbox Tab — Processing Status & Retry | `2ccc842` |
| M4 | Library Tab — Enhanced Error Display & Retry | `5049b27` |
| M5 | QA Test Data | `c906bd4` |
| M6 | Edge Cases & Polish | (no commit — behaviors implemented by M1-M4) |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total project tests** | 75 |
| **Passing** | 75 |
| **Failing** | 0 |
| **Test files** | 7 |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Job spec | `spec/jobs/process_episode_job_spec.rb` | 18 | Error handling, retry, concurrency, happy path, idempotency, shared transcript skip |
| Job spec | `spec/jobs/auto_process_episode_job_state_tracking_spec.rb` | 12 | Episode-level state tracking, error handling, concurrency, multi-subscriber |
| Job spec | `spec/jobs/detect_stuck_processing_job_spec.rb` | 12 | Stuck detection for UserEpisode + Episode, threshold boundary, idempotency |
| Model spec | `spec/models/episode_processing_spec.rb` | 6 | processing_status enum, processing_error, last_error_at columns |
| Model spec | `spec/models/user_episode_retry_spec.rb` | 6 | retry_processing! method behavior, field resets |
| Request spec | `spec/requests/inbox_retry_spec.rb` | 11 | Retry action, status display, security scoping, Add to Library on error |
| Request spec | `spec/requests/library_retry_spec.rb` | 12 | Retry action, error display, retry count, regenerate compat, security, M6 edge cases |

### What Automated Tests Verify
- All exception types caught by both ProcessEpisodeJob and AutoProcessEpisodeJob (ERR-001)
- Rate limit errors include "rate limit" in the error message (ERR-003)
- Stuck job detection transitions timed-out episodes to error (ERR-002)
- Solid Queue concurrency declarations exist on both job types (THR-001/THR-002)
- Exponential backoff retry scheduling (up to 5 retries)
- Inbox retry action resets state, enqueues job, redirects (INB-003)
- Library retry action resets state, enqueues job, redirects (LIB-001)
- Error message and retry count display (LIB-001, LIB-002)
- Security: retry actions scoped to current_user (RecordNotFound for other users)
- Regenerate action still works for ready episodes
- Concurrent retry idempotency (no duplicate API calls)
- Multi-subscriber transcription (one API call serves all)

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/show-notes
RAILS_ENV=development bundle exec rails db:migrate    # ensure M1 migration is applied
RAILS_ENV=development bundle exec rake seed:transcription_resilience
```

The task prints a magic link for login (valid 15 minutes). Re-run to refresh the token.

### Scenarios Seeded

| Scenario | Location | Data Created | Purpose |
|----------|----------|--------------|---------|
| Pending episode | Inbox + Library | Episode in `pending` state | Verify pending status display |
| Downloading episode | Inbox | Episode in `downloading` state | Verify downloading status display |
| Transcribing episode | Inbox + Library | Episode in `transcribing` state | Verify in-progress display |
| Summarizing episode | Inbox + Library | Episode in `summarizing` state | Verify in-progress display |
| Ready episode (with summary) | Inbox + Library (x2) | Episode with transcript + summary | Verify ready state, View Summary, Regenerate |
| Rate limit error | Inbox + Library | Episode with rate limit error message, retry_count 2-3 | Verify error display, retry count, Retry button |
| Generic API error | Inbox + Library | Episode with connection error | Verify generic error display |
| Timeout error | Inbox | Episode with "Processing timed out" message | Verify timeout error display |
| Max retries exhausted | Library | Episode with retry_count=5, final error message | Verify max retry display |
| Stuck — transcribing | Library | Episode in `transcribing`, updated_at 1 hour ago | Verify DetectStuckProcessingJob recovery |
| Stuck — summarizing | Inbox | Episode in `summarizing`, updated_at 2 hours ago | Verify DetectStuckProcessingJob recovery |

### Post-Seed Verification
- [ ] Navigate to `/auth/verify?token=<token>` and verify login works
- [ ] Navigate to `/inbox` and verify 9 episodes with mixed statuses
- [ ] Navigate to `/library` and verify 9 episodes with mixed statuses

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Inbox — Processing Status Display

#### QA-001: Inbox shows processing status for all states
**Criteria:** INB-001
**Steps:**
1. Run the seed task and log in via magic link
2. Navigate to `/inbox`
3. Scan through the episode list

**Expected:** Each episode shows its processing status below the podcast name:
- Pending episodes: yellow "Pending..." text
- Downloading episodes: yellow "Downloading audio..." text
- Transcribing episodes: yellow "Transcribing..." text
- Summarizing episodes: yellow "Generating summary..." text
- Ready episodes: green "Ready" text
- Error episodes: red "Failed: [error message]" text

---

#### QA-002: Inbox error episodes show Retry button
**Criteria:** INB-002
**Steps:**
1. On the Inbox page, locate an episode with a red error message
2. Verify a "Retry" button is visible

**Expected:** The Retry button is styled distinctly (red background, white text) and appears alongside the Add to Library / Skip buttons.

---

#### QA-003: Inbox Retry resets state and enqueues job
**Criteria:** INB-003
**Steps:**
1. On the Inbox page, click "Retry" on an errored episode (e.g., "Inbox — Rate Limit Error")
2. Observe the redirect and flash notice

**Expected:**
- Page redirects to `/inbox` with notice "Retrying transcription..."
- The episode now shows "Pending..." status (not error)
- In the Rails server logs, a `ProcessEpisodeJob` was enqueued

---

#### QA-004: Add to Library works on errored episode
**Criteria:** INB-004
**Steps:**
1. On the Inbox page, locate an errored episode
2. Click "Add to Library"

**Expected:**
- Episode moves to Library (disappears from Inbox)
- Navigate to `/library` — the episode appears with "Pending..." status (move_to_library! resets to pending and re-enqueues)

---

### 4.2 Library — Error Display & Retry

#### QA-005: Library index shows error message and retry count
**Criteria:** LIB-001, LIB-002
**Steps:**
1. Navigate to `/library`
2. Locate episodes in error state

**Expected:**
- Error episodes show red "Failed: [specific error message]" text
- Episodes with retry_count > 0 show "(attempt N)" after the error message
- A red "Retry" button is visible below the error text

---

#### QA-006: Library Retry resets state
**Criteria:** LIB-001
**Steps:**
1. On the Library page, click "Retry" on an errored episode
2. Observe the redirect and flash notice

**Expected:**
- Page redirects back to Library with notice "Retrying transcription..."
- The episode now shows "Pending..." status

---

#### QA-007: Library show page — error state with Retry
**Criteria:** LIB-001
**Steps:**
1. Navigate to `/library` and click on an errored episode title to view the show page
2. Observe the error display

**Expected:**
- Red alert box shows "Processing failed: [error message]"
- A red "Retry" button is visible inside the alert
- Clicking Retry redirects back with notice "Retrying transcription..."

---

#### QA-008: Library show page — Regenerate on ready episode
**Criteria:** LIB-001 (regenerate compatibility)
**Steps:**
1. Navigate to `/library` and click on a ready episode (one with a summary)
2. Scroll to the bottom action buttons

**Expected:**
- "Mark as Done" and "Regenerate Summary" buttons are visible
- Clicking "Regenerate Summary" redirects with notice "Regenerating summary..." and re-processes the episode

---

#### QA-009: Library show page — retry debug info on retrying episode
**Criteria:** Visual verification
**Steps:**
1. Navigate to Library and click "Retry" on an errored episode
2. Quickly navigate to that episode's show page while it's processing

**Expected:**
- If the episode is in a processing state with `next_retry_at` set, a yellow debug panel shows retry attempt count, next retry time, and time until retry

---

### 4.3 Stuck Job Detection

#### QA-010: DetectStuckProcessingJob recovers stuck episodes
**Criteria:** ERR-002
**Steps:**
1. Run the seed task (creates 2 stuck episodes)
2. Verify stuck episodes show "Transcribing..." / "Generating summary..." in the UI
3. Open a Rails console: `RAILS_ENV=development bundle exec rails console`
4. Run: `DetectStuckProcessingJob.perform_now`
5. Refresh the Inbox and Library pages

**Expected:**
- The previously-stuck episodes now show error state with message "Processing timed out after 30 minutes and 1 second"
- Retry buttons appear for both stuck episodes

---

#### QA-011: Stuck job detection is idempotent
**Criteria:** ERR-002 (idempotency)
**Steps:**
1. After QA-010, run `DetectStuckProcessingJob.perform_now` again in the console
2. Refresh pages

**Expected:** No change — episodes already in error state are not modified. Error messages remain the same.

---

### 4.4 Concurrency Throttling

#### QA-012: OPML import throttles transcription jobs
**Criteria:** THR-001, THR-002, THR-003
**Steps:**
1. This requires a real OPML file with 10+ podcast subscriptions
2. Import the OPML file and select all podcasts as favorites
3. Navigate to Library and observe the status of enqueued episodes

**Expected:**
- At most 3 episodes show "Transcribing..." simultaneously
- Remaining episodes show "Pending..." (waiting for a slot)
- As transcriptions complete, pending episodes begin processing
- No rate limit errors under normal conditions

**Note:** This is difficult to verify without real AssemblyAI calls. The key verifiable behavior is that Solid Queue's `limits_concurrency` is declared on both job classes (verified by automated tests). The throttling behavior can be observed in the Solid Queue dashboard or logs.

---

### 4.5 Error Handling — Rate Limits

#### QA-013: Rate limit error includes actionable message
**Criteria:** ERR-003
**Steps:**
1. Verify in the seed data that rate limit error episodes show a message containing "AssemblyAI rate limit exceeded"

**Expected:** The error message includes "rate limit" language, not a generic "API error" message. This is visible on both the Inbox and Library error displays.

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Retry while API is still rate-limited | Click Retry on rate-limited episode; if AssemblyAI is still rate-limited, the job will fail again | Error message updates with incremented retry count; job schedules another retry with exponential backoff | PRD edge case |
| 2 | Multiple episodes fail simultaneously | Verify seed data shows multiple errored episodes in both Inbox and Library | Each episode shows its own error message and individual Retry button | M6 |
| 3 | Retry spam (click Retry multiple times) | Rapidly click Retry on an errored episode | Only one ProcessEpisodeJob runs; Solid Queue concurrency limit prevents flood; ProcessEpisodeJob checks for existing transcript/summary before calling APIs | Architecture §8 |
| 4 | Episode shared across users (transcript reuse) | Two users add the same podcast episode; one processes first | Second user's ProcessEpisodeJob skips transcription (transcript already exists from first user) and proceeds directly to summarization | M6 |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| AssemblyAI usage dashboard / quota monitoring | Out of scope | No visibility into API usage beyond error messages |
| Alternative transcription provider fallback | Out of scope | Single provider (AssemblyAI) only |
| Bulk retry (retry all failed episodes at once) | Out of scope | Individual retry per episode — sufficient for current scale |
| Webhook/push notification on failure | Out of scope | Users discover errors on next page visit |
| Turbo Streams for real-time status updates | Not implemented | Page shows "This page will update when ready" but does not auto-refresh — user must manually reload |
| Pre-existing test issue | Known | `opml_import_service_spec.rb:203` cumulative matcher fails in full suite, passes in isolation — not a regression |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| OPML Import flow | Low | Verify `process_favorites` still enqueues jobs correctly — throttling is transparent via Solid Queue |
| Library Regenerate action | Low | Verify "Regenerate Summary" on a ready episode's show page still works (distinct from new retry_processing action) |
| Inbox Add to Library / Skip | Low | Verify these actions still work for episodes in all states (the view template was modified) |
| Library pagination | Low | Verify pagination still works on `/library` with mixed status episodes |
| Existing ProcessEpisodeJob retry behavior | Med | The job was modified (added `limits_concurrency`, improved error messages). Verify existing retry/backoff works — automated tests cover this |
| test.rb `show_exceptions` change | Low | Changed from `:rescuable` to `:none`. No existing tests relied on 404 rendering, but verify any new request specs that test 404 behavior use `expect(response).to have_http_status(:not_found)` pattern |
| AutoProcessEpisodeJob (rewritten) | Med | Complete rewrite for episode-level state tracking. Verify feed fetch → auto-process → ready flow works end-to-end with real data |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag — rollback requires code revert | Direct ship; revert the branch merge if issues found |
| Migration | Reversible — `rails db:rollback` removes the 3 columns from episodes | Episodes created with processing_status data lose those columns; no data loss for transcripts/summaries |
| Data cleanup | Not needed | New columns are additive. Existing data is unchanged. Backfilled episodes (processing_status = ready) return to default (pending) on rollback, but this is cosmetic — transcripts and summaries remain intact |
| Recurring job | Remove `detect_stuck_processing` entry from `config/recurring.yml` | Job stops scheduling on next Solid Queue restart |
| Routes | Revert `retry_processing` routes | Existing bookmarks/links to retry_processing will 404 — acceptable |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-013)
- [ ] Edge cases tested (5 scenarios)
- [ ] Regression areas checked (7 areas)
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
