# Long-Lived Authentication — Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** 2026-02-08
> **PRD:** `long-lived-authentication/prd.md`
> **Discovery Report:** `long-lived-authentication/discovery-report.md`
> **Approved Architecture:** `long-lived-authentication/architecture-proposal.md`

---

## 1. Project Overview

### Goals
- Sessions persist across browser restarts — no more re-entering email + magic link after closing the browser
- Digest email links land on episode content in one tap (when already authenticated)
- When not authenticated, magic-link auth redirects back to the originally requested page

### Scope Summary

| Description | Platform |
|-------------|----------|
| Session cookie persistence (`expire_after: 1.year`) | Web |
| Return-to URL after authentication | Web |
| Request specs for both behaviors | Web |

### Out of Scope
- Database-backed sessions
- "Log out everywhere" / session revocation (SEC-002 — deferred)
- "Remember me" checkbox on login form
- Password-based authentication, OAuth, 2FA
- Session activity audit log

### Constraints & Conventions
- Conventions file: `CLAUDE.md` (Show Notes repo root)
- Rails 8.1 cookie store with `force_ssl: true` in production
- No new models or migrations

---

## 2. Open Questions & Decisions

> Resolved during Stages 0-2 (PRD + Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| Cookie-only vs. database-backed sessions? | Resolved | Cookie-only. `expire_after` on the existing cookie store. |
| Session lifetime? | Resolved | 1 year (`expire_after: 1.year`) |
| Return-to URL in scope? | Resolved | Yes — promoted to Must (DIG-002) |
| "Log out everywhere" in scope? | Resolved | No — deferred. Not feasible with cookie-only, overkill for single-user. |
| "Remember me" checkbox? | Resolved | No — persistence is the default. Checkbox adds friction with no upside for single-user app. |

---

## 3. Functional Milestones

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented (Stage 1)
- [x] Architecture proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 0-2)

---

### M1: Session Persistence + Return-To URL
**What:** Configure the session cookie to persist across browser restarts and add return-to URL handling so users are redirected back to the page they were trying to access after authenticating.
**Size:** S (1 new file, 2 modified files, ~7 lines of implementation code)

**Acceptance Criteria:**
- [ ] SES-001: After successful magic-link verification, the session persists across browser restarts (cookie has `Expires`/`Max-Age` attribute set to 1 year)
- [ ] SES-002: Session lifetime is configured to 1 year via `expire_after: 1.year`
- [ ] SES-003: Multiple browsers/devices can maintain concurrent sessions (each browser has its own cookie — inherent to cookie store, verify no conflicts)
- [ ] SES-005: Logout (`DELETE /logout`) destroys only the current browser's session (existing `session.delete(:user_id)` behavior unchanged)
- [ ] DIG-001: A user with an active session clicking a tracked digest email link lands directly on the episode page with no auth interruption
- [ ] DIG-002: A user without an active session clicking a tracked digest email link is redirected to login, and after magic-link auth, is redirected back to the episode page (not the root path)
- [ ] DIG-002 (GET-only): Return-to URL is only stored for GET requests, not POST/PATCH/DELETE
- [ ] DIG-002 (cleanup): Stored return-to URL is consumed (deleted from session) after redirect, preventing stale redirects on subsequent logins
- [ ] SEC-001: Session cookie is encrypted via Rails' `secret_key_base` (inherent to cookie store — verify no regression)
- [ ] Existing logout behavior is unchanged (user is redirected to login page, session is cleared)
- [ ] Existing magic-link flow is unchanged (email entry, token generation, token verification all work as before)

**Web:**
- [ ] Create `config/initializers/session_store.rb` — `expire_after: 1.year`
- [ ] Modify `app/controllers/application_controller.rb` — add `session[:return_to] = request.original_url if request.get?` in `require_authentication`
- [ ] Modify `app/controllers/sessions_controller.rb` — change `redirect_to root_path` to `redirect_to session.delete(:return_to) || root_path` in `verify` action
- [ ] Add request specs: session persistence behavior, return-to URL redirect after auth, return-to URL not stored for non-GET requests, return-to URL consumed after use

**iOS:** N/A
**Android:** N/A

**Dependencies:** None

---

### M2: QA Test Data
**What:** Verify the feature can be manually tested. Since this is a session configuration change with no new data, QA validation is done by running through the auth flows manually. No seed task needed — the feature is exercised by logging in and clicking digest links.

**Acceptance Criteria:**
- [ ] Document manual QA steps in this milestone's completion notes (login, close browser, reopen, verify still authenticated; click digest link while authenticated; click digest link while not authenticated and verify redirect back)
- [ ] Verify existing specs pass: `bundle exec rspec spec/requests/sessions_spec.rb`
- [ ] Verify all specs pass: `bundle exec rspec`

**Web:**
- [ ] Run full test suite and confirm no regressions
- [ ] Manual verification of session persistence (if dev server available)

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> No data model or API changes. Architecture approved with zero schema modifications.

- [x] Architecture proposal approved: `long-lived-authentication/architecture-proposal.md`
- [x] Milestones correctly reference the approved design (session config + controller changes only)
- [x] No contradictions between gameplan and approved architecture

### Security & Access Control
- [x] No new data access paths — `current_user` reads `session[:user_id]` as before
- [x] Session cookie encrypted by Rails' `secret_key_base`
- [x] `force_ssl: true` in production ensures `Secure` cookie flag
- [x] Rails 8.1 defaults: `HttpOnly: true`, `SameSite: Lax`
- [x] Return-to URL uses `request.original_url` (always same-host) + `redirect_to` with `allow_other_host: false` (Rails 8.1 default) — no open redirect risk
- [x] No new attack surfaces identified

### Performance
- [x] No new queries, no new data, no performance impact
- [x] Caching needed? No
- [x] N+1 query risks: None

### Observability & Debuggability
- [x] No new logging needed — session persistence is transparent to the application
- [x] Debug path: check browser cookie inspector for session cookie `Expires` attribute
- [x] Alerts needed? No

### Analytics & Instrumentation

#### Success Metrics
- N/A — success is measured by "Dave stops requesting magic links multiple times per week." No in-app analytics needed.

#### Events to Track
_Show Notes has no event tracking infrastructure. No events to track._

#### Instrumentation Approach
- [x] Framework: None — no tracking infrastructure
- [x] Implementation location: N/A

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Request specs | Session persistence (cookie expiry), return-to URL (stored, consumed, GET-only), existing auth flow regression | Rails | Pipeline |
| Manual QA | Login, close browser, reopen, verify auth persists; digest link click flows | Web | Human |

### Feature Flags & Rollout
- [x] No feature flag needed — single-user app, immediately beneficial
- [x] Rollback plan: remove `session_store.rb` initializer + revert controller changes, redeploy

### Mobile-Specific
- N/A — Level 1 web-only project

### Legacy & Migration
- [x] One-time re-authentication required after deploy (existing session cookies lack `Expires` attribute)
- [x] Acceptable for single-user app

### Export/Reporting
- [x] N/A — no exports affected

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| Secret key rotation invalidates all sessions | Low | Documented. Re-auth is one magic link away. |
| Cookie cleared by browser or user | Low | Expected behavior — user re-authenticates. |
| Existing session specs may need adjustment for `expire_after` behavior | Low | Review existing specs; add new specs alongside. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 | M1 (session persistence + return-to URL) | No flag | Dave (single user) |

### Done Criteria
- [ ] All acceptance criteria met
- [ ] All specs passing (`bundle exec rspec`)
- [ ] Session cookie has `Expires` attribute in browser (manual check)
- [ ] Digest email link → episode works without re-auth (manual check)

---

## 7. Estimates

| Milestone | Size | Notes |
|-----------|------|-------|
| M0: Discovery & Alignment | Done | Pipeline Stages 0-2 |
| M1: Session Persistence + Return-To URL | S | 1 new file, 2 modified files, ~7 lines of implementation + request specs |
| M2: QA Verification | S | Test suite run + manual verification only |

---

## PRD Traceability Matrix

| PRD Requirement ID | Milestone | Acceptance Criterion |
|-------------------|-----------|---------------------|
| SES-001 | M1 | Session persists across browser restarts |
| SES-002 | M1 | Session lifetime configured to 1 year |
| SES-003 | M1 | Multiple browsers maintain concurrent sessions |
| SES-004 | M1 | Inherent to cookie store — logout on one device doesn't affect others (verified by SES-005 criterion) |
| SES-005 | M1 | Logout destroys only the current browser's session |
| DIG-001 | M1 | Authenticated user clicks digest link → lands on episode directly |
| DIG-002 | M1 | Unauthenticated user clicks digest link → login → redirect back to episode |
| SEC-001 | M1 | Session cookie encrypted via Rails secret_key_base |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2/8/2026
### Status: Approved

#### Must Verify
- [ ] Milestone breakdown is logical and correctly sequenced
- [ ] Acceptance criteria are specific and testable
- [ ] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [ ] Non-functional requirements checklist is fully addressed
- [ ] Dependencies form a valid DAG (no circular dependencies)
- [ ] Milestone sizes are appropriate (no XL milestones that should be split)
- [ ] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-08 | Pipeline | Initial gameplan generated |
