# QA Plan — Long-Lived Authentication

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-08
> **Branch:** `pipeline/long-lived-authentication`
> **PR:** TBD
> **Gameplan:** `long-lived-authentication/gameplan.md`
> **Progress:** `long-lived-authentication/progress.md`

---

## 1. Feature Summary

Session cookies now persist across browser restarts (1-year expiry) so the user doesn't need to re-enter their email and request a magic link every time the browser closes. Additionally, when an unauthenticated user visits a protected page (e.g., clicking a digest email link), they're redirected back to the original page after completing the magic-link login flow instead of always landing on the inbox.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Session Persistence + Return-To URL | `6441141` |
| M2 | QA Verification (no code) | N/A |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **New tests** | 10 |
| **Existing session tests** | 19 |
| **Failing** | 0 |
| **Test files** | 1 new (`session_persistence_spec.rb`) + 1 existing (`sessions_spec.rb`) |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Request specs | `spec/requests/session_persistence_spec.rb` | 10 | Return-to URL (store, consume, GET-only, stale prevention), digest email flows, session maintenance, logout |
| Request specs | `spec/requests/sessions_spec.rb` | 19 | Existing magic-link auth flow regression (login, verify, logout, error cases) |

### What Automated Tests Verify
- Return-to URL is stored when unauthenticated user visits a protected GET page
- Return-to URL is consumed (deleted) after successful auth redirect
- Return-to URL is NOT stored for POST or DELETE requests
- Stale return-to URLs don't persist across logout/re-login cycles
- Digest email tracking link → auth → redirect back to episode
- Authenticated user clicking digest link lands directly on episode
- Session persists across multiple requests after auth
- Logout clears session correctly
- Full magic-link flow (unchanged from before)

---

## 3. Test Data Setup

No seed task was created — this feature modifies session behavior and requires no special data. Testing uses the existing Show Notes account and daily digest emails.

**Prerequisites:**
- A Show Notes account with at least one podcast subscription
- At least one digest email received (for testing digest link flows)
- Access to two devices/browsers (for concurrent session testing)

---

## 4. Manual Testing Checklist

### 4.1 Session Persistence

#### QA-001: Session survives browser restart
**Criteria:** SES-001, SES-002
**Steps:**
1. Open Show Notes in a browser (e.g., Safari on Mac)
2. Log in via magic link
3. Verify you land on the inbox and are authenticated
4. **Completely quit the browser** (Cmd+Q on Mac, not just close tab)
5. Reopen the browser
6. Navigate to Show Notes

**Expected:** You are still logged in. No login page. Inbox loads directly.

---

#### QA-002: Session persists across device sleep/wake
**Criteria:** SES-001
**Steps:**
1. Open Show Notes on your phone (Safari on iOS)
2. Log in via magic link
3. Lock the phone / let it sleep for at least 5 minutes
4. Wake the phone and open Safari
5. Navigate to Show Notes (or switch to the existing tab)

**Expected:** You are still logged in. No re-authentication required.

---

#### QA-003: Concurrent sessions on multiple devices
**Criteria:** SES-003
**Steps:**
1. Log in to Show Notes on your laptop browser
2. Log in to Show Notes on your phone browser (same email, separate magic link request)
3. Verify both devices show the inbox and are authenticated
4. Navigate around on both devices

**Expected:** Both devices are independently logged in and functional.

---

#### QA-004: Logout on one device doesn't affect the other
**Criteria:** SES-004, SES-005
**Steps:**
1. With both devices logged in (from QA-003)
2. Log out on your phone (click "Log out")
3. Verify the phone shows the login page
4. On your laptop, refresh the page

**Expected:** Laptop is still logged in. Phone requires re-authentication.

---

#### QA-005: Cookie has correct expiry attribute
**Criteria:** SES-002
**Steps:**
1. Log in to Show Notes in Chrome or Safari
2. Open browser developer tools → Application (Chrome) or Storage (Safari) → Cookies
3. Find the `_show_notes_session` cookie
4. Check the `Expires` / `Max-Age` column

**Expected:** Cookie has an `Expires` date approximately 1 year in the future (not "Session" / blank).

---

### 4.2 Digest Email → Episode Flow

#### QA-006: Digest link lands directly on episode (already authenticated)
**Criteria:** DIG-001
**Steps:**
1. Ensure you are logged in to Show Notes in your browser
2. Open a daily digest email
3. Click "Read summary" for any episode

**Expected:** You land directly on the episode summary page. No login page appears. One tap from email to content.

---

#### QA-007: Digest link redirects back to episode after auth (not authenticated)
**Criteria:** DIG-002
**Steps:**
1. Log out of Show Notes (or clear cookies / use incognito)
2. Open a daily digest email
3. Click "Read summary" for any episode
4. You should see the login page — enter your email
5. Check your email for the magic link and click it

**Expected:** After clicking the magic link, you land on the **episode page** you originally clicked (NOT the inbox). The "Welcome back!" message appears.

---

#### QA-008: Digest link from email app's embedded browser
**Criteria:** PRD Edge Case (embedded browser)
**Steps:**
1. Open a daily digest email in your phone's email app (e.g., Apple Mail, Gmail app)
2. Tap "Read summary" — the link opens in the email app's built-in browser
3. Observe whether you're authenticated or hit the login page

**Expected:** You likely hit the login page (embedded browsers don't share cookies with Safari/Chrome). This is a known limitation — the embedded browser has its own cookie jar. After authenticating in the embedded browser, you should land on the episode page (DIG-002 return-to).

---

### 4.3 Logout & Security

#### QA-009: Logout still works correctly
**Criteria:** SES-005
**Steps:**
1. Log in to Show Notes
2. Click "Log out" (in the navigation)
3. Verify you see the login page with "You have been logged out" message
4. Try to navigate to the inbox (e.g., enter the URL directly)

**Expected:** You are redirected to the login page. Session is destroyed.

---

#### QA-010: Session cookie is secure in production
**Criteria:** SEC-001
**Steps:**
1. In production (listen.davepaola.com), open developer tools → Cookies
2. Find the `_show_notes_session` cookie
3. Check the cookie attributes

**Expected:** Cookie flags show: `Secure` (HTTPS only), `HttpOnly` (not accessible from JavaScript), `SameSite=Lax`.

---

### 4.4 Return-To URL Behavior

#### QA-011: Direct navigation to login (no return-to)
**Criteria:** DIG-002 (cleanup)
**Steps:**
1. Log out of Show Notes (or clear cookies)
2. Navigate directly to the login page (not redirected from another page)
3. Enter your email and click the magic link

**Expected:** After auth, you land on the **inbox** (root path), not some stale URL.

---

#### QA-012: Settings page return-to
**Criteria:** DIG-002
**Steps:**
1. Log out of Show Notes
2. Navigate directly to `/settings` in the URL bar
3. You should be redirected to the login page
4. Enter your email and click the magic link

**Expected:** After auth, you land on the **settings page** (not the inbox).

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Browser clears cookies (user or browser setting) | Clear cookies for the site, then visit | Login page appears; must re-authenticate | SES-001 |
| 2 | Incognito / private browsing | Open incognito, log in, close incognito, reopen | Session does NOT persist (browser discards cookies) | PRD edge case |
| 3 | Multiple tabs open during logout | Open 3 tabs while logged in, logout in one, refresh others | All tabs redirect to login (same cookie) | PRD edge case |
| 4 | Magic link clicked while already logged in | Log in, then click a new magic link from email | Session refreshed, user stays logged in, lands on root or return-to URL | PRD edge case |

---

## 6. Known Limitations

| Item | Status | Notes |
|------|--------|-------|
| "Log out everywhere" (SEC-002) | Deferred | Not feasible with cookie-only sessions. Workaround: user clears cookies on each device individually, or secret key rotation (deploy). |
| Email app embedded browsers | Known limitation | Embedded browsers (Gmail app, Apple Mail in-app browser) have separate cookie jars — sessions don't transfer from/to the main browser. |
| Session activity audit log | Out of scope | No visibility into which devices are logged in. |
| Password-based auth, OAuth, 2FA | Out of scope | Show Notes is magic-link only. |

---

## 7. Regression Concerns

| Area | Risk | What to Check |
|------|------|---------------|
| Magic-link auth flow | Low | Login, token generation, verification, error cases all work as before (covered by 19 existing automated tests) |
| Logout | Low | Session is properly cleared (covered by automated tests) |
| Tracking links | None | `TrackingController` skips auth — unchanged |
| OPML import session state | Low | Import uses `session[:import_podcast_ids]` etc. — verify import flow still works after session store config change |
| Settings page | None | No changes to settings controller or views |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Code revert | Delete `config/initializers/session_store.rb`, revert the 2 controller changes, redeploy | Sessions revert to browser-session cookies (die on browser close) |
| Migration | N/A | No migrations to revert |
| Data cleanup | None needed | No new data was stored. Cookie contents are unchanged (still `session[:user_id]`). |
| User impact | One-time re-auth | After revert, existing persistent cookies will be replaced by session cookies on next request. User logs in once. |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-012)
- [ ] Edge cases tested
- [ ] Regression areas checked
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
