# QA Plan — Phase 2 Onboarding

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** 2026-02-08
> **Branch:** `pipeline/onboarding`
> **PR:** TBD
> **Gameplan:** `onboarding/gameplan.md`
> **Progress:** `onboarding/progress.md`

---

## 1. Feature Summary

Phase 2 Onboarding transforms the Show Notes daily digest from a notification ("stuff is waiting in the app") into a standalone newsletter ("here's what your podcasts are about today") with AI summaries for every episode. It adds automatic episode processing (transcription + summarization) triggered on feed poll, engagement tracking via email open pixel and click redirect links, and a new subscription-scoped episode detail page. The goal is to validate Job B: "Get value from your entire podcast feed, even the episodes you'll never have time to listen to."

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Tracking Infrastructure & Episode Route | `7c16ef6` |
| M2 | Auto-Processing Pipeline | `4453131` |
| M3 | Digest Email Redesign | `c7fa7ff` |
| M4 | Onboarding Flow Updates | N/A (verification) |
| M5 | QA Test Data | `c52a4f8` |
| M6 | Edge Cases & Polish | `84ae1f6` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests (feature)** | 126 |
| **Passing** | 126 |
| **Failing** | 0 |
| **Test files** | 10 (1 factory + 7 new specs + 2 updated existing specs) |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Model specs | `spec/models/email_event_spec.rb` | 20 | Validations, associations, scopes, trigger! method |
| Model specs | `spec/models/summary_spec.rb` | 8 | Updated quotes validation (allows empty arrays) |
| Request specs | `spec/requests/tracking_spec.rb` | 14 | Click redirect, open pixel, auth bypass, graceful degradation, no open redirect |
| Request specs | `spec/requests/episodes_spec.rb` | 16 | Episode show page, subscription scoping, audio player, processing state |
| Job specs | `spec/jobs/auto_process_episode_job_spec.rb` | 10 | Transcribe+summarize, skip processed, retry on rate limit, error isolation |
| Job specs | `spec/jobs/fetch_podcast_feed_job_spec.rb` | 8 | Auto-process trigger on new episodes, initial_fetch limit |
| Mailer specs | `spec/mailers/onboarding_digest_mailer_spec.rb` | 26 | All episodes included, grouped by show, summaries, tracking links, pixel, empty digest, edge cases |
| Job specs | `spec/jobs/onboarding_send_daily_digest_job_spec.rb` | 9 | Subscription-based episode check, skip empty, logging |
| Mailer specs | `spec/mailers/digest_mailer_spec.rb` | 8 | Basic sanity checks for rewritten mailer |
| Job specs | `spec/jobs/send_daily_digest_job_spec.rb` | 7 | Basic sanity checks for rewritten job |

### What Automated Tests Verify
- EmailEvent model validations, scopes, and idempotent trigger! method
- Tracking click redirect records triggered_at and redirects to correct destination
- Tracking open pixel returns 1x1 transparent GIF and records triggered_at
- Tracking endpoints skip authentication
- Invalid tracking tokens gracefully degrade (root redirect for clicks, GIF for pixel)
- No open redirect possible (allow_other_host: false)
- Episode show page displays summary sections, quotes, and audio player
- Episode show page blocks access for non-subscribers
- Episode show page shows "processing" state when summary unavailable
- Auto-processing job transcribes and summarizes new episodes
- Auto-processing skips already-processed episodes
- Auto-processing retries on rate limit errors with exponential backoff
- Auto-processing failures are isolated (don't block other episodes)
- FetchPodcastFeedJob triggers AutoProcessEpisodeJob for new episodes
- Digest includes ALL new episodes from subscribed podcasts
- Digest groups episodes by show, sorted alphabetically
- Digest includes summary previews (truncated first section)
- Digest uses tracking redirect URLs for all links
- Digest embeds tracking pixel in HTML
- Digest pre-creates EmailEvent records eagerly
- Empty digests (no new episodes) are not sent
- Old episodes (before last digest_sent_at) are excluded
- Unsubscribed podcast episodes are excluded
- Episodes with failed processing appear with title only

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/show-notes
bundle exec rake onboarding:seed
```

**Prerequisites:** Rails development environment running, database migrated (`rails db:migrate`).

**Note:** The magic link token expires in 15 minutes. Re-run the seed task to generate a fresh token.

### Scenarios Seeded

| Scenario | User | Data Created | Purpose |
|----------|------|--------------|---------|
| Primary QA user | `onboarding-qa@example.com` | 5 podcasts, 40 episodes (31 with summaries, 9 pending), tracking events from yesterday's digest | Full feature testing |
| Empty digest user | `onboarding-empty@example.com` | digest_enabled=true, digest_sent_at=just now | Verify empty digest is not sent |
| Disabled user | `onboarding-disabled@example.com` | digest_enabled=false | Verify disabled users don't receive digest |
| Large digest | (primary user) | 38 recent episodes across 4 podcasts | Verify 20+ episode digest renders correctly |
| Mixed processing states | (primary user) | 31 ready + 9 pending episodes | Verify "Summary processing..." for pending |
| Old episodes | (primary user — "Empty Show" podcast) | 2 episodes created 3+ days ago | Verify old episodes excluded from digest |
| Yesterday's tracking | (primary user) | 1 open event + click events for 5 episodes | Verify engagement report shows data |

### Post-Seed Verification
- [ ] Run `bundle exec rake onboarding:seed` and note the magic link URL from the output
- [ ] Open `/auth/verify?token=<TOKEN>` in a browser — should log in as `onboarding-qa@example.com`
- [ ] Confirm you see the inbox/library pages (existing Show Notes navigation)

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Digest Email — Content & Layout

#### QA-001: Digest email content and grouping
**Criteria:** DIG-001, DIG-002, DIG-005, DIG-006, DIG-007, DIG-009
**Steps:**
1. Run `bundle exec rake onboarding:seed` and log in via the magic link
2. Open a Rails console: `rails c`
3. Run `SendDailyDigestJob.perform_now`
4. Open Letter Opener in browser: `http://localhost:3000/letter_opener`
5. Open the most recent digest email

**Expected:**
- Subject line: "Your podcasts this morning — 38 new episodes" (or similar count)
- Header shows today's date and episode count
- Episodes are grouped under podcast name headers (Build Your SaaS, Acquired, Changelog, Software Engineering Daily)
- Each episode shows: podcast name, episode title, and 2-3 sentence summary preview
- Summary text is the most visually prominent element per episode (larger or bolder than title)
- Episodes are visually separated with clear boundaries (borders, spacing, or dividers)
- "Empty Show" episodes do NOT appear (they are older than digest_sent_at)

---

#### QA-002: Processing state in digest
**Criteria:** DIG-008
**Steps:**
1. After running `SendDailyDigestJob.perform_now`, open the digest in Letter Opener
2. Scroll through the episodes looking for ones without summaries

**Expected:**
- 9 episodes should show "Summary processing..." (or similar note) instead of a summary preview
- These episodes still have a title and podcast name
- "Read full summary" and "Listen" links are present even for processing episodes

---

#### QA-003: Plain-text version of digest
**Criteria:** DIG-002, DIG-009
**Steps:**
1. In Letter Opener, toggle to the plain-text version of the digest email

**Expected:**
- Podcast names appear as section headers
- Episode titles are listed under their podcast
- Summary previews are included in plain text
- Tracking URLs are present (as full URLs, not HTML links)

---

#### QA-004: Digest with single episode (singular form)
**Criteria:** DIG-007
**Steps:**
1. In Rails console, destroy all but one recent episode for the primary user's subscriptions, or create a new user with one subscription and one new episode
2. Run `SendDailyDigestJob.perform_now`
3. Check Letter Opener

**Expected:**
- Subject line uses singular: "1 new episode" (not "1 new episodes")

---

#### QA-005: Empty digest not sent
**Criteria:** DIG-013
**Steps:**
1. In Rails console, check the `onboarding-empty@example.com` user (digest_sent_at is very recent)
2. Run `SendDailyDigestJob.perform_now`
3. Check Letter Opener

**Expected:**
- No digest email is generated for the empty user
- The log message shows "skipped 1" (or more, counting the disabled user)

---

#### QA-006: Disabled user does not receive digest
**Criteria:** DIG-013
**Steps:**
1. Verify `onboarding-disabled@example.com` has `digest_enabled: false`
2. After running `SendDailyDigestJob.perform_now`, check Letter Opener

**Expected:**
- No digest email for the disabled user

---

#### QA-007: Digest send schedule
**Criteria:** DIG-012
**Steps:**
1. Check `config/recurring.yml` (or equivalent Solid Queue configuration) for the SendDailyDigestJob schedule

**Expected:**
- Job is scheduled to run at 12:00 UTC (7 AM Eastern)

---

### 4.2 Episode Detail Page

#### QA-008: Episode show page with summary
**Criteria:** DIG-003, DIG-004
**Steps:**
1. Log in as the primary QA user
2. Navigate to `/episodes/:id` where `:id` is an episode that has a summary (pick any from "Build Your SaaS" podcast in the seed data)

**Expected:**
- Page displays the episode title and podcast name
- Summary sections are shown with titles and content
- Notable quotes are displayed with timestamps
- HTML5 audio player is visible with the episode's audio URL
- Page is cleanly laid out and readable

---

#### QA-009: Episode show page — processing state
**Criteria:** DIG-008
**Steps:**
1. Navigate to `/episodes/:id` where `:id` is an episode WITHOUT a summary (one of the 9 pending episodes)

**Expected:**
- Page shows the episode title
- A "Summary processing..." message is displayed (or similar)
- Audio player is still available
- No error or blank page

---

#### QA-010: Episode show page — subscription scoping
**Criteria:** Security
**Steps:**
1. Log in as the primary QA user
2. In Rails console, find an episode from a podcast the user is NOT subscribed to (create one if needed)
3. Navigate to `/episodes/:id` for that episode

**Expected:**
- User is redirected to the root path
- An alert message is shown (e.g., "Episode not found")
- No data from the unauthorized episode is visible

---

### 4.3 Click Tracking

#### QA-011: "Read full summary" tracking link
**Criteria:** TRK-002, DIG-003
**Steps:**
1. Send a digest by running `SendDailyDigestJob.perform_now`
2. Open the digest in Letter Opener
3. Click a "Read full summary" link for any episode

**Expected:**
- URL in the email is a tracking redirect (starts with `/t/`)
- Browser redirects to the episode show page (`/episodes/:id`)
- In Rails console: `EmailEvent.clicks.triggered.where(link_type: "summary").last` shows a `triggered_at` timestamp

---

#### QA-012: "Listen" tracking link
**Criteria:** TRK-003, DIG-004
**Steps:**
1. In the same digest email, click a "Listen" link for any episode

**Expected:**
- URL in the email is a tracking redirect (starts with `/t/`)
- Browser redirects to the episode show page with `#audio` anchor (`/episodes/:id#audio`)
- The audio player should be scrolled into view (or near the top)
- In Rails console: `EmailEvent.clicks.triggered.where(link_type: "listen").last` shows a `triggered_at` timestamp

---

#### QA-013: Invalid tracking token
**Criteria:** TRK-006
**Steps:**
1. Navigate to `/t/invalid-nonexistent-token` directly in the browser

**Expected:**
- User is redirected to the root path (home page)
- No error page or 500 error

---

#### QA-014: Tracking pixel
**Criteria:** TRK-001
**Steps:**
1. View the HTML source of a digest email in Letter Opener
2. Find the `<img>` tag with `pixel.gif` in the src URL
3. Copy the pixel URL and open it directly in the browser

**Expected:**
- Browser shows a tiny transparent image (1x1 GIF)
- In Rails console: `EmailEvent.opens.triggered.last` shows a `triggered_at` timestamp

---

#### QA-015: Tracking link graceful degradation
**Criteria:** TRK-006
**Steps:**
1. Navigate to `/t/some-invalid-token/pixel.gif`

**Expected:**
- Returns a 1x1 transparent GIF regardless (no error)
- No EmailEvent is created or triggered

---

### 4.4 Auto-Processing Pipeline

#### QA-016: New episodes auto-processed on feed poll
**Criteria:** AUTO-001, AUTO-002
**Steps:**
1. In Rails console, create a new podcast and subscription for the QA user
2. Manually run `FetchPodcastFeedJob.perform_now(podcast.id)` (requires a real RSS feed URL, or mock by creating an episode directly and checking that AutoProcessEpisodeJob was enqueued)
3. Or: examine `app/jobs/fetch_podcast_feed_job.rb` line ~35 to confirm `AutoProcessEpisodeJob.perform_later(episode.id)` is called after new episode creation

**Expected:**
- When a new episode is discovered during feed polling, `AutoProcessEpisodeJob` is enqueued
- No user action is required — happens automatically

---

#### QA-017: Already-processed episodes not re-processed
**Criteria:** AUTO-004
**Steps:**
1. In Rails console, pick an episode that already has a transcript and summary
2. Run `AutoProcessEpisodeJob.perform_now(episode.id)`

**Expected:**
- Job completes immediately without calling AssemblyAI or Claude
- Transcript and summary remain unchanged

---

#### QA-018: Backfill rake task
**Criteria:** AUTO-007
**Steps:**
1. Run `bundle exec rake onboarding:backfill_episodes`

**Expected:**
- Output shows "Queued N episodes for [Podcast Title]" for each podcast
- Only unprocessed episodes (without summaries) are queued
- At most 10 episodes per podcast are queued

---

### 4.5 Onboarding Flow

#### QA-019: OPML import triggers auto-processing
**Criteria:** ONB-001
**Steps:**
1. Log in as the QA user
2. Go to `/import/new` and upload a valid OPML file (e.g., `spec/fixtures/files/valid_podcasts.opml`)
3. After import completes, check Solid Queue for pending jobs

**Expected:**
- After feeds are fetched, `AutoProcessEpisodeJob` jobs are enqueued for new episodes
- User doesn't need to take any action — processing starts automatically

---

#### QA-020: Completion page message
**Criteria:** ONB-002
**Steps:**
1. After a successful OPML import, observe the completion page

**Expected:**
- Page displays a message like "Your first digest arrives tomorrow morning"
- Message sets the user's expectation that the digest comes the next day

---

#### QA-021: Magic link login flow
**Criteria:** ONB-003
**Steps:**
1. Run `bundle exec rake onboarding:seed` to get a fresh magic link
2. Open the magic link URL in a browser: `/auth/verify?token=<TOKEN>`

**Expected:**
- User is logged in and redirected to the main page
- Session is established — subsequent page loads don't require re-authentication

---

### 4.6 Settings & Preferences

#### QA-022: Settings page digest description
**Criteria:** M6 — settings page copy
**Steps:**
1. Log in and navigate to `/settings`
2. Find the "Daily Digest Email" section

**Expected:**
- Description reads: "Receive a daily morning briefing with AI summaries of new episodes from your subscribed podcasts."
- The checkbox toggles `digest_enabled`
- If a digest has been sent, "Last digest sent: X ago" appears

---

#### QA-023: Disable digest via settings
**Criteria:** DIG-013
**Steps:**
1. Log in, go to `/settings`
2. Uncheck "Daily Digest Email" and save
3. Run `SendDailyDigestJob.perform_now` in console

**Expected:**
- No digest is sent for this user
- Re-enable the checkbox and save — next job run should send the digest

---

### 4.7 Engagement Reporting

#### QA-024: Engagement report rake task
**Criteria:** TRK-005
**Steps:**
1. First trigger some tracking events (send a digest, click some links, open the pixel)
2. Run `bundle exec rake onboarding:engagement_report`

**Expected:**
- Output shows "Opens by User & Date" with email and count
- Output shows "Clicks by Episode" with podcast name, episode title, link type, and count
- Output shows summary stats (total events, triggered, opens, clicks, unique users)

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | User has 0 new episodes | Use `onboarding-empty@example.com` user, run SendDailyDigestJob | No email sent for this user | DIG-013 |
| 2 | User has 50+ new episodes | Primary QA user has 38; add more episodes to exceed 50, run digest | All episodes included, email renders correctly (may be long) | DIG-001 |
| 3 | Episode processing failed | Find a pending episode in seed data | Appears in digest with title, "Summary processing..." note | DIG-008 |
| 4 | Multiple episodes from same show | "Acquired" has 15 episodes in seed data | Each episode listed individually under the "Acquired" header | DIG-009 |
| 5 | Tracking pixel blocked by email client | Open the pixel URL manually, then check event | Open event records triggered_at; clicks work independently of pixel | TRK-001 |
| 6 | User clicks tracking link but event already triggered | Click the same tracking link twice | Second click still redirects to destination; triggered_at doesn't change (idempotent) | TRK-006 |
| 7 | Very long episode summary | Create an episode with a very long first section (500+ chars) | Digest shows truncated ~200 char preview; episode page shows full summary | DIG-002 |
| 8 | Duplicate episodes from feed | Episode guid uniqueness constraint | Existing dedup prevents duplicates; auto-processing inherits this protection | AUTO-004 |
| 9 | OPML import at 6:55 AM | Import 5 min before scheduled digest | First digest next day — episodes won't be processed in time | ONB-001 |
| 10 | Episode with missing audio URL | Create episode without audio_url (requires bypassing validation) | Episode page still loads; audio player section hidden or shows fallback | DIG-004 |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| Polished HTML email design | Deferred | Clean and readable is sufficient for Phase 2 test |
| Per-user timezone settings | Deferred | 7 AM Eastern for all users |
| Per-user send-time settings | Deferred | Fixed schedule via Solid Queue |
| Unsubscribe link (CAN-SPAM compliance) | Deferred | Not needed for 2-3 invited test users; address when real customers exist |
| Cost optimization (caching, lightweight summaries) | Deferred | Absorbing $50-70 for the Phase 2 test |
| Per-show or per-tier customization | Deferred | All subscribed podcasts included equally |
| Episode recommendations / editorial curation | Deferred | No "Top Pick!" or AI recommendations |
| Full historical backfill | Deferred | Capped at ~10 most recent per podcast |
| A/B testing of digest formats | Deferred | Single format for the test |
| Mobile app integration | Deferred | Level 2 project (web only) |
| Pre-existing spec gap | Known issue | `opml_import_service_spec.rb:203` uses cumulative matcher — fails when run with full file, passes in isolation. Not related to this feature. |
| Email client rendering differences | Known limitation | Tracking pixel may not fire in clients that block images (Gmail proxy, Apple Privacy). Open rates are inherently unreliable; clicks are the reliable metric. |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| Existing digest email | **High** | DigestMailer was rewritten — old format is replaced. Verify all users who had digest_enabled still receive emails with the new format. |
| Existing digest_mailer_spec.rb | **Low** | Updated to test new contract. Run `bundle exec rspec spec/mailers/digest_mailer_spec.rb` to verify. |
| Existing send_daily_digest_job_spec.rb | **Low** | Updated to test new contract. Run `bundle exec rspec spec/jobs/send_daily_digest_job_spec.rb` to verify. |
| Summary model validation | **Med** | Changed quotes validation from `presence: true` to custom array validator. Verify summaries with empty quotes `[]` are now valid, and `nil` quotes are still rejected. |
| FetchPodcastFeedJob | **Med** | Added AutoProcessEpisodeJob trigger. Verify existing feed polling still works — new episodes are created AND auto-processed. |
| Library show page (`/library/:id`) | **Low** | Unchanged — coexists with new `/episodes/:id` route. Verify library page still works for episodes in user's library. |
| Inbox/archive workflows | **Low** | No changes. Verify inbox, library, archive, and trash still function. |
| Settings page | **Low** | Only the description text changed. Verify digest_enabled toggle still works. |
| Routes | **Low** | New routes added — verify no conflicts with existing routes. |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag | Single-user app with test users — rollback requires code revert |
| Code revert | Revert the `pipeline/onboarding` branch merge | `git revert` the merge commit, or deploy from the `main` branch directly |
| Migration | Reversible | `rails db:rollback` drops the `email_events` table. No existing tables were modified. |
| Data cleanup | Minimal | `email_events` table can be dropped. Episodes that were auto-processed (new transcripts/summaries) persist — this is fine, they add value to the library. |
| FetchPodcastFeedJob | Remove auto-processing trigger | If rolling back partially, remove the `AutoProcessEpisodeJob.perform_later` line from `FetchPodcastFeedJob`. New episodes will still be created but not auto-processed. |
| DigestMailer | Revert to old format | The old digest format can be restored from git history. Users will receive the old notification-style digest. |
| Existing data | No loss | Rolling back doesn't affect existing users, podcasts, episodes, or library entries. Only `email_events` are new data. |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-024)
- [ ] Edge cases tested (10 scenarios)
- [ ] Regression areas checked
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
